#!/home/y/bin/perl

	#
	# Do
	# egrep '^#|name.*=>' hcat.conf | egrep -v '^#!|egrep' | less
	# to get an outline of this test conf file
	#
	
  # Has a couple of Hive set directives:
  #   set hive.exec.dynamic.partition.mode=nonstrict;
  #   set hive.exec.dynamic.partition=true;


$cfg = {
        'driver' => 'Pig',
		'groups' => [
# This first group should be moved to deployer ?
		{
			'name' => 'Pig_Checkin',
			'tests' => [

				{
				 'num' => 1
                                ,'hcat_prep'=>q\drop table if exists pig_checkin_1;
create table pig_checkin_1 (name string, age int, gpa double) STORED AS TEXTFILE;\
				,'pig' => q\a = load 'studenttab10k' using org.apache.hcatalog.pig.HCatLoader();
store a into 'pig_checkin_1' using org.apache.hcatalog.pig.HCatStorer();\,
                                ,'result_table' => 'pig_checkin_1'
                                ,'sql' => q\select * from studenttab10k;\
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
				}, 
				{
				 'num' => 2
                                ,'pig' => q\a = load 'studenttab10k' using org.apache.hcatalog.pig.HCatLoader();
b = load 'votertab10k' using org.apache.hcatalog.pig.HCatLoader();
c = join a by name, b by name;
store c into ':OUTPATH:';\,
				,'sql'   => [ 'select s.name, s.age, gpa, v.name, v.age, registration, contributions from studenttab10k s join votertab10k v on (s.name = v.name);']
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
				}, 
				{
				 'num' => 3
                                ,'pig' => q\a = load 'studenttab10k' using org.apache.hcatalog.pig.HCatLoader();
b = load ':INPATH:/votertab10k' as (name:chararray, age:int, registration:chararray, contributions:float);
c = join a by name, b by name;
store c into ':OUTPATH:';\
				,'sql' => q\select s.name, s.age, gpa, v.name, v.age, registration, contributions from studenttab10k s join votertab10k v on (s.name = v.name);\
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
				}, 
				{
				 'num' => 4
                                ,'hcat_prep'=>q\drop table if exists pig_checkin_4_1;
drop table if exists pig_checkin_4_2;
create table pig_checkin_4_1 (name string, age int, gpa double) STORED AS TEXTFILE;
create table pig_checkin_4_2 (name string, age int, gpa double) STORED AS TEXTFILE;\
                                ,'pig' => q\a = load 'studenttab10k' using org.apache.hcatalog.pig.HCatLoader();
split a into b if age <=40, c if age > 40;
store b into 'pig_checkin_4_1' using org.apache.hcatalog.pig.HCatStorer();
store c into 'pig_checkin_4_2' using org.apache.hcatalog.pig.HCatStorer();\,
                                ,'result_table' => ['pig_checkin_4_1','pig_checkin_4_2']
				,'sql'   => [ 'select * from studenttab10k where age<=40;', 'select * from studenttab10k where age>40;']
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
				}, 
				{
				 'num' => 5
                                ,'hcat_prep'=>q\drop table if exists pig_checkin_5;
create table pig_checkin_5 (name string, age int, gpa double) STORED AS TEXTFILE;\
                                ,'pig' => q\a = load 'studenttab10k' using org.apache.hcatalog.pig.HCatLoader();
split a into b if age <=40, c if age > 40;
store b into 'pig_checkin_5' using org.apache.hcatalog.pig.HCatStorer();
store c into ':OUTPATH:';\,
                                ,'result_table' => ['pig_checkin_5','?']
				,'sql'   => [ 'select * from studenttab10k where age<=40;', 'select * from studenttab10k where age>40;']
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
				}, 

			],
 		}, # end g
                {
                        'name' => 'Pig_Read',
                        'tests' => [

                                {
                                 'ignore' => 1, # Need to checkin HCATALOG-168.
                                 'num' => 1
                                ,'pig' => q\a = load 'all100k' using org.apache.hcatalog.pig.HCatLoader();
store a into ':OUTPATH:';\,
				,'sql' => q\select * from all100k;\
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
                                },
                                {
                                 'num' => 2
                                ,'pig' => q\a = load 'all100kjson' using org.apache.hcatalog.pig.HCatLoader();
b = foreach a generate s, i, d;
store b into ':OUTPATH:';\,
				,'sql' => q\select s, i, d from all100kjson;\
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
                                },
                                {
                                 'num' => 3
                                ,'pig' => q\a = load 'all100krc' using org.apache.hcatalog.pig.HCatLoader();
b = foreach a generate name, age;
store b into ':OUTPATH:';\,
				,'sql' => q\select name, age from all100krc;\
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
                                }
                        ],
                }, # end g
                {
                        'name' => 'Pig_Write',
                        'tests' => [
                                {
                                 'ignore' => 1, # Need to checkin HCATALOG-168.
                                 'num' => 1
                                ,'hcat_prep'=>q\drop table if exists pig_write_1;
create table pig_write_1(t tinyint,si smallint,i int,b bigint,bool boolean,f float,d double,s string) stored as rcfile;\
                                ,'pig' => q\a = load ':INPATH:/all100k' using PigStorage(':') as (t:int,si:int,i:int,b:int,bo:boolean,f:float,d:double,s:chararray);
store a into 'pig_write_1' using org.apache.hcatalog.pig.HCatStorer();\,
                                ,'result_table' => 'pig_write_1'
				,'sql' => q\select * from all100k;\
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
                                },
                                {
                                 'num' => 2
                                ,'hcat_prep'=>q\drop table if exists pig_write_2;
create table pig_write_2(
            s string,
            i int,
            d double,
            m map<string, string>,
            bb array<struct<a: int, b: string>>)
            STORED AS INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat' OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat'
            INPUTDRIVER 'org.apache.hcatalog.pig.drivers.LoadFuncBasedInputDriver' OUTPUTDRIVER 'org.apache.hcatalog.pig.drivers.StoreFuncBasedOutputDriver'
            TBLPROPERTIES ('hcat.pig.loader'='org.apache.pig.builtin.JsonLoader', 'hcat.pig.storer'='org.apache.pig.builtin.JsonStorage', 'hcat.pig.loader.args'=
's:chararray, i:int, d:double, m:map[chararray], bb:{t:(a:int, b:chararray)}', 'hcat.pig.args.delimiter'='	');
\
                                ,'pig' => q\a = load 'all100kjson' using org.apache.hcatalog.pig.HCatLoader();
b = foreach a generate s, i, d;
store b into 'pig_write_2' using org.apache.hcatalog.pig.HCatStorer();\,
				,'sql' => q\select IFNULL(s, ""), IFNULL(i, ""), IFNULL(d, "") from all100kjson;\
                                ,'result_table' => 'pig_write_2'
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
                                },
                                {
                                 'num' => 3
                                ,'hcat_prep'=>q\drop table if exists pig_write_3;
create table pig_write_3(
            name string,
            age int,
            gpa double)
stored as rcfile
TBLPROPERTIES (
    'hcat.isd'='org.apache.hcatalog.rcfile.RCFileInputDriver',
    'hcat.osd'='org.apache.hcatalog.rcfile.RCFileOutputDriver'
);
\
                                ,'pig' => q\a = load 'all100krc' using org.apache.hcatalog.pig.HCatLoader();
b = foreach a generate name, age;
store b into 'pig_write_3' using org.apache.hcatalog.pig.HCatStorer();\,
				,'sql' => q\select name, age from all100krc;\
                                ,'result_table' => 'pig_write_3'
                                ,'floatpostprocess' => 1
                                ,'delimiter' => '	'
                                }
                        ],
                }, # end g

         ]
}
