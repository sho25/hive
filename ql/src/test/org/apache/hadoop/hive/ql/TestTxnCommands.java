begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/*  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileOutputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Arrays
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|LinkedList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Timer
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|TimerTask
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileStatus
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|conf
operator|.
name|HiveConf
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|HiveMetaStoreClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|IMetaStoreClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|MetastoreTaskThread
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|GetOpenTxnsInfoResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|LockState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|LockType
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|ShowCompactRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|ShowCompactResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|ShowLocksRequest
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|ShowLocksResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|TxnInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|TxnState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|conf
operator|.
name|MetastoreConf
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|txn
operator|.
name|AcidHouseKeeperService
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|txn
operator|.
name|TxnDbUtil
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|txn
operator|.
name|TxnStore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|txn
operator|.
name|TxnUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|AcidOutputFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|AcidUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|BucketCodec
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|lockmgr
operator|.
name|TestDbTxnManager2
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|metadata
operator|.
name|HiveException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|processors
operator|.
name|CommandProcessorResponse
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Assert
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Ignore
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * The LockManager is not ready, but for no-concurrency straight-line path we can  * test AC=true, and AC=false with commit/rollback/exception and test resulting data.  *  * Can also test, calling commit in AC=true mode, etc, toggling AC...  *  * Tests here are for multi-statement transactions (WIP) and others  * Mostly uses bucketed tables  */
end_comment

begin_class
specifier|public
class|class
name|TestTxnCommands
extends|extends
name|TxnCommandsBaseForTests
block|{
specifier|static
specifier|final
specifier|private
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|TestTxnCommands
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|TEST_DATA_DIR
init|=
operator|new
name|File
argument_list|(
name|System
operator|.
name|getProperty
argument_list|(
literal|"java.io.tmpdir"
argument_list|)
operator|+
name|File
operator|.
name|separator
operator|+
name|TestTxnCommands
operator|.
name|class
operator|.
name|getCanonicalName
argument_list|()
operator|+
literal|"-"
operator|+
name|System
operator|.
name|currentTimeMillis
argument_list|()
argument_list|)
operator|.
name|getPath
argument_list|()
operator|.
name|replaceAll
argument_list|(
literal|"\\\\"
argument_list|,
literal|"/"
argument_list|)
decl_stmt|;
annotation|@
name|Override
name|String
name|getTestDataDir
parameter_list|()
block|{
return|return
name|TEST_DATA_DIR
return|;
block|}
comment|/**    * tests that a failing Insert Overwrite (which creates a new base_x) is properly marked as    * aborted.    */
annotation|@
name|Test
specifier|public
name|void
name|testInsertOverwrite
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"insert overwrite table "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" select a,b from "
operator|+
name|Table
operator|.
name|NONACIDORCTBL2
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table "
operator|+
name|Table
operator|.
name|NONACIDORCTBL2
operator|+
literal|"3(a int, b int) clustered by (a) into "
operator|+
name|BUCKET_COUNT
operator|+
literal|" buckets stored as orc TBLPROPERTIES ('transactional'='false')"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" values(1,2)"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where b = 2"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|1
argument_list|,
name|rs
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"1"
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|hiveConf
operator|.
name|setBoolVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVETESTMODEROLLBACKTXN
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" values(3,2)"
argument_list|)
expr_stmt|;
name|hiveConf
operator|.
name|setBoolVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVETESTMODEROLLBACKTXN
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" values(5,6)"
argument_list|)
expr_stmt|;
name|rs
operator|=
name|runStatementOnDriver
argument_list|(
literal|"select a from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|rs
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"1"
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"5"
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Ignore
argument_list|(
literal|"not needed but useful for testing"
argument_list|)
annotation|@
name|Test
specifier|public
name|void
name|testNonAcidInsert
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"(a,b) values(1,2)"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
argument_list|)
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"(a,b) values(2,3)"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
argument_list|)
decl_stmt|;
block|}
comment|/**    * Useful for debugging.  Dumps ORC file in JSON to CWD.    */
specifier|private
name|void
name|dumpBucketData
parameter_list|(
name|Table
name|table
parameter_list|,
name|long
name|writeId
parameter_list|,
name|int
name|stmtId
parameter_list|,
name|int
name|bucketNum
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
literal|true
condition|)
block|{
return|return;
block|}
name|Path
name|bucket
init|=
name|AcidUtils
operator|.
name|createBucketFile
argument_list|(
operator|new
name|Path
argument_list|(
operator|new
name|Path
argument_list|(
name|getWarehouseDir
argument_list|()
argument_list|,
name|table
operator|.
name|toString
argument_list|()
operator|.
name|toLowerCase
argument_list|()
argument_list|)
argument_list|,
name|AcidUtils
operator|.
name|deltaSubdir
argument_list|(
name|writeId
argument_list|,
name|writeId
argument_list|,
name|stmtId
argument_list|)
argument_list|)
argument_list|,
name|bucketNum
argument_list|)
decl_stmt|;
name|FileOutputStream
name|delta
init|=
operator|new
name|FileOutputStream
argument_list|(
name|testName
operator|.
name|getMethodName
argument_list|()
operator|+
literal|"_"
operator|+
name|bucket
operator|.
name|getParent
argument_list|()
operator|.
name|getName
argument_list|()
operator|+
literal|"_"
operator|+
name|bucket
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
comment|//    try {
comment|//      FileDump.printJsonData(conf, bucket.toString(), delta);
comment|//    }
comment|//    catch(FileNotFoundException ex) {
empty_stmt|;
comment|//this happens if you change BUCKET_COUNT
comment|//    }
name|delta
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
comment|/**    * Dump all data in the table by bucket in JSON format    */
specifier|private
name|void
name|dumpTableData
parameter_list|(
name|Table
name|table
parameter_list|,
name|long
name|writeId
parameter_list|,
name|int
name|stmtId
parameter_list|)
throws|throws
name|Exception
block|{
for|for
control|(
name|int
name|bucketNum
init|=
literal|0
init|;
name|bucketNum
operator|<
name|BUCKET_COUNT
condition|;
name|bucketNum
operator|++
control|)
block|{
name|dumpBucketData
argument_list|(
name|table
argument_list|,
name|writeId
argument_list|,
name|stmtId
argument_list|,
name|bucketNum
argument_list|)
expr_stmt|;
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|testSimpleAcidInsert
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
comment|//List<String> rs = runStatementOnDriver("select a,b from " + Table.ACIDTBL + " order by a,b");
comment|//Assert.assertEquals("Data didn't match in autocommit=true (rs)", stringifyValues(rows1), rs);
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|rows2
init|=
block|{
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|allData
init|=
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
decl_stmt|;
name|allData
operator|.
name|addAll
argument_list|(
name|stringifyValues
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Data didn't match inside tx (rs0)"
argument_list|,
name|allData
argument_list|,
name|rs0
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"COMMIT WORK"
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
expr_stmt|;
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"COMMIT"
argument_list|)
decl_stmt|;
comment|//txn started implicitly by previous statement
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Error didn't match: "
operator|+
name|cpr
argument_list|,
name|ErrorMsg
operator|.
name|OP_NOT_ALLOWED_WITHOUT_TXN
operator|.
name|getErrorCode
argument_list|()
argument_list|,
name|cpr
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Data didn't match inside tx (rs0)"
argument_list|,
name|allData
argument_list|,
name|rs1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMmExim
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|tableName
init|=
literal|"mm_table"
decl_stmt|,
name|importName
init|=
name|tableName
operator|+
literal|"_import"
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|tableName
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"create table %s (a int, b int) stored as orc "
operator|+
literal|"TBLPROPERTIES ('transactional'='true', 'transactional_properties'='insert_only')"
argument_list|,
name|tableName
argument_list|)
argument_list|)
expr_stmt|;
comment|// Regular insert: export some MM deltas, then import into a new table.
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"insert into %s (a,b) %s"
argument_list|,
name|tableName
argument_list|,
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"insert into %s (a,b) %s"
argument_list|,
name|tableName
argument_list|,
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|IMetaStoreClient
name|msClient
init|=
operator|new
name|HiveMetaStoreClient
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|Table
name|table
init|=
name|msClient
operator|.
name|getTable
argument_list|(
literal|"default"
argument_list|,
name|tableName
argument_list|)
decl_stmt|;
name|FileSystem
name|fs
init|=
name|FileSystem
operator|.
name|get
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|Path
name|exportPath
init|=
operator|new
name|Path
argument_list|(
name|table
operator|.
name|getSd
argument_list|()
operator|.
name|getLocation
argument_list|()
operator|+
literal|"_export"
argument_list|)
decl_stmt|;
name|fs
operator|.
name|delete
argument_list|(
name|exportPath
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"export table %s to '%s'"
argument_list|,
name|tableName
argument_list|,
name|exportPath
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|paths
init|=
name|listPathsRecursive
argument_list|(
name|fs
argument_list|,
name|exportPath
argument_list|)
decl_stmt|;
name|verifyMmExportPaths
argument_list|(
name|paths
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"import table %s from '%s'"
argument_list|,
name|importName
argument_list|,
name|exportPath
argument_list|)
argument_list|)
expr_stmt|;
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|Table
name|imported
init|=
name|msClient
operator|.
name|getTable
argument_list|(
literal|"default"
argument_list|,
name|importName
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|imported
operator|.
name|toString
argument_list|()
argument_list|,
literal|"insert_only"
argument_list|,
name|imported
operator|.
name|getParameters
argument_list|()
operator|.
name|get
argument_list|(
literal|"transactional_properties"
argument_list|)
argument_list|)
expr_stmt|;
name|Path
name|importPath
init|=
operator|new
name|Path
argument_list|(
name|imported
operator|.
name|getSd
argument_list|()
operator|.
name|getLocation
argument_list|()
argument_list|)
decl_stmt|;
name|FileStatus
index|[]
name|stat
init|=
name|fs
operator|.
name|listStatus
argument_list|(
name|importPath
argument_list|,
name|AcidUtils
operator|.
name|hiddenFileFilter
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|Arrays
operator|.
name|toString
argument_list|(
name|stat
argument_list|)
argument_list|,
literal|1
argument_list|,
name|stat
operator|.
name|length
argument_list|)
expr_stmt|;
name|assertIsDelta
argument_list|(
name|stat
index|[
literal|0
index|]
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|allData
init|=
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
decl_stmt|;
name|allData
operator|.
name|addAll
argument_list|(
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
name|allData
operator|.
name|sort
argument_list|(
literal|null
argument_list|)
expr_stmt|;
name|Collections
operator|.
name|sort
argument_list|(
name|allData
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"select a,b from %s order by a,b"
argument_list|,
name|importName
argument_list|)
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"After import: "
operator|+
name|rs
argument_list|,
name|allData
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|importName
argument_list|)
expr_stmt|;
comment|// Do insert overwrite to create some invalid deltas, and import into a non-MM table.
name|int
index|[]
index|[]
name|rows2
init|=
block|{
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"insert overwrite table %s %s"
argument_list|,
name|tableName
argument_list|,
name|makeValuesClause
argument_list|(
name|rows2
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|fs
operator|.
name|delete
argument_list|(
name|exportPath
argument_list|,
literal|true
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"export table %s to '%s'"
argument_list|,
name|tableName
argument_list|,
name|exportPath
argument_list|)
argument_list|)
expr_stmt|;
name|paths
operator|=
name|listPathsRecursive
argument_list|(
name|fs
argument_list|,
name|exportPath
argument_list|)
expr_stmt|;
name|verifyMmExportPaths
argument_list|(
name|paths
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"create table %s (a int, b int) stored as orc "
operator|+
literal|"TBLPROPERTIES ('transactional'='false')"
argument_list|,
name|importName
argument_list|)
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"import table %s from '%s'"
argument_list|,
name|importName
argument_list|,
name|exportPath
argument_list|)
argument_list|)
expr_stmt|;
name|imported
operator|=
name|msClient
operator|.
name|getTable
argument_list|(
literal|"default"
argument_list|,
name|importName
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertNull
argument_list|(
name|imported
operator|.
name|toString
argument_list|()
argument_list|,
name|imported
operator|.
name|getParameters
argument_list|()
operator|.
name|get
argument_list|(
literal|"transactional"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertNull
argument_list|(
name|imported
operator|.
name|toString
argument_list|()
argument_list|,
name|imported
operator|.
name|getParameters
argument_list|()
operator|.
name|get
argument_list|(
literal|"transactional_properties"
argument_list|)
argument_list|)
expr_stmt|;
name|importPath
operator|=
operator|new
name|Path
argument_list|(
name|imported
operator|.
name|getSd
argument_list|()
operator|.
name|getLocation
argument_list|()
argument_list|)
expr_stmt|;
name|stat
operator|=
name|fs
operator|.
name|listStatus
argument_list|(
name|importPath
argument_list|,
name|AcidUtils
operator|.
name|hiddenFileFilter
argument_list|)
expr_stmt|;
name|allData
operator|=
name|stringifyValues
argument_list|(
name|rows2
argument_list|)
expr_stmt|;
name|Collections
operator|.
name|sort
argument_list|(
name|allData
argument_list|)
expr_stmt|;
name|rs
operator|=
name|runStatementOnDriver
argument_list|(
name|String
operator|.
name|format
argument_list|(
literal|"select a,b from %s order by a,b"
argument_list|,
name|importName
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"After import: "
operator|+
name|rs
argument_list|,
name|allData
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|importName
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|tableName
argument_list|)
expr_stmt|;
name|msClient
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
specifier|private
name|void
name|assertIsDelta
parameter_list|(
name|FileStatus
name|stat
parameter_list|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
name|stat
operator|.
name|toString
argument_list|()
argument_list|,
name|stat
operator|.
name|getPath
argument_list|()
operator|.
name|getName
argument_list|()
operator|.
name|startsWith
argument_list|(
name|AcidUtils
operator|.
name|DELTA_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|verifyMmExportPaths
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|paths
parameter_list|,
name|int
name|deltasOrBases
parameter_list|)
block|{
comment|// 1 file, 1 dir for each, for now. Plus export "data" dir.
comment|// This could be changed to a flat file list later.
name|Assert
operator|.
name|assertEquals
argument_list|(
name|paths
operator|.
name|toString
argument_list|()
argument_list|,
literal|2
operator|*
name|deltasOrBases
operator|+
literal|1
argument_list|,
name|paths
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|// No confusing directories in export.
for|for
control|(
name|String
name|path
range|:
name|paths
control|)
block|{
name|Assert
operator|.
name|assertFalse
argument_list|(
name|path
argument_list|,
name|path
operator|.
name|startsWith
argument_list|(
name|AcidUtils
operator|.
name|DELTA_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertFalse
argument_list|(
name|path
argument_list|,
name|path
operator|.
name|startsWith
argument_list|(
name|AcidUtils
operator|.
name|BASE_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
specifier|private
name|List
argument_list|<
name|String
argument_list|>
name|listPathsRecursive
parameter_list|(
name|FileSystem
name|fs
parameter_list|,
name|Path
name|path
parameter_list|)
throws|throws
name|IOException
block|{
name|List
argument_list|<
name|String
argument_list|>
name|paths
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|LinkedList
argument_list|<
name|Path
argument_list|>
name|queue
init|=
operator|new
name|LinkedList
argument_list|<>
argument_list|()
decl_stmt|;
name|queue
operator|.
name|add
argument_list|(
name|path
argument_list|)
expr_stmt|;
while|while
condition|(
operator|!
name|queue
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|Path
name|next
init|=
name|queue
operator|.
name|pollFirst
argument_list|()
decl_stmt|;
name|FileStatus
index|[]
name|stats
init|=
name|fs
operator|.
name|listStatus
argument_list|(
name|next
argument_list|,
name|AcidUtils
operator|.
name|hiddenFileFilter
argument_list|)
decl_stmt|;
for|for
control|(
name|FileStatus
name|stat
range|:
name|stats
control|)
block|{
name|Path
name|child
init|=
name|stat
operator|.
name|getPath
argument_list|()
decl_stmt|;
name|paths
operator|.
name|add
argument_list|(
name|child
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
if|if
condition|(
name|stat
operator|.
name|isDirectory
argument_list|()
condition|)
block|{
name|queue
operator|.
name|add
argument_list|(
name|child
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|paths
return|;
block|}
comment|/**    * add tests for all transitions - AC=t, AC=t, AC=f, commit (for example)    * @throws Exception    */
annotation|@
name|Test
specifier|public
name|void
name|testErrors
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
name|CommandProcessorResponse
name|cpr2
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"create table foo(x int, y int)"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Expected DDL to fail in an open txn"
argument_list|,
name|ErrorMsg
operator|.
name|OP_NOT_ALLOWED_IN_TXN
operator|.
name|getErrorCode
argument_list|()
argument_list|,
name|cpr2
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
name|CommandProcessorResponse
name|cpr3
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"update "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" set a = 1 where b != 1"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Expected update of bucket column to fail"
argument_list|,
literal|"FAILED: SemanticException [Error 10302]: Updating values of bucketing columns is not supported.  Column a."
argument_list|,
name|cpr3
operator|.
name|getErrorMessage
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Expected update of bucket column to fail"
argument_list|,
name|ErrorMsg
operator|.
name|UPDATE_CANNOT_UPDATE_BUCKET_VALUE
operator|.
name|getErrorCode
argument_list|()
argument_list|,
name|cpr3
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
name|cpr3
operator|=
name|runStatementOnDriverNegative
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
comment|//not allowed in w/o tx
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Error didn't match: "
operator|+
name|cpr3
argument_list|,
name|ErrorMsg
operator|.
name|OP_NOT_ALLOWED_WITHOUT_TXN
operator|.
name|getErrorCode
argument_list|()
argument_list|,
name|cpr3
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
name|cpr3
operator|=
name|runStatementOnDriverNegative
argument_list|(
literal|"rollback"
argument_list|)
expr_stmt|;
comment|//not allowed in w/o tx
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Error didn't match: "
operator|+
name|cpr3
argument_list|,
name|ErrorMsg
operator|.
name|OP_NOT_ALLOWED_WITHOUT_TXN
operator|.
name|getErrorCode
argument_list|()
argument_list|,
name|cpr3
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
name|cpr3
operator|=
name|runStatementOnDriverNegative
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
comment|//not allowed in a tx
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Expected start transaction to fail"
argument_list|,
name|ErrorMsg
operator|.
name|OP_NOT_ALLOWED_IN_TXN
operator|.
name|getErrorCode
argument_list|()
argument_list|,
name|cpr3
operator|.
name|getErrorCode
argument_list|()
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
comment|//ok since previously opened txn was killed
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) values(1,2)"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Can't see my own write"
argument_list|,
literal|1
argument_list|,
name|rs0
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit work"
argument_list|)
expr_stmt|;
name|rs0
operator|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Can't see my own write"
argument_list|,
literal|1
argument_list|,
name|rs0
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testReadMyOwnInsert
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select * from "
operator|+
name|Table
operator|.
name|ACIDTBL
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Expected empty "
operator|+
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|0
argument_list|,
name|rs
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) values(1,2)"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Can't see my own write"
argument_list|,
literal|1
argument_list|,
name|rs0
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"rollback work"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Can't see write after commit"
argument_list|,
literal|1
argument_list|,
name|rs1
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testImplicitRollback
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) values(1,2)"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Can't see my own write"
argument_list|,
literal|1
argument_list|,
name|rs0
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
comment|//next command should produce an error
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"select * from no_such_table"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Txn didn't fail?"
argument_list|,
literal|"FAILED: SemanticException [Error 10001]: Line 1:14 Table not found 'no_such_table'"
argument_list|,
name|cpr
operator|.
name|getErrorMessage
argument_list|()
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Didn't rollback as expected"
argument_list|,
literal|0
argument_list|,
name|rs1
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testExplicitRollback
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) values(1,2)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"ROLLBACK"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Rollback didn't rollback"
argument_list|,
literal|0
argument_list|,
name|rs
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMultipleInserts
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|rows2
init|=
block|{
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|allData
init|=
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
decl_stmt|;
name|allData
operator|.
name|addAll
argument_list|(
name|stringifyValues
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match before commit rs"
argument_list|,
name|allData
argument_list|,
name|rs
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|1
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match after commit rs1"
argument_list|,
name|allData
argument_list|,
name|rs1
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDelete
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match rs0"
argument_list|,
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
argument_list|,
name|rs0
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where b = 4"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|updatedData2
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs3
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after delete"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData2
argument_list|)
argument_list|,
name|rs3
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs4
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after commit"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData2
argument_list|)
argument_list|,
name|rs4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testUpdateOfInserts
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match rs0"
argument_list|,
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
argument_list|,
name|rs0
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|rows2
init|=
block|{
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|allData
init|=
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
decl_stmt|;
name|allData
operator|.
name|addAll
argument_list|(
name|stringifyValues
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match rs1"
argument_list|,
name|allData
argument_list|,
name|rs1
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"update "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" set b = 1 where b != 1"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|updatedData
init|=
block|{
block|{
literal|1
block|,
literal|1
block|}
block|,
block|{
literal|3
block|,
literal|1
block|}
block|,
block|{
literal|5
block|,
literal|1
block|}
block|,
block|{
literal|7
block|,
literal|1
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs2
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after update"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData
argument_list|)
argument_list|,
name|rs2
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs4
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after commit"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData
argument_list|)
argument_list|,
name|rs4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testUpdateDeleteOfInserts
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match rs0"
argument_list|,
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
argument_list|,
name|rs0
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|rows2
init|=
block|{
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs1
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|allData
init|=
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
decl_stmt|;
name|allData
operator|.
name|addAll
argument_list|(
name|stringifyValues
argument_list|(
name|rows2
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match rs1"
argument_list|,
name|allData
argument_list|,
name|rs1
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"update "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" set b = 1 where b != 1"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|updatedData
init|=
block|{
block|{
literal|1
block|,
literal|1
block|}
block|,
block|{
literal|3
block|,
literal|1
block|}
block|,
block|{
literal|5
block|,
literal|1
block|}
block|,
block|{
literal|7
block|,
literal|1
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs2
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after update"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData
argument_list|)
argument_list|,
name|rs2
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where a = 7 and b = 1"
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|updatedData2
init|=
block|{
block|{
literal|1
block|,
literal|1
block|}
block|,
block|{
literal|3
block|,
literal|1
block|}
block|,
block|{
literal|5
block|,
literal|1
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs3
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after delete"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData2
argument_list|)
argument_list|,
name|rs3
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs4
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after commit"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData2
argument_list|)
argument_list|,
name|rs4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMultipleDelete
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|rows1
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|rows1
argument_list|)
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs0
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Content didn't match rs0"
argument_list|,
name|stringifyValues
argument_list|(
name|rows1
argument_list|)
argument_list|,
name|rs0
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"START TRANSACTION"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where b = 8"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|updatedData2
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|4
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs2
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after delete"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData2
argument_list|)
argument_list|,
name|rs2
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where b = 4"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|updatedData3
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs3
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after delete2"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData3
argument_list|)
argument_list|,
name|rs3
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"update "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" set b=3"
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|1
argument_list|,
literal|0
argument_list|)
expr_stmt|;
comment|//nothing actually hashes to bucket0, so update/delete deltas don't have it
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|0
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|dumpTableData
argument_list|(
name|Table
operator|.
name|ACIDTBL
argument_list|,
literal|2
argument_list|,
literal|4
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs5
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|updatedData4
init|=
block|{
block|{
literal|1
block|,
literal|3
block|}
block|,
block|{
literal|5
block|,
literal|3
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after delete"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData4
argument_list|)
argument_list|,
name|rs5
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"commit"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs4
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Wrong data after commit"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData4
argument_list|)
argument_list|,
name|rs4
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testDeleteIn
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where a IN (SELECT A.a from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"  A)"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|tableData
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|,
block|{
literal|3
block|,
literal|2
block|}
block|,
block|{
literal|5
block|,
literal|2
block|}
block|,
block|{
literal|1
block|,
literal|3
block|}
block|,
block|{
literal|3
block|,
literal|3
block|}
block|,
block|{
literal|5
block|,
literal|3
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) "
operator|+
name|makeValuesClause
argument_list|(
name|tableData
argument_list|)
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL2
operator|+
literal|"(a,b,c) values(1,7,17),(3,7,17)"
argument_list|)
expr_stmt|;
comment|//    runStatementOnDriver("select b from " + Table.ACIDTBL + " where a in (select b from " + Table.NONACIDORCTBL + ")");
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where a in(select a from "
operator|+
name|Table
operator|.
name|ACIDTBL2
operator|+
literal|")"
argument_list|)
expr_stmt|;
comment|//    runStatementOnDriver("delete from " + Table.ACIDTBL + " where a in(select a from " + Table.NONACIDORCTBL + ")");
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|"(a,b) select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL2
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|updatedData
init|=
block|{
block|{
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|3
block|,
literal|7
block|}
block|,
block|{
literal|5
block|,
literal|2
block|}
block|,
block|{
literal|5
block|,
literal|3
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Bulk update failed"
argument_list|,
name|stringifyValues
argument_list|(
name|updatedData
argument_list|)
argument_list|,
name|rs
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testTimeOutReaper
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where a = 5"
argument_list|)
expr_stmt|;
comment|//make sure currently running txn is considered aborted by housekeeper
name|hiveConf
operator|.
name|setTimeVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_TXN_TIMEOUT
argument_list|,
literal|2
argument_list|,
name|TimeUnit
operator|.
name|MILLISECONDS
argument_list|)
expr_stmt|;
name|MetastoreTaskThread
name|houseKeeperService
init|=
operator|new
name|AcidHouseKeeperService
argument_list|()
decl_stmt|;
name|houseKeeperService
operator|.
name|setConf
argument_list|(
name|hiveConf
argument_list|)
expr_stmt|;
comment|//this will abort the txn
name|houseKeeperService
operator|.
name|run
argument_list|()
expr_stmt|;
comment|//this should fail because txn aborted due to timeout
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"delete from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where a = 5"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"Actual: "
operator|+
name|cpr
operator|.
name|getErrorMessage
argument_list|()
argument_list|,
name|cpr
operator|.
name|getErrorMessage
argument_list|()
operator|.
name|contains
argument_list|(
literal|"Transaction manager has aborted the transaction txnid:1"
argument_list|)
argument_list|)
expr_stmt|;
comment|//now test that we don't timeout locks we should not
comment|//heartbeater should be running in the background every 1/2 second
name|hiveConf
operator|.
name|setTimeVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_TXN_TIMEOUT
argument_list|,
literal|1
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
expr_stmt|;
comment|// Have to reset the conf when we change it so that the change takes affect
name|houseKeeperService
operator|.
name|setConf
argument_list|(
name|hiveConf
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"start transaction"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"select count(*) from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" where a = 17"
argument_list|)
expr_stmt|;
name|pause
argument_list|(
literal|750
argument_list|)
expr_stmt|;
name|TxnStore
name|txnHandler
init|=
name|TxnUtils
operator|.
name|getTxnStore
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
comment|//since there is txn open, we are heartbeating the txn not individual locks
name|GetOpenTxnsInfoResponse
name|txnsInfoResponse
init|=
name|txnHandler
operator|.
name|getOpenTxnsInfo
argument_list|()
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|2
argument_list|,
name|txnsInfoResponse
operator|.
name|getOpen_txns
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TxnInfo
name|txnInfo
init|=
literal|null
decl_stmt|;
for|for
control|(
name|TxnInfo
name|ti
range|:
name|txnsInfoResponse
operator|.
name|getOpen_txns
argument_list|()
control|)
block|{
if|if
condition|(
name|ti
operator|.
name|getState
argument_list|()
operator|==
name|TxnState
operator|.
name|OPEN
condition|)
block|{
name|txnInfo
operator|=
name|ti
expr_stmt|;
break|break;
block|}
block|}
name|Assert
operator|.
name|assertNotNull
argument_list|(
name|txnInfo
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|14
argument_list|,
name|txnInfo
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|TxnState
operator|.
name|OPEN
argument_list|,
name|txnInfo
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|s
init|=
name|TxnDbUtil
operator|.
name|queryToString
argument_list|(
name|hiveConf
argument_list|,
literal|"select TXN_STARTED, TXN_LAST_HEARTBEAT from TXNS where TXN_ID = "
operator|+
name|txnInfo
operator|.
name|getId
argument_list|()
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|String
index|[]
name|vals
init|=
name|s
operator|.
name|split
argument_list|(
literal|"\\s+"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Didn't get expected timestamps"
argument_list|,
literal|2
argument_list|,
name|vals
operator|.
name|length
argument_list|)
expr_stmt|;
name|long
name|lastHeartbeat
init|=
name|Long
operator|.
name|parseLong
argument_list|(
name|vals
index|[
literal|1
index|]
argument_list|)
decl_stmt|;
comment|//these 2 values are equal when TXN entry is made.  Should never be equal after 1st heartbeat, which we
comment|//expect to have happened by now since HIVE_TXN_TIMEOUT=1sec
name|Assert
operator|.
name|assertNotEquals
argument_list|(
literal|"Didn't see heartbeat happen"
argument_list|,
name|Long
operator|.
name|parseLong
argument_list|(
name|vals
index|[
literal|0
index|]
argument_list|)
argument_list|,
name|lastHeartbeat
argument_list|)
expr_stmt|;
name|ShowLocksResponse
name|slr
init|=
name|txnHandler
operator|.
name|showLocks
argument_list|(
operator|new
name|ShowLocksRequest
argument_list|()
argument_list|)
decl_stmt|;
name|TestDbTxnManager2
operator|.
name|checkLock
argument_list|(
name|LockType
operator|.
name|SHARED_READ
argument_list|,
name|LockState
operator|.
name|ACQUIRED
argument_list|,
literal|"default"
argument_list|,
name|Table
operator|.
name|ACIDTBL
operator|.
name|name
argument_list|,
literal|null
argument_list|,
name|slr
operator|.
name|getLocks
argument_list|()
argument_list|)
expr_stmt|;
name|pause
argument_list|(
literal|750
argument_list|)
expr_stmt|;
name|houseKeeperService
operator|.
name|run
argument_list|()
expr_stmt|;
name|pause
argument_list|(
literal|750
argument_list|)
expr_stmt|;
name|slr
operator|=
name|txnHandler
operator|.
name|showLocks
argument_list|(
operator|new
name|ShowLocksRequest
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected lock count: "
operator|+
name|slr
argument_list|,
literal|1
argument_list|,
name|slr
operator|.
name|getLocks
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TestDbTxnManager2
operator|.
name|checkLock
argument_list|(
name|LockType
operator|.
name|SHARED_READ
argument_list|,
name|LockState
operator|.
name|ACQUIRED
argument_list|,
literal|"default"
argument_list|,
name|Table
operator|.
name|ACIDTBL
operator|.
name|name
argument_list|,
literal|null
argument_list|,
name|slr
operator|.
name|getLocks
argument_list|()
argument_list|)
expr_stmt|;
name|pause
argument_list|(
literal|750
argument_list|)
expr_stmt|;
name|houseKeeperService
operator|.
name|run
argument_list|()
expr_stmt|;
name|slr
operator|=
name|txnHandler
operator|.
name|showLocks
argument_list|(
operator|new
name|ShowLocksRequest
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected lock count: "
operator|+
name|slr
argument_list|,
literal|1
argument_list|,
name|slr
operator|.
name|getLocks
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|TestDbTxnManager2
operator|.
name|checkLock
argument_list|(
name|LockType
operator|.
name|SHARED_READ
argument_list|,
name|LockState
operator|.
name|ACQUIRED
argument_list|,
literal|"default"
argument_list|,
name|Table
operator|.
name|ACIDTBL
operator|.
name|name
argument_list|,
literal|null
argument_list|,
name|slr
operator|.
name|getLocks
argument_list|()
argument_list|)
expr_stmt|;
comment|//should've done several heartbeats
name|s
operator|=
name|TxnDbUtil
operator|.
name|queryToString
argument_list|(
name|hiveConf
argument_list|,
literal|"select TXN_STARTED, TXN_LAST_HEARTBEAT from TXNS where TXN_ID = "
operator|+
name|txnInfo
operator|.
name|getId
argument_list|()
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|vals
operator|=
name|s
operator|.
name|split
argument_list|(
literal|"\\s+"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Didn't get expected timestamps"
argument_list|,
literal|2
argument_list|,
name|vals
operator|.
name|length
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"Heartbeat didn't progress: (old,new) ("
operator|+
name|lastHeartbeat
operator|+
literal|","
operator|+
name|vals
index|[
literal|1
index|]
operator|+
literal|")"
argument_list|,
name|lastHeartbeat
operator|<
name|Long
operator|.
name|parseLong
argument_list|(
name|vals
index|[
literal|1
index|]
argument_list|)
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"rollback"
argument_list|)
expr_stmt|;
name|slr
operator|=
name|txnHandler
operator|.
name|showLocks
argument_list|(
operator|new
name|ShowLocksRequest
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected lock count"
argument_list|,
literal|0
argument_list|,
name|slr
operator|.
name|getLocks
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|static
name|void
name|pause
parameter_list|(
name|int
name|timeMillis
parameter_list|)
block|{
try|try
block|{
name|Thread
operator|.
name|sleep
argument_list|(
name|timeMillis
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|e
parameter_list|)
block|{     }
block|}
annotation|@
name|Test
specifier|public
name|void
name|exchangePartition
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"create database ex1"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create database ex2"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"CREATE TABLE ex1.exchange_part_test1 (f1 string) PARTITIONED BY (ds STRING)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"CREATE TABLE ex2.exchange_part_test2 (f1 string) PARTITIONED BY (ds STRING)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"ALTER TABLE ex2.exchange_part_test2 ADD PARTITION (ds='2013-04-05')"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"ALTER TABLE ex1.exchange_part_test1 EXCHANGE PARTITION (ds='2013-04-05') WITH TABLE ex2.exchange_part_test2"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeNegative
parameter_list|()
throws|throws
name|Exception
block|{
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"MERGE INTO "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" target USING "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" source\nON target.a = source.a "
operator|+
literal|"\nWHEN MATCHED THEN UPDATE set b = 1 "
operator|+
literal|"\nWHEN MATCHED THEN DELETE "
operator|+
literal|"\nWHEN NOT MATCHED AND a< 1 THEN INSERT VALUES(1,2)"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|ErrorMsg
operator|.
name|MERGE_PREDIACTE_REQUIRED
argument_list|,
operator|(
operator|(
name|HiveException
operator|)
name|cpr
operator|.
name|getException
argument_list|()
operator|)
operator|.
name|getCanonicalErrorMsg
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeNegative2
parameter_list|()
throws|throws
name|Exception
block|{
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"MERGE INTO "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" target USING "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"\n source ON target.pk = source.pk "
operator|+
literal|"\nWHEN MATCHED THEN UPDATE set b = 1 "
operator|+
literal|"\nWHEN MATCHED THEN UPDATE set b=a"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|ErrorMsg
operator|.
name|MERGE_TOO_MANY_UPDATE
argument_list|,
operator|(
operator|(
name|HiveException
operator|)
name|cpr
operator|.
name|getException
argument_list|()
operator|)
operator|.
name|getCanonicalErrorMsg
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|/**    * `1` means 1 is a column name and '1' means 1 is a string literal    * HiveConf.HIVE_QUOTEDID_SUPPORT    * HiveConf.HIVE_SUPPORT_SPECICAL_CHARACTERS_IN_TABLE_NAMES    * {@link TestTxnCommands#testMergeType2SCD01()}    */
annotation|@
name|Test
specifier|public
name|void
name|testQuotedIdentifier
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|target
init|=
literal|"`aci/d_u/ami`"
decl_stmt|;
name|String
name|src
init|=
literal|"`src/name`"
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|target
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|src
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table "
operator|+
name|target
operator|+
literal|"(i int,"
operator|+
literal|"`d?*de e` decimal(5,2),"
operator|+
literal|"vc varchar(128)) clustered by (i) into 2 buckets stored as orc TBLPROPERTIES ('transactional'='true')"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table "
operator|+
name|src
operator|+
literal|"(gh int, j decimal(5,2), k varchar(128))"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into "
operator|+
name|target
operator|+
literal|" as `d/8` using "
operator|+
name|src
operator|+
literal|" as `a/b` on i=gh "
operator|+
literal|"\nwhen matched and i> 5 then delete "
operator|+
literal|"\nwhen matched then update set vc='blah' "
operator|+
literal|"\nwhen not matched then insert values(1,2.1,'baz')"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into "
operator|+
name|target
operator|+
literal|" as `d/8` using "
operator|+
name|src
operator|+
literal|" as `a/b` on i=gh "
operator|+
literal|"\nwhen matched and i> 5 then delete "
operator|+
literal|"\nwhen matched then update set vc='blah',  `d?*de e` = current_timestamp()  "
operator|+
literal|"\nwhen not matched then insert values(1,2.1, concat('baz', current_timestamp()))"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into "
operator|+
name|target
operator|+
literal|" as `d/8` using "
operator|+
name|src
operator|+
literal|" as `a/b` on i=gh "
operator|+
literal|"\nwhen matched and i> 5 then delete "
operator|+
literal|"\nwhen matched then update set vc='blah' "
operator|+
literal|"\nwhen not matched then insert values(1,2.1,'a\\b')"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into "
operator|+
name|target
operator|+
literal|" as `d/8` using "
operator|+
name|src
operator|+
literal|" as `a/b` on i=gh "
operator|+
literal|"\nwhen matched and i> 5 then delete "
operator|+
literal|"\nwhen matched then update set vc=''"
operator|+
literal|"\nwhen not matched then insert values(`a/b`.gh,`a/b`.j,'c\\t')"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testQuotedIdentifier2
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|target
init|=
literal|"`aci/d_u/ami`"
decl_stmt|;
name|String
name|src
init|=
literal|"`src/name`"
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|target
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists "
operator|+
name|src
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table "
operator|+
name|target
operator|+
literal|"(i int,"
operator|+
literal|"`d?*de e` decimal(5,2),"
operator|+
literal|"vc varchar(128)) clustered by (i) into 2 buckets stored as orc TBLPROPERTIES ('transactional'='true')"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table "
operator|+
name|src
operator|+
literal|"(`g/h` int, j decimal(5,2), k varchar(128))"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into "
operator|+
name|target
operator|+
literal|" as `d/8` using "
operator|+
name|src
operator|+
literal|" as `a/b` on i=`g/h`"
operator|+
literal|"\nwhen matched and `g/h`> 5 then delete "
operator|+
literal|"\nwhen matched and `g/h`< 0 then update set vc='', `d?*de e` =  `d?*de e` * j + 1"
operator|+
literal|"\nwhen not matched and `d?*de e`<> 0 then insert values(`a/b`.`g/h`,`a/b`.j,`a/b`.k)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into "
operator|+
name|target
operator|+
literal|" as `d/8` using "
operator|+
name|src
operator|+
literal|" as `a/b` on i=`g/h`"
operator|+
literal|"\nwhen matched and `g/h`> 5 then delete"
operator|+
literal|"\n when matched and `g/h`< 0 then update set vc=''  , `d?*de e` =  `d?*de e` * j + 1  "
operator|+
literal|"\n when not matched and `d?*de e`<> 0 then insert values(`a/b`.`g/h`,`a/b`.j,`a/b`.k)"
argument_list|)
expr_stmt|;
block|}
comment|/**    * https://www.linkedin.com/pulse/how-load-slowly-changing-dimension-type-2-using-oracle-padhy    * also test QuotedIdentifier inside source expression    * {@link TestTxnCommands#testQuotedIdentifier()}    * {@link TestTxnCommands#testQuotedIdentifier2()}    */
annotation|@
name|Test
specifier|public
name|void
name|testMergeType2SCD01
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists target"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists source"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists splitTable"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table splitTable(op int)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into splitTable values (0),(1)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table source (key int, data int)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table target (key int, data int, cur int) clustered by (key) into "
operator|+
name|BUCKET_COUNT
operator|+
literal|" buckets stored as orc TBLPROPERTIES ('transactional'='true')"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|targetVals
init|=
block|{
block|{
literal|1
block|,
literal|5
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|6
block|,
literal|1
block|}
block|,
block|{
literal|1
block|,
literal|18
block|,
literal|0
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into target "
operator|+
name|makeValuesClause
argument_list|(
name|targetVals
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|sourceVals
init|=
block|{
block|{
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|3
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into source "
operator|+
name|makeValuesClause
argument_list|(
name|sourceVals
argument_list|)
argument_list|)
expr_stmt|;
comment|//augment source with a col which has 1 if it will cause an update in target, 0 otherwise
name|String
name|curMatch
init|=
literal|"select s.*, case when t.cur is null then 0 else 1 end m from source s left outer join (select * from target where target.cur=1) t on s.key=t.key"
decl_stmt|;
comment|//split each row (duplicate) which will cause an update into 2 rows and augment with 'op' col which has 0 to insert, 1 to update
name|String
name|teeCurMatch
init|=
literal|"select curMatch.*, case when splitTable.op is null or splitTable.op = 0 then 0 else 1 end `o/p\\n` from ("
operator|+
name|curMatch
operator|+
literal|") curMatch left outer join splitTable on curMatch.m=1"
decl_stmt|;
if|if
condition|(
literal|false
condition|)
block|{
comment|//this is just for debug
name|List
argument_list|<
name|String
argument_list|>
name|r1
init|=
name|runStatementOnDriver
argument_list|(
name|curMatch
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r2
init|=
name|runStatementOnDriver
argument_list|(
name|teeCurMatch
argument_list|)
decl_stmt|;
block|}
name|String
name|stmt
init|=
literal|"merge into target t using ("
operator|+
name|teeCurMatch
operator|+
literal|") s on t.key=s.key and t.cur=1 and s.`o/p\\n`=1 "
operator|+
literal|"when matched then update set cur=0 "
operator|+
literal|"when not matched then insert values(s.key,s.data,1)"
decl_stmt|;
comment|//to allow cross join from 'teeCurMatch'
name|hiveConf
operator|.
name|setBoolVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STRICT_CHECKS_CARTESIAN
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|resultVals
init|=
block|{
block|{
literal|1
block|,
literal|5
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|7
block|,
literal|1
block|}
block|,
block|{
literal|1
block|,
literal|18
block|,
literal|0
block|}
block|,
block|{
literal|2
block|,
literal|6
block|,
literal|1
block|}
block|,
block|{
literal|3
block|,
literal|8
block|,
literal|1
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select * from target order by key,data,cur"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|resultVals
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
comment|/**    * https://www.linkedin.com/pulse/how-load-slowly-changing-dimension-type-2-using-oracle-padhy    * Same as testMergeType2SCD01 but with a more intuitive "source" expression    */
annotation|@
name|Test
specifier|public
name|void
name|testMergeType2SCD02
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists target"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists source"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table source (key int, data int)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table target (key int, data int, cur int) clustered by (key) into "
operator|+
name|BUCKET_COUNT
operator|+
literal|" buckets stored as orc TBLPROPERTIES ('transactional'='true')"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|targetVals
init|=
block|{
block|{
literal|1
block|,
literal|5
block|,
literal|1
block|}
block|,
block|{
literal|2
block|,
literal|6
block|,
literal|1
block|}
block|,
block|{
literal|1
block|,
literal|18
block|,
literal|0
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into target "
operator|+
name|makeValuesClause
argument_list|(
name|targetVals
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|sourceVals
init|=
block|{
block|{
literal|1
block|,
literal|7
block|}
block|,
block|{
literal|3
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into source "
operator|+
name|makeValuesClause
argument_list|(
name|sourceVals
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|baseSrc
init|=
literal|"select source.*, 0 c from source "
operator|+
literal|"union all "
operator|+
literal|"select source.*, 1 c from source "
operator|+
literal|"inner join target "
operator|+
literal|"on source.key=target.key where target.cur=1"
decl_stmt|;
if|if
condition|(
literal|false
condition|)
block|{
comment|//this is just for debug
name|List
argument_list|<
name|String
argument_list|>
name|r1
init|=
name|runStatementOnDriver
argument_list|(
name|baseSrc
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r2
init|=
name|runStatementOnDriver
argument_list|(
literal|"select t.*, s.* from target t right outer join ("
operator|+
name|baseSrc
operator|+
literal|") s "
operator|+
literal|"\non t.key=s.key and t.cur=s.c and t.cur=1"
argument_list|)
decl_stmt|;
block|}
name|String
name|stmt
init|=
literal|"merge into target t using "
operator|+
literal|"("
operator|+
name|baseSrc
operator|+
literal|") s "
operator|+
literal|"on t.key=s.key and t.cur=s.c and t.cur=1 "
operator|+
literal|"when matched then update set cur=0 "
operator|+
literal|"when not matched then insert values(s.key,s.data,1)"
decl_stmt|;
name|runStatementOnDriver
argument_list|(
name|stmt
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|resultVals
init|=
block|{
block|{
literal|1
block|,
literal|5
block|,
literal|0
block|}
block|,
block|{
literal|1
block|,
literal|7
block|,
literal|1
block|}
block|,
block|{
literal|1
block|,
literal|18
block|,
literal|0
block|}
block|,
block|{
literal|2
block|,
literal|6
block|,
literal|1
block|}
block|,
block|{
literal|3
block|,
literal|8
block|,
literal|1
block|}
block|}
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select * from target order by key,data,cur"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|resultVals
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeOnTezEdges
parameter_list|()
throws|throws
name|Exception
block|{
name|String
name|query
init|=
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" as t using "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" s ON t.a = s.a "
operator|+
literal|"WHEN MATCHED AND s.a> 8 THEN DELETE "
operator|+
literal|"WHEN MATCHED THEN UPDATE SET b = 7 "
operator|+
literal|"WHEN NOT MATCHED THEN INSERT VALUES(s.a, s.b) "
decl_stmt|;
name|d
operator|.
name|destroy
argument_list|()
expr_stmt|;
name|HiveConf
name|hc
init|=
operator|new
name|HiveConf
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|hc
operator|.
name|setVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_EXECUTION_ENGINE
argument_list|,
literal|"tez"
argument_list|)
expr_stmt|;
name|hc
operator|.
name|setBoolVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_EXPLAIN_USER
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|d
operator|=
operator|new
name|Driver
argument_list|(
name|hc
argument_list|)
expr_stmt|;
name|d
operator|.
name|setMaxRows
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|explain
init|=
name|runStatementOnDriver
argument_list|(
literal|"explain "
operator|+
name|query
argument_list|)
decl_stmt|;
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|s
range|:
name|explain
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
name|s
argument_list|)
operator|.
name|append
argument_list|(
literal|'\n'
argument_list|)
expr_stmt|;
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Explain1: "
operator|+
name|sb
argument_list|)
expr_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|explain
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
if|if
condition|(
name|explain
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|contains
argument_list|(
literal|"Edges:"
argument_list|)
condition|)
block|{
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"At i+1="
operator|+
operator|(
name|i
operator|+
literal|1
operator|)
operator|+
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|1
argument_list|)
argument_list|,
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|1
argument_list|)
operator|.
name|contains
argument_list|(
literal|"Reducer 2<- Map 1 (SIMPLE_EDGE), Map 7 (SIMPLE_EDGE)"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"At i+1="
operator|+
operator|(
name|i
operator|+
literal|2
operator|)
operator|+
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|2
argument_list|)
argument_list|,
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|2
argument_list|)
operator|.
name|contains
argument_list|(
literal|"Reducer 3<- Reducer 2 (SIMPLE_EDGE)"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"At i+1="
operator|+
operator|(
name|i
operator|+
literal|3
operator|)
operator|+
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|3
argument_list|)
argument_list|,
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|3
argument_list|)
operator|.
name|contains
argument_list|(
literal|"Reducer 4<- Reducer 2 (SIMPLE_EDGE)"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"At i+1="
operator|+
operator|(
name|i
operator|+
literal|4
operator|)
operator|+
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|4
argument_list|)
argument_list|,
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|4
argument_list|)
operator|.
name|contains
argument_list|(
literal|"Reducer 5<- Reducer 2 (SIMPLE_EDGE)"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"At i+1="
operator|+
operator|(
name|i
operator|+
literal|5
operator|)
operator|+
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|5
argument_list|)
argument_list|,
name|explain
operator|.
name|get
argument_list|(
name|i
operator|+
literal|5
argument_list|)
operator|.
name|contains
argument_list|(
literal|"Reducer 6<- Reducer 2 (CUSTOM_SIMPLE_EDGE)"
argument_list|)
argument_list|)
expr_stmt|;
break|break;
block|}
block|}
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeUpdateDelete
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|baseValsOdd
init|=
block|{
block|{
literal|2
block|,
literal|2
block|}
block|,
block|{
literal|4
block|,
literal|44
block|}
block|,
block|{
literal|5
block|,
literal|5
block|}
block|,
block|{
literal|11
block|,
literal|11
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|baseValsOdd
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|vals
init|=
block|{
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|3
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|vals
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|query
init|=
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" as t using "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" s ON t.a = s.a "
operator|+
literal|"WHEN MATCHED AND s.a< 3 THEN update set b = 0 "
operator|+
comment|//updates (2,1) -> (2,0)
literal|"WHEN MATCHED and t.a> 3 and t.a< 5 THEN DELETE "
operator|+
comment|//deletes (4,3)
literal|"WHEN NOT MATCHED THEN INSERT VALUES(s.a, s.b) "
decl_stmt|;
comment|//inserts (11,11)
name|runStatementOnDriver
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|rExpected
init|=
block|{
block|{
literal|2
block|,
literal|0
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|,
block|{
literal|11
block|,
literal|11
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|rExpected
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeUpdateDeleteNoCardCheck
parameter_list|()
throws|throws
name|Exception
block|{
name|d
operator|.
name|destroy
argument_list|()
expr_stmt|;
name|HiveConf
name|hc
init|=
operator|new
name|HiveConf
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|hc
operator|.
name|setBoolVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|MERGE_CARDINALITY_VIOLATION_CHECK
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|d
operator|=
operator|new
name|Driver
argument_list|(
name|hc
argument_list|)
expr_stmt|;
name|d
operator|.
name|setMaxRows
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|baseValsOdd
init|=
block|{
block|{
literal|2
block|,
literal|2
block|}
block|,
block|{
literal|4
block|,
literal|44
block|}
block|,
block|{
literal|5
block|,
literal|5
block|}
block|,
block|{
literal|11
block|,
literal|11
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|baseValsOdd
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|vals
init|=
block|{
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|3
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|vals
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|query
init|=
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" as t using "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" s ON t.a = s.a "
operator|+
literal|"WHEN MATCHED AND s.a< 3 THEN update set b = 0 "
operator|+
literal|"WHEN MATCHED and t.a> 3 and t.a< 5 THEN DELETE "
decl_stmt|;
name|runStatementOnDriver
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|rExpected
init|=
block|{
block|{
literal|2
block|,
literal|0
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|rExpected
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeDeleteUpdate
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|sourceVals
init|=
block|{
block|{
literal|2
block|,
literal|2
block|}
block|,
block|{
literal|4
block|,
literal|44
block|}
block|,
block|{
literal|5
block|,
literal|5
block|}
block|,
block|{
literal|11
block|,
literal|11
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|sourceVals
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|targetVals
init|=
block|{
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|3
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|targetVals
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|query
init|=
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" as t using "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" s ON t.a = s.a "
operator|+
literal|"WHEN MATCHED and s.a< 5 THEN DELETE "
operator|+
literal|"WHEN MATCHED AND s.a< 3 THEN update set b = 0 "
operator|+
literal|"WHEN NOT MATCHED THEN INSERT VALUES(s.a, s.b) "
decl_stmt|;
name|runStatementOnDriver
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select a,b from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a,b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|rExpected
init|=
block|{
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|,
block|{
literal|11
block|,
literal|11
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|rExpected
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
comment|/**    * see https://issues.apache.org/jira/browse/HIVE-14949 for details    * @throws Exception    */
annotation|@
name|Test
specifier|public
name|void
name|testMergeCardinalityViolation
parameter_list|()
throws|throws
name|Exception
block|{
name|int
index|[]
index|[]
name|sourceVals
init|=
block|{
block|{
literal|2
block|,
literal|2
block|}
block|,
block|{
literal|2
block|,
literal|44
block|}
block|,
block|{
literal|5
block|,
literal|5
block|}
block|,
block|{
literal|11
block|,
literal|11
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|sourceVals
argument_list|)
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|targetVals
init|=
block|{
block|{
literal|2
block|,
literal|1
block|}
block|,
block|{
literal|4
block|,
literal|3
block|}
block|,
block|{
literal|5
block|,
literal|6
block|}
block|,
block|{
literal|7
block|,
literal|8
block|}
block|}
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" "
operator|+
name|makeValuesClause
argument_list|(
name|targetVals
argument_list|)
argument_list|)
expr_stmt|;
name|String
name|query
init|=
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" as t using "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" s ON t.a = s.a "
operator|+
literal|"WHEN MATCHED and s.a< 5 THEN DELETE "
operator|+
literal|"WHEN MATCHED AND s.a< 3 THEN update set b = 0 "
operator|+
literal|"WHEN NOT MATCHED THEN INSERT VALUES(s.a, s.b) "
decl_stmt|;
name|runStatementOnDriverNegative
argument_list|(
name|query
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBLPART
operator|+
literal|" partition(p) values(1,1,'p1'),(2,2,'p1'),(3,3,'p1'),(4,4,'p2')"
argument_list|)
expr_stmt|;
name|query
operator|=
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBLPART
operator|+
literal|" as t using "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" s ON t.a = s.a "
operator|+
literal|"WHEN MATCHED and s.a< 5 THEN DELETE "
operator|+
literal|"WHEN MATCHED AND s.a< 3 THEN update set b = 0 "
operator|+
literal|"WHEN NOT MATCHED THEN INSERT VALUES(s.a, s.b, 'p1') "
expr_stmt|;
name|runStatementOnDriverNegative
argument_list|(
name|query
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testSetClauseFakeColumn
parameter_list|()
throws|throws
name|Exception
block|{
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"MERGE INTO "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" target USING "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"\n source ON target.a = source.a "
operator|+
literal|"\nWHEN MATCHED THEN UPDATE set t = 1"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|ErrorMsg
operator|.
name|INVALID_TARGET_COLUMN_IN_SET_CLAUSE
argument_list|,
operator|(
operator|(
name|HiveException
operator|)
name|cpr
operator|.
name|getException
argument_list|()
operator|)
operator|.
name|getCanonicalErrorMsg
argument_list|()
argument_list|)
expr_stmt|;
name|cpr
operator|=
name|runStatementOnDriverNegative
argument_list|(
literal|"update "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" set t = 1"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|ErrorMsg
operator|.
name|INVALID_TARGET_COLUMN_IN_SET_CLAUSE
argument_list|,
operator|(
operator|(
name|HiveException
operator|)
name|cpr
operator|.
name|getException
argument_list|()
operator|)
operator|.
name|getCanonicalErrorMsg
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testBadOnClause
parameter_list|()
throws|throws
name|Exception
block|{
name|CommandProcessorResponse
name|cpr
init|=
name|runStatementOnDriverNegative
argument_list|(
literal|"merge into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" trgt using (select * from "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"src) sub on sub.a = target.a when not matched then insert values (sub.a,sub.b)"
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
literal|"Error didn't match: "
operator|+
name|cpr
argument_list|,
name|cpr
operator|.
name|getErrorMessage
argument_list|()
operator|.
name|contains
argument_list|(
literal|"No columns from target table 'trgt' found in ON clause '`sub`.`a` = `target`.`a`' of MERGE statement."
argument_list|)
argument_list|)
expr_stmt|;
block|}
comment|/**    * Writing UTs that need multiple threads is challenging since Derby chokes on concurrent access.    * This tests that "AND WAIT" actually blocks and responds to interrupt    * @throws Exception    */
annotation|@
name|Test
specifier|public
name|void
name|testCompactionBlocking
parameter_list|()
throws|throws
name|Exception
block|{
name|Timer
name|cancelCompact
init|=
operator|new
name|Timer
argument_list|(
literal|"CancelCompactionTimer"
argument_list|,
literal|false
argument_list|)
decl_stmt|;
specifier|final
name|Thread
name|threadToInterrupt
init|=
name|Thread
operator|.
name|currentThread
argument_list|()
decl_stmt|;
name|cancelCompact
operator|.
name|schedule
argument_list|(
operator|new
name|TimerTask
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
name|threadToInterrupt
operator|.
name|interrupt
argument_list|()
expr_stmt|;
block|}
block|}
argument_list|,
literal|5000
argument_list|)
expr_stmt|;
name|long
name|start
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"alter table "
operator|+
name|TestTxnCommands2
operator|.
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" compact 'major' AND WAIT"
argument_list|)
expr_stmt|;
comment|//no Worker so it stays in initiated state
comment|//w/o AND WAIT the above alter table retunrs almost immediately, so the test here to check that
comment|//> 2 seconds pass, i.e. that the command in Driver actually blocks before cancel is fired
name|Assert
operator|.
name|assertTrue
argument_list|(
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|>
name|start
operator|+
literal|2
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testMergeCase
parameter_list|()
throws|throws
name|Exception
block|{
name|runStatementOnDriver
argument_list|(
literal|"create table merge_test (c1 integer, c2 integer, c3 integer) CLUSTERED BY (c1) into 2 buckets stored as orc tblproperties(\"transactional\"=\"true\")"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table if not exists e011_02 (c1 float, c2 double, c3 float)"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"merge into merge_test using e011_02 on (merge_test.c1 = e011_02.c1) when not matched then insert values (case when e011_02.c1> 0 then e011_02.c1 + 1 else e011_02.c1 end, e011_02.c2 + e011_02.c3, coalesce(e011_02.c3, 1))"
argument_list|)
expr_stmt|;
block|}
comment|/**    * HIVE-16177    * See also {@link TestTxnCommands2#testNonAcidToAcidConversion02()}    */
annotation|@
name|Test
specifier|public
name|void
name|testNonAcidToAcidConversion01
parameter_list|()
throws|throws
name|Exception
block|{
comment|//create 1 row in a file 000001_0 (and an empty 000000_0)
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"(a,b) values(1,2)"
argument_list|)
expr_stmt|;
comment|//create 1 row in a file 000000_0_copy1 and 1 row in a file 000001_0_copy1
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"(a,b) values(0,12),(1,5)"
argument_list|)
expr_stmt|;
comment|//convert the table to Acid
name|runStatementOnDriver
argument_list|(
literal|"alter table "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" SET TBLPROPERTIES ('transactional'='true')"
argument_list|)
expr_stmt|;
comment|//create a delta directory
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|"(a,b) values(1,17)"
argument_list|)
expr_stmt|;
comment|//make sure we assign correct Ids
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select ROW__ID, a, b, INPUT__FILE__NAME from "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" order by ROW__ID"
argument_list|)
decl_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"before compact"
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|s
range|:
name|rs
control|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|536870912
argument_list|,
name|BucketCodec
operator|.
name|V1
operator|.
name|encode
argument_list|(
operator|new
name|AcidOutputFormat
operator|.
name|Options
argument_list|(
name|hiveConf
argument_list|)
operator|.
name|bucket
argument_list|(
literal|0
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|536936448
argument_list|,
name|BucketCodec
operator|.
name|V1
operator|.
name|encode
argument_list|(
operator|new
name|AcidOutputFormat
operator|.
name|Options
argument_list|(
name|hiveConf
argument_list|)
operator|.
name|bucket
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|""
argument_list|,
literal|4
argument_list|,
name|rs
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":0,\"bucketid\":536936448,\"rowid\":0}\t1\t2"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/000001_0"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":0,\"bucketid\":536936448,\"rowid\":1}\t1\t5"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/000001_0_copy_1"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":0,\"bucketid\":536936448,\"rowid\":2}\t0\t12"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/000001_0_copy_1"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":1,\"bucketid\":536936448,\"rowid\":0}\t1\t17"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/delta_0000001_0000001_0000/bucket_00001"
argument_list|)
argument_list|)
expr_stmt|;
comment|//run Compaction
name|runStatementOnDriver
argument_list|(
literal|"alter table "
operator|+
name|TestTxnCommands2
operator|.
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" compact 'major'"
argument_list|)
expr_stmt|;
name|TestTxnCommands2
operator|.
name|runWorker
argument_list|(
name|hiveConf
argument_list|)
expr_stmt|;
name|rs
operator|=
name|runStatementOnDriver
argument_list|(
literal|"select ROW__ID, a, b, INPUT__FILE__NAME from "
operator|+
name|Table
operator|.
name|NONACIDORCTBL
operator|+
literal|" order by ROW__ID"
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|warn
argument_list|(
literal|"after compact"
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|s
range|:
name|rs
control|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|s
argument_list|)
expr_stmt|;
block|}
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|""
argument_list|,
literal|4
argument_list|,
name|rs
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":0,\"bucketid\":536936448,\"rowid\":0}\t1\t2"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/base_0000001/bucket_00001"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":0,\"bucketid\":536936448,\"rowid\":1}\t1\t5"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|1
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/base_0000001/bucket_00001"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":0,\"bucketid\":536936448,\"rowid\":2}\t0\t12"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|2
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/base_0000001/bucket_00001"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
operator|.
name|startsWith
argument_list|(
literal|"{\"writeid\":1,\"bucketid\":536936448,\"rowid\":0}\t1\t17"
argument_list|)
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
argument_list|,
name|rs
operator|.
name|get
argument_list|(
literal|3
argument_list|)
operator|.
name|endsWith
argument_list|(
literal|"nonacidorctbl/base_0000001/bucket_00001"
argument_list|)
argument_list|)
expr_stmt|;
comment|//make sure they are the same before and after compaction
block|}
comment|//@Ignore("see bucket_num_reducers_acid.q")
annotation|@
name|Test
specifier|public
name|void
name|testMoreBucketsThanReducers
parameter_list|()
throws|throws
name|Exception
block|{
comment|//see bucket_num_reducers.q bucket_num_reducers2.q
comment|// todo: try using set VerifyNumReducersHook.num.reducers=10;
name|d
operator|.
name|destroy
argument_list|()
expr_stmt|;
name|HiveConf
name|hc
init|=
operator|new
name|HiveConf
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|hc
operator|.
name|setIntVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|MAXREDUCERS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
comment|//this is used in multiple places, SemanticAnalyzer.getBucketingSortingDest() among others
name|hc
operator|.
name|setIntVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HADOOPNUMREDUCERS
argument_list|,
literal|1
argument_list|)
expr_stmt|;
name|hc
operator|.
name|setBoolVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_EXPLAIN_USER
argument_list|,
literal|false
argument_list|)
expr_stmt|;
name|d
operator|=
operator|new
name|Driver
argument_list|(
name|hc
argument_list|)
expr_stmt|;
name|d
operator|.
name|setMaxRows
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" values(1,1)"
argument_list|)
expr_stmt|;
comment|//txn X write to bucket1
name|runStatementOnDriver
argument_list|(
literal|"insert into "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" values(0,0),(3,3)"
argument_list|)
expr_stmt|;
comment|// txn X + 1 write to bucket0 + bucket1
name|runStatementOnDriver
argument_list|(
literal|"update "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" set b = -1"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select * from "
operator|+
name|Table
operator|.
name|ACIDTBL
operator|+
literal|" order by a, b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|expected
init|=
block|{
block|{
literal|0
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|1
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|3
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|expected
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Ignore
argument_list|(
literal|"Moved to Tez"
argument_list|)
annotation|@
name|Test
specifier|public
name|void
name|testMoreBucketsThanReducers2
parameter_list|()
throws|throws
name|Exception
block|{
comment|//todo: try using set VerifyNumReducersHook.num.reducers=10;
comment|//see bucket_num_reducers.q bucket_num_reducers2.q
name|d
operator|.
name|destroy
argument_list|()
expr_stmt|;
name|HiveConf
name|hc
init|=
operator|new
name|HiveConf
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|hc
operator|.
name|setIntVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|MAXREDUCERS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
comment|//this is used in multiple places, SemanticAnalyzer.getBucketingSortingDest() among others
name|hc
operator|.
name|setIntVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HADOOPNUMREDUCERS
argument_list|,
literal|2
argument_list|)
expr_stmt|;
name|d
operator|=
operator|new
name|Driver
argument_list|(
name|hc
argument_list|)
expr_stmt|;
name|d
operator|.
name|setMaxRows
argument_list|(
literal|10000
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table fourbuckets (a int, b int) clustered by (a) into 4 buckets stored as orc TBLPROPERTIES ('transactional'='true')"
argument_list|)
expr_stmt|;
comment|//below value for a is bucket id, for b - txn id (logically)
name|runStatementOnDriver
argument_list|(
literal|"insert into fourbuckets values(0,1),(1,1)"
argument_list|)
expr_stmt|;
comment|//txn X write to b0 + b1
name|runStatementOnDriver
argument_list|(
literal|"insert into fourbuckets values(2,2),(3,2)"
argument_list|)
expr_stmt|;
comment|// txn X + 1 write to b2 + b3
name|runStatementOnDriver
argument_list|(
literal|"insert into fourbuckets values(0,3),(1,3)"
argument_list|)
expr_stmt|;
comment|//txn X + 2 write to b0 + b1
name|runStatementOnDriver
argument_list|(
literal|"insert into fourbuckets values(2,4),(3,4)"
argument_list|)
expr_stmt|;
comment|//txn X + 3 write to b2 + b3
comment|//so with 2 FileSinks and 4 buckets, FS1 should see (0,1),(2,2),(0,3)(2,4) since data is sorted by ROW__ID where tnxid is the first component
comment|//FS2 should see (1,1),(3,2),(1,3),(3,4)
name|runStatementOnDriver
argument_list|(
literal|"update fourbuckets set b = -1"
argument_list|)
expr_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|r
init|=
name|runStatementOnDriver
argument_list|(
literal|"select * from fourbuckets order by a, b"
argument_list|)
decl_stmt|;
name|int
index|[]
index|[]
name|expected
init|=
block|{
block|{
literal|0
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|0
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|1
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|1
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|2
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|2
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|3
block|,
operator|-
literal|1
block|}
block|,
block|{
literal|3
block|,
operator|-
literal|1
block|}
block|}
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
name|stringifyValues
argument_list|(
name|expected
argument_list|)
argument_list|,
name|r
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testVersioning
parameter_list|()
throws|throws
name|Exception
block|{
name|hiveConf
operator|.
name|set
argument_list|(
name|MetastoreConf
operator|.
name|ConfVars
operator|.
name|CREATE_TABLES_AS_ACID
operator|.
name|getVarname
argument_list|()
argument_list|,
literal|"true"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"drop table if exists T"
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"create table T (a int, b int) stored as orc"
argument_list|)
expr_stmt|;
name|int
index|[]
index|[]
name|data
init|=
block|{
block|{
literal|1
block|,
literal|2
block|}
block|}
decl_stmt|;
comment|//create 1 delta file bucket_00000
name|runStatementOnDriver
argument_list|(
literal|"insert into T"
operator|+
name|makeValuesClause
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
comment|//delete the bucket files so now we have empty delta dirs
name|List
argument_list|<
name|String
argument_list|>
name|rs
init|=
name|runStatementOnDriver
argument_list|(
literal|"select distinct INPUT__FILE__NAME from T"
argument_list|)
decl_stmt|;
name|FileSystem
name|fs
init|=
name|FileSystem
operator|.
name|get
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|!=
literal|null
operator|&&
name|rs
operator|.
name|size
argument_list|()
operator|==
literal|1
operator|&&
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|contains
argument_list|(
name|AcidUtils
operator|.
name|DELTA_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|Path
name|filePath
init|=
operator|new
name|Path
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
name|int
name|version
init|=
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|getAcidVersionFromDataFile
argument_list|(
name|filePath
argument_list|,
name|fs
argument_list|)
decl_stmt|;
comment|//check it has expected version marker
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected version marker in "
operator|+
name|filePath
argument_list|,
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|ORC_ACID_VERSION
argument_list|,
name|version
argument_list|)
expr_stmt|;
comment|//check that delta dir has a version file with expected value
name|filePath
operator|=
name|filePath
operator|.
name|getParent
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|filePath
operator|.
name|getName
argument_list|()
operator|.
name|startsWith
argument_list|(
name|AcidUtils
operator|.
name|DELTA_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|int
name|versionFromMetaFile
init|=
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|getAcidVersionFromMetaFile
argument_list|(
name|filePath
argument_list|,
name|fs
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected version marker in "
operator|+
name|filePath
argument_list|,
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|ORC_ACID_VERSION
argument_list|,
name|versionFromMetaFile
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"insert into T"
operator|+
name|makeValuesClause
argument_list|(
name|data
argument_list|)
argument_list|)
expr_stmt|;
name|runStatementOnDriver
argument_list|(
literal|"alter table T compact 'major'"
argument_list|)
expr_stmt|;
name|TestTxnCommands2
operator|.
name|runWorker
argument_list|(
name|hiveConf
argument_list|)
expr_stmt|;
comment|//check status of compaction job
name|TxnStore
name|txnHandler
init|=
name|TxnUtils
operator|.
name|getTxnStore
argument_list|(
name|hiveConf
argument_list|)
decl_stmt|;
name|ShowCompactResponse
name|resp
init|=
name|txnHandler
operator|.
name|showCompact
argument_list|(
operator|new
name|ShowCompactRequest
argument_list|()
argument_list|)
decl_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected number of compactions in history"
argument_list|,
literal|1
argument_list|,
name|resp
operator|.
name|getCompactsSize
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected 0 compaction state"
argument_list|,
name|TxnStore
operator|.
name|CLEANING_RESPONSE
argument_list|,
name|resp
operator|.
name|getCompacts
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|resp
operator|.
name|getCompacts
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getHadoopJobId
argument_list|()
operator|.
name|startsWith
argument_list|(
literal|"job_local"
argument_list|)
argument_list|)
expr_stmt|;
name|rs
operator|=
name|runStatementOnDriver
argument_list|(
literal|"select distinct INPUT__FILE__NAME from T"
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|rs
operator|!=
literal|null
operator|&&
name|rs
operator|.
name|size
argument_list|()
operator|==
literal|1
operator|&&
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|contains
argument_list|(
name|AcidUtils
operator|.
name|BASE_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|filePath
operator|=
operator|new
name|Path
argument_list|(
name|rs
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
expr_stmt|;
name|version
operator|=
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|getAcidVersionFromDataFile
argument_list|(
name|filePath
argument_list|,
name|fs
argument_list|)
expr_stmt|;
comment|//check that files produced by compaction still have the version marker
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected version marker in "
operator|+
name|filePath
argument_list|,
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|ORC_ACID_VERSION
argument_list|,
name|version
argument_list|)
expr_stmt|;
comment|//check that compacted base dir has a version file with expected value
name|filePath
operator|=
name|filePath
operator|.
name|getParent
argument_list|()
expr_stmt|;
name|Assert
operator|.
name|assertTrue
argument_list|(
name|filePath
operator|.
name|getName
argument_list|()
operator|.
name|startsWith
argument_list|(
name|AcidUtils
operator|.
name|BASE_PREFIX
argument_list|)
argument_list|)
expr_stmt|;
name|versionFromMetaFile
operator|=
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|getAcidVersionFromMetaFile
argument_list|(
name|filePath
argument_list|,
name|fs
argument_list|)
expr_stmt|;
name|Assert
operator|.
name|assertEquals
argument_list|(
literal|"Unexpected version marker in "
operator|+
name|filePath
argument_list|,
name|AcidUtils
operator|.
name|OrcAcidVersion
operator|.
name|ORC_ACID_VERSION
argument_list|,
name|versionFromMetaFile
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

