begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|sarg
package|;
end_package

begin_import
import|import static
name|junit
operator|.
name|framework
operator|.
name|Assert
operator|.
name|assertEquals
import|;
end_import

begin_import
import|import static
name|junit
operator|.
name|framework
operator|.
name|Assert
operator|.
name|assertTrue
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Sets
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|common
operator|.
name|type
operator|.
name|HiveChar
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|common
operator|.
name|type
operator|.
name|HiveVarchar
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|orc
operator|.
name|TestInputOutputFormat
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|sarg
operator|.
name|SearchArgument
operator|.
name|TruthValue
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|io
operator|.
name|sarg
operator|.
name|SearchArgumentImpl
operator|.
name|PredicateLeafImpl
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeGenericFuncDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|io
operator|.
name|HiveDecimalWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|junit
operator|.
name|Test
import|;
end_import

begin_import
import|import
name|java
operator|.
name|beans
operator|.
name|XMLDecoder
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|ByteArrayInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|UnsupportedEncodingException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|lang
operator|.
name|reflect
operator|.
name|Field
import|;
end_import

begin_import
import|import
name|java
operator|.
name|sql
operator|.
name|Date
import|;
end_import

begin_import
import|import
name|java
operator|.
name|sql
operator|.
name|Timestamp
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|parquet
operator|.
name|filter2
operator|.
name|predicate
operator|.
name|FilterPredicate
import|;
end_import

begin_comment
comment|/**  * These test the SARG implementation.  * The xml files were generated by setting hive.optimize.index.filter  * to true and using a custom record reader that prints out the value of  * hive.io.filter.expr.serialized in createRecordReader. This should be  * replaced by generating the AST using the API and passing that in.  *<p/>  * In each case, the corresponding part of the where clause is in the  * comment above the blob.  */
end_comment

begin_class
specifier|public
class|class
name|TestSearchArgumentImpl
block|{
specifier|private
name|ExpressionTree
name|not
parameter_list|(
name|ExpressionTree
name|arg
parameter_list|)
block|{
return|return
operator|new
name|ExpressionTree
argument_list|(
name|ExpressionTree
operator|.
name|Operator
operator|.
name|NOT
argument_list|,
name|arg
argument_list|)
return|;
block|}
specifier|private
name|ExpressionTree
name|and
parameter_list|(
name|ExpressionTree
modifier|...
name|arg
parameter_list|)
block|{
return|return
operator|new
name|ExpressionTree
argument_list|(
name|ExpressionTree
operator|.
name|Operator
operator|.
name|AND
argument_list|,
name|arg
argument_list|)
return|;
block|}
specifier|private
name|ExpressionTree
name|or
parameter_list|(
name|ExpressionTree
modifier|...
name|arg
parameter_list|)
block|{
return|return
operator|new
name|ExpressionTree
argument_list|(
name|ExpressionTree
operator|.
name|Operator
operator|.
name|OR
argument_list|,
name|arg
argument_list|)
return|;
block|}
specifier|private
name|ExpressionTree
name|leaf
parameter_list|(
name|int
name|leaf
parameter_list|)
block|{
return|return
operator|new
name|ExpressionTree
argument_list|(
name|leaf
argument_list|)
return|;
block|}
specifier|private
name|ExpressionTree
name|constant
parameter_list|(
name|TruthValue
name|val
parameter_list|)
block|{
return|return
operator|new
name|ExpressionTree
argument_list|(
name|val
argument_list|)
return|;
block|}
comment|/**    * Create a predicate leaf. This is used by another test.    */
specifier|public
specifier|static
name|PredicateLeaf
name|createPredicateLeaf
parameter_list|(
name|PredicateLeaf
operator|.
name|Operator
name|operator
parameter_list|,
name|PredicateLeaf
operator|.
name|Type
name|type
parameter_list|,
name|String
name|columnName
parameter_list|,
name|Object
name|literal
parameter_list|,
name|List
argument_list|<
name|Object
argument_list|>
name|literalList
parameter_list|)
block|{
return|return
operator|new
name|SearchArgumentImpl
operator|.
name|PredicateLeafImpl
argument_list|(
name|operator
argument_list|,
name|type
argument_list|,
name|columnName
argument_list|,
name|literal
argument_list|,
name|literalList
argument_list|)
return|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testNotPushdown
parameter_list|()
throws|throws
name|Exception
block|{
name|assertEquals
argument_list|(
literal|"leaf-1"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(not leaf-1)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-1"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(not leaf-1)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|not
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or leaf-1 (not leaf-2))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|and
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and (not leaf-1) leaf-2)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|not
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or (or (not leaf-1) leaf-2) leaf-3)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|or
argument_list|(
name|not
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|not
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|not
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"NO"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|NO
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES_NO"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES_NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|NO_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"NO_NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES_NO_NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|pushDownNot
argument_list|(
name|not
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testFlatten
parameter_list|()
throws|throws
name|Exception
block|{
name|assertEquals
argument_list|(
literal|"leaf-1"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"NO"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|NO
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(not (not leaf-1))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|not
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-1 leaf-2)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and (or leaf-1 leaf-2) leaf-3)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|and
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-1 leaf-2 leaf-3 leaf-4)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|and
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or leaf-1 leaf-2 leaf-3 leaf-4)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|or
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|or
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or leaf-1 leaf-2 leaf-3 leaf-4)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|or
argument_list|(
name|or
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or leaf-1 leaf-2 leaf-3 leaf-4 leaf-5 leaf-6)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|or
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|or
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|or
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and (not leaf-1) leaf-2 (not leaf-3) leaf-4 (not leaf-5) leaf-6)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|and
argument_list|(
name|and
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|not
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|not
argument_list|(
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(not (and leaf-1 leaf-2 leaf-3))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|flatten
argument_list|(
name|not
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testFoldMaybe
parameter_list|()
throws|throws
name|Exception
block|{
name|assertEquals
argument_list|(
literal|"(and leaf-1)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-1 leaf-2)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-1 leaf-2)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|and
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES_NO_NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|and
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES_NO_NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or leaf-1 (and leaf-2))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-1)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|and
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|constant
argument_list|(
name|TruthValue
operator|.
name|YES_NO_NULL
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-100)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|foldMaybe
argument_list|(
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|100
argument_list|)
argument_list|,
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|0
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|8
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|9
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|10
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|11
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|12
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|13
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|14
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|15
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|16
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|17
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testCNF
parameter_list|()
throws|throws
name|Exception
block|{
name|assertEquals
argument_list|(
literal|"leaf-1"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"NO"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|constant
argument_list|(
name|TruthValue
operator|.
name|NO
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(not leaf-1)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-1 leaf-2)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(or (not leaf-1) leaf-2)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|not
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and (or leaf-1 leaf-2) (not leaf-3))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|and
argument_list|(
name|or
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|not
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and (or leaf-1 leaf-3) (or leaf-2 leaf-3)"
operator|+
literal|" (or leaf-1 leaf-4) (or leaf-2 leaf-4))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and"
operator|+
literal|" (or leaf-1 leaf-5) (or leaf-2 leaf-5)"
operator|+
literal|" (or leaf-3 leaf-5) (or leaf-4 leaf-5)"
operator|+
literal|" (or leaf-1 leaf-6) (or leaf-2 leaf-6)"
operator|+
literal|" (or leaf-3 leaf-6) (or leaf-4 leaf-6))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and"
operator|+
literal|" (or leaf-5 leaf-6 (not leaf-7) leaf-1 leaf-3)"
operator|+
literal|" (or leaf-5 leaf-6 (not leaf-7) leaf-2 leaf-3)"
operator|+
literal|" (or leaf-5 leaf-6 (not leaf-7) leaf-1 leaf-4)"
operator|+
literal|" (or leaf-5 leaf-6 (not leaf-7) leaf-2 leaf-4))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|)
argument_list|,
name|or
argument_list|(
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|)
argument_list|,
name|not
argument_list|(
name|leaf
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and"
operator|+
literal|" (or leaf-8 leaf-0 leaf-3 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-1 leaf-3 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-2 leaf-3 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-0 leaf-4 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-1 leaf-4 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-2 leaf-4 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-0 leaf-5 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-1 leaf-5 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-2 leaf-5 leaf-6)"
operator|+
literal|" (or leaf-8 leaf-0 leaf-3 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-1 leaf-3 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-2 leaf-3 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-0 leaf-4 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-1 leaf-4 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-2 leaf-4 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-0 leaf-5 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-1 leaf-5 leaf-7)"
operator|+
literal|" (or leaf-8 leaf-2 leaf-5 leaf-7))"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|0
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|8
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"YES_NO_NULL"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|0
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|8
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|9
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|10
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|11
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|12
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|13
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|14
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|15
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|16
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|17
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertEquals
argument_list|(
literal|"(and leaf-100 YES_NO_NULL)"
argument_list|,
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|100
argument_list|)
argument_list|,
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|0
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|8
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|9
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|10
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|11
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|12
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|13
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|14
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|15
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|16
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|17
argument_list|)
argument_list|)
argument_list|)
argument_list|)
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|assertNoSharedNodes
argument_list|(
name|SearchArgumentImpl
operator|.
name|BuilderImpl
operator|.
name|convertToCNF
argument_list|(
name|or
argument_list|(
name|and
argument_list|(
name|leaf
argument_list|(
literal|0
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|1
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|2
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|3
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|4
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|5
argument_list|)
argument_list|)
argument_list|,
name|and
argument_list|(
name|leaf
argument_list|(
literal|6
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|7
argument_list|)
argument_list|)
argument_list|,
name|leaf
argument_list|(
literal|8
argument_list|)
argument_list|)
argument_list|)
argument_list|,
name|Sets
operator|.
expr|<
name|ExpressionTree
operator|>
name|newIdentityHashSet
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|private
specifier|static
name|void
name|assertNoSharedNodes
parameter_list|(
name|ExpressionTree
name|tree
parameter_list|,
name|Set
argument_list|<
name|ExpressionTree
argument_list|>
name|seen
parameter_list|)
throws|throws
name|Exception
block|{
if|if
condition|(
name|seen
operator|.
name|contains
argument_list|(
name|tree
argument_list|)
operator|&&
name|tree
operator|.
name|getOperator
argument_list|()
operator|!=
name|ExpressionTree
operator|.
name|Operator
operator|.
name|LEAF
condition|)
block|{
name|assertTrue
argument_list|(
literal|"repeated node in expression "
operator|+
name|tree
argument_list|,
literal|false
argument_list|)
expr_stmt|;
block|}
name|seen
operator|.
name|add
argument_list|(
name|tree
argument_list|)
expr_stmt|;
if|if
condition|(
name|tree
operator|.
name|getChildren
argument_list|()
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ExpressionTree
name|child
range|:
name|tree
operator|.
name|getChildren
argument_list|()
control|)
block|{
name|assertNoSharedNodes
argument_list|(
name|child
argument_list|,
name|seen
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
name|ExprNodeGenericFuncDesc
name|getFuncDesc
parameter_list|(
name|String
name|xmlSerialized
parameter_list|)
block|{
name|byte
index|[]
name|bytes
decl_stmt|;
try|try
block|{
name|bytes
operator|=
name|xmlSerialized
operator|.
name|getBytes
argument_list|(
literal|"UTF-8"
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|UnsupportedEncodingException
name|ex
parameter_list|)
block|{
throw|throw
operator|new
name|RuntimeException
argument_list|(
literal|"UTF-8 support required"
argument_list|,
name|ex
argument_list|)
throw|;
block|}
name|ByteArrayInputStream
name|bais
init|=
operator|new
name|ByteArrayInputStream
argument_list|(
name|bytes
argument_list|)
decl_stmt|;
name|XMLDecoder
name|decoder
init|=
operator|new
name|XMLDecoder
argument_list|(
name|bais
argument_list|,
literal|null
argument_list|,
literal|null
argument_list|)
decl_stmt|;
try|try
block|{
return|return
operator|(
name|ExprNodeGenericFuncDesc
operator|)
name|decoder
operator|.
name|readObject
argument_list|()
return|;
block|}
finally|finally
block|{
name|decoder
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
block|}
specifier|private
specifier|static
name|TruthValue
index|[]
name|values
parameter_list|(
name|TruthValue
modifier|...
name|vals
parameter_list|)
block|{
return|return
name|vals
return|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testBuilder
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|lessThan
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
literal|10
argument_list|)
operator|.
name|lessThanEquals
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
literal|"hi"
argument_list|)
operator|.
name|equals
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|FLOAT
argument_list|,
literal|1.0
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (LESS_THAN x 10)\n"
operator|+
literal|"leaf-1 = (LESS_THAN_EQUALS y hi)\n"
operator|+
literal|"leaf-2 = (EQUALS z 1.0)\n"
operator|+
literal|"expr = (and leaf-0 leaf-1 leaf-2)"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|sarg
operator|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startNot
argument_list|()
operator|.
name|startOr
argument_list|()
operator|.
name|isNull
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|)
operator|.
name|between
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
literal|10
argument_list|,
literal|20
argument_list|)
operator|.
name|in
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
operator|.
name|nullSafeEquals
argument_list|(
literal|"a"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
literal|"stinger"
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (IS_NULL x)\n"
operator|+
literal|"leaf-1 = (BETWEEN y 10 20)\n"
operator|+
literal|"leaf-2 = (IN z 1 2 3)\n"
operator|+
literal|"leaf-3 = (NULL_SAFE_EQUALS a stinger)\n"
operator|+
literal|"expr = (and (not leaf-0) (not leaf-1) (not leaf-2) (not leaf-3))"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testBuilderComplexTypes
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|lessThan
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|DATE
argument_list|,
name|Date
operator|.
name|valueOf
argument_list|(
literal|"1970-1-11"
argument_list|)
argument_list|)
operator|.
name|lessThanEquals
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
operator|new
name|HiveChar
argument_list|(
literal|"hi"
argument_list|,
literal|10
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|equals
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|DECIMAL
argument_list|,
operator|new
name|HiveDecimalWritable
argument_list|(
literal|"1.0"
argument_list|)
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (LESS_THAN x 1970-01-11)\n"
operator|+
literal|"leaf-1 = (LESS_THAN_EQUALS y hi        )\n"
operator|+
literal|"leaf-2 = (EQUALS z 1)\n"
operator|+
literal|"expr = (and leaf-0 leaf-1 leaf-2)"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|sarg
operator|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startNot
argument_list|()
operator|.
name|startOr
argument_list|()
operator|.
name|isNull
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|)
operator|.
name|between
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|DECIMAL
argument_list|,
operator|new
name|HiveDecimalWritable
argument_list|(
literal|"10"
argument_list|)
argument_list|,
operator|new
name|HiveDecimalWritable
argument_list|(
literal|"20.0"
argument_list|)
argument_list|)
operator|.
name|in
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
operator|.
name|nullSafeEquals
argument_list|(
literal|"a"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
operator|new
name|HiveVarchar
argument_list|(
literal|"stinger"
argument_list|,
literal|100
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (IS_NULL x)\n"
operator|+
literal|"leaf-1 = (BETWEEN y 10 20)\n"
operator|+
literal|"leaf-2 = (IN z 1 2 3)\n"
operator|+
literal|"leaf-3 = (NULL_SAFE_EQUALS a stinger)\n"
operator|+
literal|"expr = (and (not leaf-0) (not leaf-1) (not leaf-2) (not leaf-3))"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testBuilderComplexTypes2
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|lessThan
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|DATE
argument_list|,
name|Date
operator|.
name|valueOf
argument_list|(
literal|"2005-3-12"
argument_list|)
argument_list|)
operator|.
name|lessThanEquals
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
operator|new
name|HiveChar
argument_list|(
literal|"hi"
argument_list|,
literal|10
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|equals
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|DECIMAL
argument_list|,
operator|new
name|HiveDecimalWritable
argument_list|(
literal|"1.0"
argument_list|)
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (LESS_THAN x 2005-03-12)\n"
operator|+
literal|"leaf-1 = (LESS_THAN_EQUALS y hi        )\n"
operator|+
literal|"leaf-2 = (EQUALS z 1)\n"
operator|+
literal|"expr = (and leaf-0 leaf-1 leaf-2)"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|sarg
operator|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startNot
argument_list|()
operator|.
name|startOr
argument_list|()
operator|.
name|isNull
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|)
operator|.
name|between
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|DECIMAL
argument_list|,
operator|new
name|HiveDecimalWritable
argument_list|(
literal|"10"
argument_list|)
argument_list|,
operator|new
name|HiveDecimalWritable
argument_list|(
literal|"20.0"
argument_list|)
argument_list|)
operator|.
name|in
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
literal|1
argument_list|,
literal|2
argument_list|,
literal|3
argument_list|)
operator|.
name|nullSafeEquals
argument_list|(
literal|"a"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
operator|new
name|HiveVarchar
argument_list|(
literal|"stinger"
argument_list|,
literal|100
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
expr_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (IS_NULL x)\n"
operator|+
literal|"leaf-1 = (BETWEEN y 10 20)\n"
operator|+
literal|"leaf-2 = (IN z 1 2 3)\n"
operator|+
literal|"leaf-3 = (NULL_SAFE_EQUALS a stinger)\n"
operator|+
literal|"expr = (and (not leaf-0) (not leaf-1) (not leaf-2) (not leaf-3))"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testBuilderFloat
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|lessThan
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
operator|new
name|Integer
argument_list|(
operator|(
name|short
operator|)
literal|22
argument_list|)
argument_list|)
operator|.
name|lessThan
argument_list|(
literal|"x1"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
operator|new
name|Integer
argument_list|(
literal|22
argument_list|)
argument_list|)
operator|.
name|lessThanEquals
argument_list|(
literal|"y"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
operator|new
name|HiveChar
argument_list|(
literal|"hi"
argument_list|,
literal|10
argument_list|)
operator|.
name|toString
argument_list|()
argument_list|)
operator|.
name|equals
argument_list|(
literal|"z"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|FLOAT
argument_list|,
operator|new
name|Double
argument_list|(
literal|0.22
argument_list|)
argument_list|)
operator|.
name|equals
argument_list|(
literal|"z1"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|FLOAT
argument_list|,
operator|new
name|Double
argument_list|(
literal|0.22
argument_list|)
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
literal|"leaf-0 = (LESS_THAN x 22)\n"
operator|+
literal|"leaf-1 = (LESS_THAN x1 22)\n"
operator|+
literal|"leaf-2 = (LESS_THAN_EQUALS y hi        )\n"
operator|+
literal|"leaf-3 = (EQUALS z 0.22)\n"
operator|+
literal|"leaf-4 = (EQUALS z1 0.22)\n"
operator|+
literal|"expr = (and leaf-0 leaf-1 leaf-2 leaf-3 leaf-4)"
argument_list|,
name|sarg
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
specifier|public
name|void
name|testTimestampSerialization
parameter_list|()
throws|throws
name|Exception
block|{
comment|// There is a kryo which after serialize/deserialize,
comment|// Timestamp becomes Date. We get around this issue in
comment|// SearchArgumentImpl.getLiteral. Once kryo fixed the issue
comment|// We can simplify SearchArgumentImpl.getLiteral
name|Timestamp
name|now
init|=
operator|new
name|Timestamp
argument_list|(
operator|new
name|java
operator|.
name|util
operator|.
name|Date
argument_list|()
operator|.
name|getTime
argument_list|()
argument_list|)
decl_stmt|;
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|lessThan
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|TIMESTAMP
argument_list|,
name|now
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
name|String
name|serializedSarg
init|=
name|TestInputOutputFormat
operator|.
name|toKryo
argument_list|(
name|sarg
argument_list|)
decl_stmt|;
name|SearchArgument
name|sarg2
init|=
name|ConvertAstToSearchArg
operator|.
name|create
argument_list|(
name|serializedSarg
argument_list|)
decl_stmt|;
name|Field
name|literalField
init|=
name|PredicateLeafImpl
operator|.
name|class
operator|.
name|getDeclaredField
argument_list|(
literal|"literal"
argument_list|)
decl_stmt|;
name|literalField
operator|.
name|setAccessible
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|assertTrue
argument_list|(
name|literalField
operator|.
name|get
argument_list|(
name|sarg2
operator|.
name|getLeaves
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
operator|instanceof
name|java
operator|.
name|util
operator|.
name|Date
argument_list|)
expr_stmt|;
name|Timestamp
name|ts
init|=
operator|(
name|Timestamp
operator|)
name|sarg2
operator|.
name|getLeaves
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getLiteral
argument_list|()
decl_stmt|;
name|assertEquals
argument_list|(
name|ts
argument_list|,
name|now
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|IllegalArgumentException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|testBadLiteral
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|lessThan
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|INTEGER
argument_list|,
literal|"hi"
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
block|}
annotation|@
name|Test
argument_list|(
name|expected
operator|=
name|IllegalArgumentException
operator|.
name|class
argument_list|)
specifier|public
name|void
name|testBadLiteralList
parameter_list|()
throws|throws
name|Exception
block|{
name|SearchArgument
name|sarg
init|=
name|SearchArgumentFactory
operator|.
name|newBuilder
argument_list|()
operator|.
name|startAnd
argument_list|()
operator|.
name|in
argument_list|(
literal|"x"
argument_list|,
name|PredicateLeaf
operator|.
name|Type
operator|.
name|STRING
argument_list|,
literal|"hi"
argument_list|,
literal|23
argument_list|)
operator|.
name|end
argument_list|()
operator|.
name|build
argument_list|()
decl_stmt|;
block|}
block|}
end_class

end_unit

