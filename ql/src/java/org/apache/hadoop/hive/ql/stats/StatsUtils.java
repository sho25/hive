begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|stats
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|math
operator|.
name|BigDecimal
import|;
end_import

begin_import
import|import
name|java
operator|.
name|math
operator|.
name|BigInteger
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|ArrayList
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Collections
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashSet
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
operator|.
name|Entry
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Set
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Callable
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutionException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Future
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|atomic
operator|.
name|AtomicInteger
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Sets
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|FileSystem
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|fs
operator|.
name|Path
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|common
operator|.
name|StatsSetupConst
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|common
operator|.
name|type
operator|.
name|HiveDecimal
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|conf
operator|.
name|HiveConf
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|conf
operator|.
name|HiveConf
operator|.
name|ConfVars
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|AggrStats
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|ColumnStatisticsData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|ColumnStatisticsObj
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|metastore
operator|.
name|api
operator|.
name|Decimal
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|ColumnInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|FunctionRegistry
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|RowSchema
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|TableScanOperator
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|Utilities
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|metadata
operator|.
name|Hive
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|metadata
operator|.
name|HiveException
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|metadata
operator|.
name|Partition
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|metadata
operator|.
name|PartitionIterable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|metadata
operator|.
name|Table
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|parse
operator|.
name|ColumnStatsList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|parse
operator|.
name|PrunedPartitionList
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ColStatistics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ColStatistics
operator|.
name|Range
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeColumnDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeColumnListDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeConstantDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeFieldDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|ExprNodeGenericFuncDesc
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|Statistics
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|plan
operator|.
name|Statistics
operator|.
name|State
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|udf
operator|.
name|generic
operator|.
name|GenericUDF
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|udf
operator|.
name|generic
operator|.
name|GenericUDFBridge
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|udf
operator|.
name|generic
operator|.
name|NDV
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|util
operator|.
name|JavaDataModel
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde
operator|.
name|serdeConstants
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|ConstantObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|ObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|ObjectInspector
operator|.
name|Category
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StandardConstantListObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StandardConstantMapObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StandardConstantStructObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StandardListObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StandardMapObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StructField
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|StructObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|UnionObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|BinaryObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|HiveCharObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|HiveVarcharObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|StringObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableBinaryObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableBooleanObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableByteObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableDateObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableDoubleObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableFloatObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableHiveDecimalObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableIntObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableLongObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableShortObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableStringObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableTimestampObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|objectinspector
operator|.
name|primitive
operator|.
name|WritableTimestampLocalTZObjectInspector
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|typeinfo
operator|.
name|CharTypeInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|typeinfo
operator|.
name|PrimitiveTypeInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|typeinfo
operator|.
name|TypeInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|typeinfo
operator|.
name|TypeInfoUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|serde2
operator|.
name|typeinfo
operator|.
name|VarcharTypeInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|io
operator|.
name|BytesWritable
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hive
operator|.
name|common
operator|.
name|util
operator|.
name|AnnotationUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|tez
operator|.
name|mapreduce
operator|.
name|hadoop
operator|.
name|MRJobConfig
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|base
operator|.
name|Joiner
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|collect
operator|.
name|Lists
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|math
operator|.
name|LongMath
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadFactoryBuilder
import|;
end_import

begin_class
specifier|public
class|class
name|StatsUtils
block|{
specifier|private
specifier|static
specifier|final
name|Logger
name|LOG
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|StatsUtils
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
comment|/**    * Collect table, partition and column level statistics    * @param conf    *          - hive configuration    * @param partList    *          - partition list    * @param table    *          - table    * @param tableScanOperator    *          - table scan operator    * @return statistics object    * @throws HiveException    */
specifier|public
specifier|static
name|Statistics
name|collectStatistics
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|PrunedPartitionList
name|partList
parameter_list|,
name|ColumnStatsList
name|colStatsCache
parameter_list|,
name|Table
name|table
parameter_list|,
name|TableScanOperator
name|tableScanOperator
parameter_list|)
throws|throws
name|HiveException
block|{
comment|// column level statistics are required only for the columns that are needed
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
init|=
name|tableScanOperator
operator|.
name|getSchema
argument_list|()
operator|.
name|getSignature
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
init|=
name|tableScanOperator
operator|.
name|getNeededColumns
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|referencedColumns
init|=
name|tableScanOperator
operator|.
name|getReferencedColumns
argument_list|()
decl_stmt|;
return|return
name|collectStatistics
argument_list|(
name|conf
argument_list|,
name|partList
argument_list|,
name|table
argument_list|,
name|schema
argument_list|,
name|neededColumns
argument_list|,
name|colStatsCache
argument_list|,
name|referencedColumns
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|Statistics
name|collectStatistics
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|PrunedPartitionList
name|partList
parameter_list|,
name|Table
name|table
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|ColumnStatsList
name|colStatsCache
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|referencedColumns
parameter_list|)
throws|throws
name|HiveException
block|{
name|boolean
name|fetchColStats
init|=
name|HiveConf
operator|.
name|getBoolVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_FETCH_COLUMN_STATS
argument_list|)
decl_stmt|;
name|boolean
name|testMode
init|=
name|HiveConf
operator|.
name|getBoolVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_IN_TEST
argument_list|)
decl_stmt|;
return|return
name|collectStatistics
argument_list|(
name|conf
argument_list|,
name|partList
argument_list|,
name|table
argument_list|,
name|schema
argument_list|,
name|neededColumns
argument_list|,
name|colStatsCache
argument_list|,
name|referencedColumns
argument_list|,
name|fetchColStats
argument_list|,
name|testMode
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|long
name|getDataSize
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|Table
name|table
parameter_list|)
block|{
name|long
name|ds
init|=
name|getRawDataSize
argument_list|(
name|table
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|<=
literal|0
condition|)
block|{
name|ds
operator|=
name|getTotalSize
argument_list|(
name|table
argument_list|)
expr_stmt|;
comment|// if data size is still 0 then get file size
if|if
condition|(
name|ds
operator|<=
literal|0
condition|)
block|{
name|ds
operator|=
name|getFileSizeForTable
argument_list|(
name|conf
argument_list|,
name|table
argument_list|)
expr_stmt|;
block|}
name|float
name|deserFactor
init|=
name|HiveConf
operator|.
name|getFloatVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_DESERIALIZATION_FACTOR
argument_list|)
decl_stmt|;
name|ds
operator|=
call|(
name|long
call|)
argument_list|(
name|ds
operator|*
name|deserFactor
argument_list|)
expr_stmt|;
block|}
return|return
name|ds
return|;
block|}
comment|/**    * Returns number of rows if it exists. Otherwise it estimates number of rows    * based on estimated data size for both partition and non-partitioned table    * RelOptHiveTable's getRowCount uses this.    *    * @param conf    * @param schema    * @param table    * @return    */
specifier|public
specifier|static
name|long
name|getNumRows
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|Table
name|table
parameter_list|,
name|PrunedPartitionList
name|partitionList
parameter_list|,
name|AtomicInteger
name|noColsMissingStats
parameter_list|)
block|{
name|boolean
name|shouldEstimateStats
init|=
name|HiveConf
operator|.
name|getBoolVar
argument_list|(
name|conf
argument_list|,
name|ConfVars
operator|.
name|HIVE_STATS_ESTIMATE_STATS
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|table
operator|.
name|isPartitioned
argument_list|()
condition|)
block|{
comment|//get actual number of rows from metastore
name|long
name|nr
init|=
name|getNumRows
argument_list|(
name|table
argument_list|)
decl_stmt|;
comment|// log warning if row count is missing
if|if
condition|(
name|nr
operator|<=
literal|0
condition|)
block|{
name|noColsMissingStats
operator|.
name|getAndIncrement
argument_list|()
expr_stmt|;
block|}
comment|// if row count exists or stats aren't to be estimated return
comment|// whatever we have
if|if
condition|(
name|nr
operator|>
literal|0
operator|||
operator|!
name|shouldEstimateStats
condition|)
block|{
return|return
name|nr
return|;
block|}
comment|// go ahead with the estimation
name|long
name|ds
init|=
name|getDataSize
argument_list|(
name|conf
argument_list|,
name|table
argument_list|)
decl_stmt|;
return|return
name|getNumRows
argument_list|(
name|conf
argument_list|,
name|schema
argument_list|,
name|table
argument_list|,
name|ds
argument_list|)
return|;
block|}
else|else
block|{
comment|// partitioned table
name|long
name|nr
init|=
literal|0
decl_stmt|;
name|List
argument_list|<
name|Long
argument_list|>
name|rowCounts
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|rowCounts
operator|=
name|getBasicStatForPartitions
argument_list|(
name|table
argument_list|,
name|partitionList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|,
name|StatsSetupConst
operator|.
name|ROW_COUNT
argument_list|)
expr_stmt|;
name|nr
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|rowCounts
argument_list|)
expr_stmt|;
comment|// log warning if row count is missing
if|if
condition|(
name|nr
operator|<=
literal|0
condition|)
block|{
name|noColsMissingStats
operator|.
name|getAndIncrement
argument_list|()
expr_stmt|;
block|}
comment|// if row count exists or stats aren't to be estimated return
comment|// whatever we have
if|if
condition|(
name|nr
operator|>
literal|0
operator|||
operator|!
name|shouldEstimateStats
condition|)
block|{
return|return
name|nr
return|;
block|}
comment|// estimate row count
name|long
name|ds
init|=
literal|0
decl_stmt|;
name|List
argument_list|<
name|Long
argument_list|>
name|dataSizes
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|dataSizes
operator|=
name|getBasicStatForPartitions
argument_list|(
name|table
argument_list|,
name|partitionList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|,
name|StatsSetupConst
operator|.
name|RAW_DATA_SIZE
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
name|float
name|deserFactor
init|=
name|HiveConf
operator|.
name|getFloatVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_DESERIALIZATION_FACTOR
argument_list|)
decl_stmt|;
if|if
condition|(
name|ds
operator|<=
literal|0
condition|)
block|{
name|dataSizes
operator|=
name|getBasicStatForPartitions
argument_list|(
name|table
argument_list|,
name|partitionList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|,
name|StatsSetupConst
operator|.
name|TOTAL_SIZE
argument_list|)
expr_stmt|;
name|dataSizes
operator|=
name|safeMult
argument_list|(
name|dataSizes
argument_list|,
name|deserFactor
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
block|}
comment|// if data size still could not be determined, then fall back to filesytem to get file
comment|// sizes
if|if
condition|(
name|ds
operator|<=
literal|0
operator|&&
name|shouldEstimateStats
condition|)
block|{
name|dataSizes
operator|=
name|getFileSizeForPartitions
argument_list|(
name|conf
argument_list|,
name|partitionList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|)
expr_stmt|;
name|dataSizes
operator|=
name|safeMult
argument_list|(
name|dataSizes
argument_list|,
name|deserFactor
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
block|}
name|int
name|avgRowSize
init|=
name|estimateRowSizeFromSchema
argument_list|(
name|conf
argument_list|,
name|schema
argument_list|)
decl_stmt|;
if|if
condition|(
name|avgRowSize
operator|>
literal|0
condition|)
block|{
name|setUnknownRcDsToAverage
argument_list|(
name|rowCounts
argument_list|,
name|dataSizes
argument_list|,
name|avgRowSize
argument_list|)
expr_stmt|;
name|nr
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|rowCounts
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
comment|// number of rows -1 means that statistics from metastore is not reliable
if|if
condition|(
name|nr
operator|<=
literal|0
condition|)
block|{
name|nr
operator|=
name|ds
operator|/
name|avgRowSize
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nr
operator|==
literal|0
condition|)
block|{
name|nr
operator|=
literal|1
expr_stmt|;
block|}
return|return
name|nr
return|;
block|}
block|}
specifier|private
specifier|static
name|void
name|estimateStatsForMissingCols
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|columnStats
parameter_list|,
name|Table
name|table
parameter_list|,
name|HiveConf
name|conf
parameter_list|,
name|long
name|nr
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|)
block|{
name|Set
argument_list|<
name|String
argument_list|>
name|neededCols
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|(
name|neededColumns
argument_list|)
decl_stmt|;
name|Set
argument_list|<
name|String
argument_list|>
name|colsWithStats
init|=
operator|new
name|HashSet
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|ColStatistics
name|cstats
range|:
name|columnStats
control|)
block|{
name|colsWithStats
operator|.
name|add
argument_list|(
name|cstats
operator|.
name|getColumnName
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|List
argument_list|<
name|String
argument_list|>
name|missingColStats
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|(
name|Sets
operator|.
name|difference
argument_list|(
name|neededCols
argument_list|,
name|colsWithStats
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|missingColStats
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|estimatedColStats
init|=
name|estimateStats
argument_list|(
name|table
argument_list|,
name|schema
argument_list|,
name|missingColStats
argument_list|,
name|conf
argument_list|,
name|nr
argument_list|)
decl_stmt|;
for|for
control|(
name|ColStatistics
name|estColStats
range|:
name|estimatedColStats
control|)
block|{
name|columnStats
operator|.
name|add
argument_list|(
name|estColStats
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|private
specifier|static
name|long
name|getNumRows
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|Table
name|table
parameter_list|,
name|long
name|ds
parameter_list|)
block|{
name|long
name|nr
init|=
name|getNumRows
argument_list|(
name|table
argument_list|)
decl_stmt|;
comment|// number of rows -1 means that statistics from metastore is not reliable
comment|// and 0 means statistics gathering is disabled
comment|// estimate only if num rows is -1 since 0 could be actual number of rows
if|if
condition|(
name|nr
operator|<
literal|0
condition|)
block|{
name|int
name|avgRowSize
init|=
name|estimateRowSizeFromSchema
argument_list|(
name|conf
argument_list|,
name|schema
argument_list|)
decl_stmt|;
if|if
condition|(
name|avgRowSize
operator|>
literal|0
condition|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Estimated average row size: "
operator|+
name|avgRowSize
argument_list|)
expr_stmt|;
block|}
name|nr
operator|=
name|ds
operator|/
name|avgRowSize
expr_stmt|;
block|}
block|}
if|if
condition|(
name|nr
operator|==
literal|0
operator|||
name|nr
operator|==
operator|-
literal|1
condition|)
block|{
return|return
literal|1
return|;
block|}
return|return
name|nr
return|;
block|}
specifier|public
specifier|static
name|Statistics
name|collectStatistics
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|PrunedPartitionList
name|partList
parameter_list|,
name|Table
name|table
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|ColumnStatsList
name|colStatsCache
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|referencedColumns
parameter_list|,
name|boolean
name|fetchColStats
parameter_list|)
throws|throws
name|HiveException
block|{
return|return
name|collectStatistics
argument_list|(
name|conf
argument_list|,
name|partList
argument_list|,
name|table
argument_list|,
name|schema
argument_list|,
name|neededColumns
argument_list|,
name|colStatsCache
argument_list|,
name|referencedColumns
argument_list|,
name|fetchColStats
argument_list|,
literal|false
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|Statistics
name|collectStatistics
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|PrunedPartitionList
name|partList
parameter_list|,
name|Table
name|table
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|ColumnStatsList
name|colStatsCache
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|referencedColumns
parameter_list|,
name|boolean
name|fetchColStats
parameter_list|,
name|boolean
name|failIfCacheMiss
parameter_list|)
throws|throws
name|HiveException
block|{
name|Statistics
name|stats
init|=
literal|null
decl_stmt|;
name|float
name|deserFactor
init|=
name|HiveConf
operator|.
name|getFloatVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_DESERIALIZATION_FACTOR
argument_list|)
decl_stmt|;
name|boolean
name|shouldEstimateStats
init|=
name|HiveConf
operator|.
name|getBoolVar
argument_list|(
name|conf
argument_list|,
name|ConfVars
operator|.
name|HIVE_STATS_ESTIMATE_STATS
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|table
operator|.
name|isPartitioned
argument_list|()
condition|)
block|{
comment|//getDataSize tries to estimate stats if it doesn't exist using file size
comment|// we would like to avoid file system calls  if it too expensive
name|long
name|ds
init|=
name|shouldEstimateStats
condition|?
name|getDataSize
argument_list|(
name|conf
argument_list|,
name|table
argument_list|)
else|:
name|getRawDataSize
argument_list|(
name|table
argument_list|)
decl_stmt|;
name|long
name|nr
init|=
name|getNumRows
argument_list|(
name|conf
argument_list|,
name|schema
argument_list|,
name|table
argument_list|,
name|ds
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|colStats
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
if|if
condition|(
name|fetchColStats
condition|)
block|{
name|colStats
operator|=
name|getTableColumnStats
argument_list|(
name|table
argument_list|,
name|schema
argument_list|,
name|neededColumns
argument_list|,
name|colStatsCache
argument_list|)
expr_stmt|;
if|if
condition|(
name|colStats
operator|==
literal|null
condition|)
block|{
name|colStats
operator|=
name|Lists
operator|.
name|newArrayList
argument_list|()
expr_stmt|;
block|}
name|estimateStatsForMissingCols
argument_list|(
name|neededColumns
argument_list|,
name|colStats
argument_list|,
name|table
argument_list|,
name|conf
argument_list|,
name|nr
argument_list|,
name|schema
argument_list|)
expr_stmt|;
comment|// we should have stats for all columns (estimated or actual)
assert|assert
operator|(
name|neededColumns
operator|.
name|size
argument_list|()
operator|==
name|colStats
operator|.
name|size
argument_list|()
operator|)
assert|;
name|long
name|betterDS
init|=
name|getDataSizeFromColumnStats
argument_list|(
name|nr
argument_list|,
name|colStats
argument_list|)
decl_stmt|;
name|ds
operator|=
operator|(
name|betterDS
operator|<
literal|1
operator|||
name|colStats
operator|.
name|isEmpty
argument_list|()
operator|)
condition|?
name|ds
else|:
name|betterDS
expr_stmt|;
block|}
name|stats
operator|=
operator|new
name|Statistics
argument_list|(
name|nr
argument_list|,
name|ds
argument_list|)
expr_stmt|;
comment|// infer if any column can be primary key based on column statistics
name|inferAndSetPrimaryKey
argument_list|(
name|stats
operator|.
name|getNumRows
argument_list|()
argument_list|,
name|colStats
argument_list|)
expr_stmt|;
name|stats
operator|.
name|setColumnStatsState
argument_list|(
name|deriveStatType
argument_list|(
name|colStats
argument_list|,
name|neededColumns
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|.
name|addToColumnStats
argument_list|(
name|colStats
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|partList
operator|!=
literal|null
condition|)
block|{
comment|// For partitioned tables, get the size of all the partitions after pruning
comment|// the partitions that are not required
name|long
name|nr
init|=
literal|0
decl_stmt|;
name|long
name|ds
init|=
literal|0
decl_stmt|;
name|List
argument_list|<
name|Long
argument_list|>
name|rowCounts
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Long
argument_list|>
name|dataSizes
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|rowCounts
operator|=
name|getBasicStatForPartitions
argument_list|(
name|table
argument_list|,
name|partList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|,
name|StatsSetupConst
operator|.
name|ROW_COUNT
argument_list|)
expr_stmt|;
name|dataSizes
operator|=
name|getBasicStatForPartitions
argument_list|(
name|table
argument_list|,
name|partList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|,
name|StatsSetupConst
operator|.
name|RAW_DATA_SIZE
argument_list|)
expr_stmt|;
name|nr
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|rowCounts
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
if|if
condition|(
name|ds
operator|<=
literal|0
condition|)
block|{
name|dataSizes
operator|=
name|getBasicStatForPartitions
argument_list|(
name|table
argument_list|,
name|partList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|,
name|StatsSetupConst
operator|.
name|TOTAL_SIZE
argument_list|)
expr_stmt|;
name|dataSizes
operator|=
name|safeMult
argument_list|(
name|dataSizes
argument_list|,
name|deserFactor
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
block|}
comment|// if data size still could not be determined, then fall back to filesytem to get file
comment|// sizes
if|if
condition|(
name|ds
operator|<=
literal|0
operator|&&
name|shouldEstimateStats
condition|)
block|{
name|dataSizes
operator|=
name|getFileSizeForPartitions
argument_list|(
name|conf
argument_list|,
name|partList
operator|.
name|getNotDeniedPartns
argument_list|()
argument_list|)
expr_stmt|;
name|dataSizes
operator|=
name|safeMult
argument_list|(
name|dataSizes
argument_list|,
name|deserFactor
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
block|}
name|int
name|avgRowSize
init|=
name|estimateRowSizeFromSchema
argument_list|(
name|conf
argument_list|,
name|schema
argument_list|)
decl_stmt|;
if|if
condition|(
name|avgRowSize
operator|>
literal|0
condition|)
block|{
name|setUnknownRcDsToAverage
argument_list|(
name|rowCounts
argument_list|,
name|dataSizes
argument_list|,
name|avgRowSize
argument_list|)
expr_stmt|;
name|nr
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|rowCounts
argument_list|)
expr_stmt|;
name|ds
operator|=
name|getSumIgnoreNegatives
argument_list|(
name|dataSizes
argument_list|)
expr_stmt|;
comment|// number of rows -1 means that statistics from metastore is not reliable
if|if
condition|(
name|nr
operator|<=
literal|0
condition|)
block|{
name|nr
operator|=
name|ds
operator|/
name|avgRowSize
expr_stmt|;
block|}
block|}
comment|// Minimum values
if|if
condition|(
name|nr
operator|==
literal|0
condition|)
block|{
name|nr
operator|=
literal|1
expr_stmt|;
block|}
name|stats
operator|=
operator|new
name|Statistics
argument_list|(
name|nr
argument_list|,
name|ds
argument_list|)
expr_stmt|;
comment|// if at least a partition does not contain row count then mark basic stats state as PARTIAL
if|if
condition|(
name|containsNonPositives
argument_list|(
name|rowCounts
argument_list|)
operator|&&
name|stats
operator|.
name|getBasicStatsState
argument_list|()
operator|.
name|equals
argument_list|(
name|State
operator|.
name|COMPLETE
argument_list|)
condition|)
block|{
name|stats
operator|.
name|setBasicStatsState
argument_list|(
name|State
operator|.
name|PARTIAL
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|fetchColStats
condition|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|partitionCols
init|=
name|getPartitionColumns
argument_list|(
name|schema
argument_list|,
name|neededColumns
argument_list|,
name|referencedColumns
argument_list|)
decl_stmt|;
comment|// We will retrieve stats from the metastore only for columns that are not cached
name|List
argument_list|<
name|String
argument_list|>
name|neededColsToRetrieve
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|partitionColsToRetrieve
decl_stmt|;
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|columnStats
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
if|if
condition|(
name|colStatsCache
operator|!=
literal|null
condition|)
block|{
name|neededColsToRetrieve
operator|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|(
name|neededColumns
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|colName
range|:
name|neededColumns
control|)
block|{
name|ColStatistics
name|colStats
init|=
name|colStatsCache
operator|.
name|getColStats
argument_list|()
operator|.
name|get
argument_list|(
name|colName
argument_list|)
decl_stmt|;
if|if
condition|(
name|colStats
operator|==
literal|null
condition|)
block|{
name|neededColsToRetrieve
operator|.
name|add
argument_list|(
name|colName
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Stats for column "
operator|+
name|colName
operator|+
literal|" in table "
operator|+
name|table
operator|.
name|getCompleteName
argument_list|()
operator|+
literal|" could not be retrieved from cache"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|columnStats
operator|.
name|add
argument_list|(
name|colStats
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Stats for column "
operator|+
name|colName
operator|+
literal|" in table "
operator|+
name|table
operator|.
name|getCompleteName
argument_list|()
operator|+
literal|" retrieved from cache"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|partitionColsToRetrieve
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|partitionCols
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|colName
range|:
name|partitionCols
control|)
block|{
name|ColStatistics
name|colStats
init|=
name|colStatsCache
operator|.
name|getColStats
argument_list|()
operator|.
name|get
argument_list|(
name|colName
argument_list|)
decl_stmt|;
if|if
condition|(
name|colStats
operator|==
literal|null
condition|)
block|{
name|partitionColsToRetrieve
operator|.
name|add
argument_list|(
name|colName
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Stats for column "
operator|+
name|colName
operator|+
literal|" in table "
operator|+
name|table
operator|.
name|getCompleteName
argument_list|()
operator|+
literal|" could not be retrieved from cache"
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|columnStats
operator|.
name|add
argument_list|(
name|colStats
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Stats for column "
operator|+
name|colName
operator|+
literal|" in table "
operator|+
name|table
operator|.
name|getCompleteName
argument_list|()
operator|+
literal|" retrieved from cache"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
else|else
block|{
name|neededColsToRetrieve
operator|=
name|neededColumns
expr_stmt|;
name|partitionColsToRetrieve
operator|=
name|partitionCols
expr_stmt|;
block|}
comment|// List of partitions
name|List
argument_list|<
name|String
argument_list|>
name|partNames
init|=
operator|new
name|ArrayList
argument_list|<
name|String
argument_list|>
argument_list|(
name|partList
operator|.
name|getNotDeniedPartns
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|Partition
name|part
range|:
name|partList
operator|.
name|getNotDeniedPartns
argument_list|()
control|)
block|{
name|partNames
operator|.
name|add
argument_list|(
name|part
operator|.
name|getName
argument_list|()
argument_list|)
expr_stmt|;
block|}
name|AggrStats
name|aggrStats
init|=
literal|null
decl_stmt|;
comment|// We check the sizes of neededColumns and partNames here. If either
comment|// size is 0, aggrStats is null after several retries. Thus, we can
comment|// skip the step to connect to the metastore.
if|if
condition|(
name|neededColsToRetrieve
operator|.
name|size
argument_list|()
operator|>
literal|0
operator|&&
name|partNames
operator|.
name|size
argument_list|()
operator|>
literal|0
condition|)
block|{
name|aggrStats
operator|=
name|Hive
operator|.
name|get
argument_list|()
operator|.
name|getAggrColStatsFor
argument_list|(
name|table
operator|.
name|getDbName
argument_list|()
argument_list|,
name|table
operator|.
name|getTableName
argument_list|()
argument_list|,
name|neededColsToRetrieve
argument_list|,
name|partNames
argument_list|)
expr_stmt|;
block|}
name|boolean
name|statsRetrieved
init|=
name|aggrStats
operator|!=
literal|null
operator|&&
name|aggrStats
operator|.
name|getColStats
argument_list|()
operator|!=
literal|null
operator|&&
name|aggrStats
operator|.
name|getColStatsSize
argument_list|()
operator|!=
literal|0
decl_stmt|;
if|if
condition|(
name|neededColumns
operator|.
name|size
argument_list|()
operator|==
literal|0
operator|||
operator|(
name|neededColsToRetrieve
operator|.
name|size
argument_list|()
operator|>
literal|0
operator|&&
operator|!
name|statsRetrieved
operator|)
condition|)
block|{
name|estimateStatsForMissingCols
argument_list|(
name|neededColsToRetrieve
argument_list|,
name|columnStats
argument_list|,
name|table
argument_list|,
name|conf
argument_list|,
name|nr
argument_list|,
name|schema
argument_list|)
expr_stmt|;
comment|// There are some partitions with no state (or we didn't fetch any state).
comment|// Update the stats with empty list to reflect that in the
comment|// state/initialize structures.
comment|// add partition column stats
name|addPartitionColumnStats
argument_list|(
name|conf
argument_list|,
name|partitionColsToRetrieve
argument_list|,
name|schema
argument_list|,
name|table
argument_list|,
name|partList
argument_list|,
name|columnStats
argument_list|)
expr_stmt|;
comment|// FIXME: this add seems suspicious...10 lines below the value returned by this method used as betterDS
name|stats
operator|.
name|addToDataSize
argument_list|(
name|getDataSizeFromColumnStats
argument_list|(
name|nr
argument_list|,
name|columnStats
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|.
name|updateColumnStatsState
argument_list|(
name|deriveStatType
argument_list|(
name|columnStats
argument_list|,
name|referencedColumns
argument_list|)
argument_list|)
expr_stmt|;
name|stats
operator|.
name|addToColumnStats
argument_list|(
name|columnStats
argument_list|)
expr_stmt|;
block|}
else|else
block|{
if|if
condition|(
name|statsRetrieved
condition|)
block|{
name|columnStats
operator|.
name|addAll
argument_list|(
name|convertColStats
argument_list|(
name|aggrStats
operator|.
name|getColStats
argument_list|()
argument_list|,
name|table
operator|.
name|getTableName
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|int
name|colStatsAvailable
init|=
name|neededColumns
operator|.
name|size
argument_list|()
operator|+
name|partitionCols
operator|.
name|size
argument_list|()
operator|-
name|partitionColsToRetrieve
operator|.
name|size
argument_list|()
decl_stmt|;
if|if
condition|(
name|columnStats
operator|.
name|size
argument_list|()
operator|!=
name|colStatsAvailable
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Column stats requested for : {} columns. Able to retrieve for {} columns"
argument_list|,
name|columnStats
operator|.
name|size
argument_list|()
argument_list|,
name|colStatsAvailable
argument_list|)
expr_stmt|;
block|}
name|addPartitionColumnStats
argument_list|(
name|conf
argument_list|,
name|partitionColsToRetrieve
argument_list|,
name|schema
argument_list|,
name|table
argument_list|,
name|partList
argument_list|,
name|columnStats
argument_list|)
expr_stmt|;
name|long
name|betterDS
init|=
name|getDataSizeFromColumnStats
argument_list|(
name|nr
argument_list|,
name|columnStats
argument_list|)
decl_stmt|;
name|stats
operator|.
name|setDataSize
argument_list|(
operator|(
name|betterDS
operator|<
literal|1
operator|||
name|columnStats
operator|.
name|isEmpty
argument_list|()
operator|)
condition|?
name|ds
else|:
name|betterDS
argument_list|)
expr_stmt|;
comment|// infer if any column can be primary key based on column statistics
name|inferAndSetPrimaryKey
argument_list|(
name|stats
operator|.
name|getNumRows
argument_list|()
argument_list|,
name|columnStats
argument_list|)
expr_stmt|;
name|stats
operator|.
name|addToColumnStats
argument_list|(
name|columnStats
argument_list|)
expr_stmt|;
comment|// Infer column stats state
name|stats
operator|.
name|setColumnStatsState
argument_list|(
name|deriveStatType
argument_list|(
name|columnStats
argument_list|,
name|referencedColumns
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|neededColumns
operator|.
name|size
argument_list|()
operator|!=
name|neededColsToRetrieve
operator|.
name|size
argument_list|()
operator|||
name|partitionCols
operator|.
name|size
argument_list|()
operator|!=
name|partitionColsToRetrieve
operator|.
name|size
argument_list|()
condition|)
block|{
comment|// Include state for cached columns
name|stats
operator|.
name|updateColumnStatsState
argument_list|(
name|colStatsCache
operator|.
name|getState
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// Change if we could not retrieve for all partitions
if|if
condition|(
name|aggrStats
operator|!=
literal|null
operator|&&
name|aggrStats
operator|.
name|getPartsFound
argument_list|()
operator|!=
name|partNames
operator|.
name|size
argument_list|()
operator|&&
name|stats
operator|.
name|getColumnStatsState
argument_list|()
operator|!=
name|State
operator|.
name|NONE
condition|)
block|{
name|stats
operator|.
name|updateColumnStatsState
argument_list|(
name|State
operator|.
name|PARTIAL
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Column stats requested for : {} partitions. Able to retrieve for {} partitions"
argument_list|,
name|partNames
operator|.
name|size
argument_list|()
argument_list|,
name|aggrStats
operator|.
name|getPartsFound
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
if|if
condition|(
name|rowCounts
operator|.
name|size
argument_list|()
operator|==
literal|0
condition|)
block|{
comment|// all partitions are filtered by partition pruning
name|stats
operator|.
name|setBasicStatsState
argument_list|(
name|State
operator|.
name|COMPLETE
argument_list|)
expr_stmt|;
block|}
comment|// This block exists for debugging purposes: we want to check whether
comment|// the col stats cache is working properly and we are retrieving the
comment|// stats from metastore only once.
if|if
condition|(
name|colStatsCache
operator|!=
literal|null
operator|&&
name|failIfCacheMiss
operator|&&
name|stats
operator|.
name|getColumnStatsState
argument_list|()
operator|.
name|equals
argument_list|(
name|State
operator|.
name|COMPLETE
argument_list|)
operator|&&
operator|(
operator|!
name|neededColsToRetrieve
operator|.
name|isEmpty
argument_list|()
operator|||
operator|!
name|partitionColsToRetrieve
operator|.
name|isEmpty
argument_list|()
operator|)
condition|)
block|{
throw|throw
operator|new
name|HiveException
argument_list|(
literal|"Cache has been loaded in logical planning phase for all columns; "
operator|+
literal|"however, stats for column some columns could not be retrieved from it "
operator|+
literal|"(see messages above)"
argument_list|)
throw|;
block|}
block|}
block|}
return|return
name|stats
return|;
block|}
comment|/**    * Based on the provided column statistics and number of rows, this method infers if the column    * can be primary key. It checks if the difference between the min and max value is equal to    * number of rows specified.    * @param numRows - number of rows    * @param colStats - column statistics    */
specifier|public
specifier|static
name|void
name|inferAndSetPrimaryKey
parameter_list|(
name|long
name|numRows
parameter_list|,
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|colStats
parameter_list|)
block|{
if|if
condition|(
name|colStats
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ColStatistics
name|cs
range|:
name|colStats
control|)
block|{
if|if
condition|(
name|cs
operator|!=
literal|null
operator|&&
name|cs
operator|.
name|getCountDistint
argument_list|()
operator|>=
name|numRows
condition|)
block|{
name|cs
operator|.
name|setPrimaryKey
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|cs
operator|!=
literal|null
operator|&&
name|cs
operator|.
name|getRange
argument_list|()
operator|!=
literal|null
operator|&&
name|cs
operator|.
name|getRange
argument_list|()
operator|.
name|minValue
operator|!=
literal|null
operator|&&
name|cs
operator|.
name|getRange
argument_list|()
operator|.
name|maxValue
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|numRows
operator|==
operator|(
operator|(
name|cs
operator|.
name|getRange
argument_list|()
operator|.
name|maxValue
operator|.
name|longValue
argument_list|()
operator|-
name|cs
operator|.
name|getRange
argument_list|()
operator|.
name|minValue
operator|.
name|longValue
argument_list|()
operator|)
operator|+
literal|1
operator|)
condition|)
block|{
name|cs
operator|.
name|setPrimaryKey
argument_list|(
literal|true
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
block|}
comment|/**    * Infer foreign key relationship from given column statistics.    * @param csPK - column statistics of primary key    * @param csFK - column statistics of potential foreign key    * @return    */
specifier|public
specifier|static
name|boolean
name|inferForeignKey
parameter_list|(
name|ColStatistics
name|csPK
parameter_list|,
name|ColStatistics
name|csFK
parameter_list|)
block|{
if|if
condition|(
name|csPK
operator|!=
literal|null
operator|&&
name|csFK
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|csPK
operator|.
name|isPrimaryKey
argument_list|()
condition|)
block|{
if|if
condition|(
name|csPK
operator|.
name|getRange
argument_list|()
operator|!=
literal|null
operator|&&
name|csFK
operator|.
name|getRange
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|ColStatistics
operator|.
name|Range
name|pkRange
init|=
name|csPK
operator|.
name|getRange
argument_list|()
decl_stmt|;
name|ColStatistics
operator|.
name|Range
name|fkRange
init|=
name|csFK
operator|.
name|getRange
argument_list|()
decl_stmt|;
return|return
name|isWithin
argument_list|(
name|fkRange
argument_list|,
name|pkRange
argument_list|)
return|;
block|}
block|}
block|}
return|return
literal|false
return|;
block|}
comment|/**    * Scale selectivity based on key range ratio.    * @param csPK - column statistics of primary key    * @param csFK - column statistics of potential foreign key    * @return    */
specifier|public
specifier|static
name|float
name|getScaledSelectivity
parameter_list|(
name|ColStatistics
name|csPK
parameter_list|,
name|ColStatistics
name|csFK
parameter_list|)
block|{
name|float
name|scaledSelectivity
init|=
literal|1.0f
decl_stmt|;
if|if
condition|(
name|csPK
operator|!=
literal|null
operator|&&
name|csFK
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|csPK
operator|.
name|isPrimaryKey
argument_list|()
condition|)
block|{
comment|// Use Max-Min Range as NDV gets scaled by selectivity.
if|if
condition|(
name|csPK
operator|.
name|getRange
argument_list|()
operator|!=
literal|null
operator|&&
name|csFK
operator|.
name|getRange
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|long
name|pkRangeDelta
init|=
name|getRangeDelta
argument_list|(
name|csPK
operator|.
name|getRange
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|fkRangeDelta
init|=
name|getRangeDelta
argument_list|(
name|csFK
operator|.
name|getRange
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|fkRangeDelta
operator|>
literal|0
operator|&&
name|pkRangeDelta
operator|>
literal|0
operator|&&
name|fkRangeDelta
operator|<
name|pkRangeDelta
condition|)
block|{
name|scaledSelectivity
operator|=
operator|(
name|float
operator|)
name|pkRangeDelta
operator|/
operator|(
name|float
operator|)
name|fkRangeDelta
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|scaledSelectivity
return|;
block|}
specifier|public
specifier|static
name|long
name|getRangeDelta
parameter_list|(
name|ColStatistics
operator|.
name|Range
name|range
parameter_list|)
block|{
if|if
condition|(
name|range
operator|.
name|minValue
operator|!=
literal|null
operator|&&
name|range
operator|.
name|maxValue
operator|!=
literal|null
condition|)
block|{
return|return
operator|(
name|range
operator|.
name|maxValue
operator|.
name|longValue
argument_list|()
operator|-
name|range
operator|.
name|minValue
operator|.
name|longValue
argument_list|()
operator|)
return|;
block|}
return|return
literal|0
return|;
block|}
specifier|private
specifier|static
name|boolean
name|isWithin
parameter_list|(
name|ColStatistics
operator|.
name|Range
name|range1
parameter_list|,
name|ColStatistics
operator|.
name|Range
name|range2
parameter_list|)
block|{
if|if
condition|(
name|range1
operator|.
name|minValue
operator|!=
literal|null
operator|&&
name|range2
operator|.
name|minValue
operator|!=
literal|null
operator|&&
name|range1
operator|.
name|maxValue
operator|!=
literal|null
operator|&&
name|range2
operator|.
name|maxValue
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|range1
operator|.
name|minValue
operator|.
name|longValue
argument_list|()
operator|>=
name|range2
operator|.
name|minValue
operator|.
name|longValue
argument_list|()
operator|&&
name|range1
operator|.
name|maxValue
operator|.
name|longValue
argument_list|()
operator|<=
name|range2
operator|.
name|maxValue
operator|.
name|longValue
argument_list|()
condition|)
block|{
return|return
literal|true
return|;
block|}
block|}
return|return
literal|false
return|;
block|}
specifier|private
specifier|static
name|void
name|addPartitionColumnStats
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|partitionCols
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|Table
name|table
parameter_list|,
name|PrunedPartitionList
name|partList
parameter_list|,
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|colStats
parameter_list|)
throws|throws
name|HiveException
block|{
for|for
control|(
name|String
name|col
range|:
name|partitionCols
control|)
block|{
for|for
control|(
name|ColumnInfo
name|ci
range|:
name|schema
control|)
block|{
comment|// conditions for being partition column
if|if
condition|(
name|col
operator|.
name|equals
argument_list|(
name|ci
operator|.
name|getInternalName
argument_list|()
argument_list|)
condition|)
block|{
name|colStats
operator|.
name|add
argument_list|(
name|getColStatsForPartCol
argument_list|(
name|ci
argument_list|,
operator|new
name|PartitionIterable
argument_list|(
name|partList
operator|.
name|getPartitions
argument_list|()
argument_list|)
argument_list|,
name|conf
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
specifier|private
specifier|static
name|List
argument_list|<
name|String
argument_list|>
name|getPartitionColumns
parameter_list|(
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|referencedColumns
parameter_list|)
block|{
comment|// extra columns is difference between referenced columns vs needed
comment|// columns. The difference could be partition columns.
name|List
argument_list|<
name|String
argument_list|>
name|partitionCols
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|referencedColumns
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
name|List
argument_list|<
name|String
argument_list|>
name|extraCols
init|=
name|Lists
operator|.
name|newArrayList
argument_list|(
name|referencedColumns
argument_list|)
decl_stmt|;
if|if
condition|(
name|referencedColumns
operator|.
name|size
argument_list|()
operator|>
name|neededColumns
operator|.
name|size
argument_list|()
condition|)
block|{
name|extraCols
operator|.
name|removeAll
argument_list|(
name|neededColumns
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|col
range|:
name|extraCols
control|)
block|{
for|for
control|(
name|ColumnInfo
name|ci
range|:
name|schema
control|)
block|{
comment|// conditions for being partition column
if|if
condition|(
name|col
operator|.
name|equals
argument_list|(
name|ci
operator|.
name|getInternalName
argument_list|()
argument_list|)
operator|&&
name|ci
operator|.
name|getIsVirtualCol
argument_list|()
operator|&&
operator|!
name|ci
operator|.
name|isHiddenVirtualCol
argument_list|()
condition|)
block|{
name|partitionCols
operator|.
name|add
argument_list|(
name|col
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|partitionCols
return|;
block|}
specifier|public
specifier|static
name|ColStatistics
name|getColStatsForPartCol
parameter_list|(
name|ColumnInfo
name|ci
parameter_list|,
name|PartitionIterable
name|partList
parameter_list|,
name|HiveConf
name|conf
parameter_list|)
block|{
comment|// currently metastore does not store column stats for
comment|// partition column, so we calculate the NDV from partition list
name|ColStatistics
name|partCS
init|=
operator|new
name|ColStatistics
argument_list|(
name|ci
operator|.
name|getInternalName
argument_list|()
argument_list|,
name|ci
operator|.
name|getType
argument_list|()
operator|.
name|getTypeName
argument_list|()
argument_list|)
decl_stmt|;
name|long
name|numPartitions
init|=
name|getNDVPartitionColumn
argument_list|(
name|partList
argument_list|,
name|ci
operator|.
name|getInternalName
argument_list|()
argument_list|)
decl_stmt|;
name|partCS
operator|.
name|setCountDistint
argument_list|(
name|numPartitions
argument_list|)
expr_stmt|;
name|partCS
operator|.
name|setAvgColLen
argument_list|(
name|StatsUtils
operator|.
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|ci
operator|.
name|getObjectInspector
argument_list|()
argument_list|,
name|partCS
operator|.
name|getColumnType
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
name|partCS
operator|.
name|setRange
argument_list|(
name|getRangePartitionColumn
argument_list|(
name|partList
argument_list|,
name|ci
operator|.
name|getInternalName
argument_list|()
argument_list|,
name|ci
operator|.
name|getType
argument_list|()
operator|.
name|getTypeName
argument_list|()
argument_list|,
name|conf
operator|.
name|getVar
argument_list|(
name|ConfVars
operator|.
name|DEFAULTPARTITIONNAME
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|partCS
return|;
block|}
specifier|public
specifier|static
name|int
name|getNDVPartitionColumn
parameter_list|(
name|PartitionIterable
name|partitions
parameter_list|,
name|String
name|partColName
parameter_list|)
block|{
name|Set
argument_list|<
name|String
argument_list|>
name|distinctVals
init|=
operator|new
name|HashSet
argument_list|<
name|String
argument_list|>
argument_list|()
decl_stmt|;
for|for
control|(
name|Partition
name|partition
range|:
name|partitions
control|)
block|{
name|distinctVals
operator|.
name|add
argument_list|(
name|partition
operator|.
name|getSpec
argument_list|()
operator|.
name|get
argument_list|(
name|partColName
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|distinctVals
operator|.
name|size
argument_list|()
return|;
block|}
specifier|private
specifier|static
name|Range
name|getRangePartitionColumn
parameter_list|(
name|PartitionIterable
name|partitions
parameter_list|,
name|String
name|partColName
parameter_list|,
name|String
name|colType
parameter_list|,
name|String
name|defaultPartName
parameter_list|)
block|{
name|Range
name|range
init|=
literal|null
decl_stmt|;
name|String
name|partVal
decl_stmt|;
name|String
name|colTypeLowerCase
init|=
name|colType
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TINYINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|SMALLINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BIGINT_TYPE_NAME
argument_list|)
condition|)
block|{
name|long
name|min
init|=
name|Long
operator|.
name|MAX_VALUE
decl_stmt|;
name|long
name|max
init|=
name|Long
operator|.
name|MIN_VALUE
decl_stmt|;
for|for
control|(
name|Partition
name|partition
range|:
name|partitions
control|)
block|{
name|partVal
operator|=
name|partition
operator|.
name|getSpec
argument_list|()
operator|.
name|get
argument_list|(
name|partColName
argument_list|)
expr_stmt|;
if|if
condition|(
name|partVal
operator|.
name|equals
argument_list|(
name|defaultPartName
argument_list|)
condition|)
block|{
comment|// partition column value is null.
continue|continue;
block|}
else|else
block|{
name|long
name|value
init|=
name|Long
operator|.
name|parseLong
argument_list|(
name|partVal
argument_list|)
decl_stmt|;
name|min
operator|=
name|Math
operator|.
name|min
argument_list|(
name|min
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|max
operator|=
name|Math
operator|.
name|max
argument_list|(
name|max
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
name|range
operator|=
operator|new
name|Range
argument_list|(
name|min
argument_list|,
name|max
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|FLOAT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DOUBLE_TYPE_NAME
argument_list|)
condition|)
block|{
name|double
name|min
init|=
name|Double
operator|.
name|MAX_VALUE
decl_stmt|;
name|double
name|max
init|=
name|Double
operator|.
name|MIN_VALUE
decl_stmt|;
for|for
control|(
name|Partition
name|partition
range|:
name|partitions
control|)
block|{
name|partVal
operator|=
name|partition
operator|.
name|getSpec
argument_list|()
operator|.
name|get
argument_list|(
name|partColName
argument_list|)
expr_stmt|;
if|if
condition|(
name|partVal
operator|.
name|equals
argument_list|(
name|defaultPartName
argument_list|)
condition|)
block|{
comment|// partition column value is null.
continue|continue;
block|}
else|else
block|{
name|double
name|value
init|=
name|Double
operator|.
name|parseDouble
argument_list|(
name|partVal
argument_list|)
decl_stmt|;
name|min
operator|=
name|Math
operator|.
name|min
argument_list|(
name|min
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|max
operator|=
name|Math
operator|.
name|max
argument_list|(
name|max
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
name|range
operator|=
operator|new
name|Range
argument_list|(
name|min
argument_list|,
name|max
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|DECIMAL_TYPE_NAME
argument_list|)
condition|)
block|{
name|double
name|min
init|=
name|Double
operator|.
name|MAX_VALUE
decl_stmt|;
name|double
name|max
init|=
name|Double
operator|.
name|MIN_VALUE
decl_stmt|;
for|for
control|(
name|Partition
name|partition
range|:
name|partitions
control|)
block|{
name|partVal
operator|=
name|partition
operator|.
name|getSpec
argument_list|()
operator|.
name|get
argument_list|(
name|partColName
argument_list|)
expr_stmt|;
if|if
condition|(
name|partVal
operator|.
name|equals
argument_list|(
name|defaultPartName
argument_list|)
condition|)
block|{
comment|// partition column value is null.
continue|continue;
block|}
else|else
block|{
name|double
name|value
init|=
operator|new
name|BigDecimal
argument_list|(
name|partVal
argument_list|)
operator|.
name|doubleValue
argument_list|()
decl_stmt|;
name|min
operator|=
name|Math
operator|.
name|min
argument_list|(
name|min
argument_list|,
name|value
argument_list|)
expr_stmt|;
name|max
operator|=
name|Math
operator|.
name|max
argument_list|(
name|max
argument_list|,
name|value
argument_list|)
expr_stmt|;
block|}
block|}
name|range
operator|=
operator|new
name|Range
argument_list|(
name|min
argument_list|,
name|max
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Columns statistics for complex datatypes are not supported yet
return|return
literal|null
return|;
block|}
return|return
name|range
return|;
block|}
specifier|private
specifier|static
name|void
name|setUnknownRcDsToAverage
parameter_list|(
name|List
argument_list|<
name|Long
argument_list|>
name|rowCounts
parameter_list|,
name|List
argument_list|<
name|Long
argument_list|>
name|dataSizes
parameter_list|,
name|int
name|avgRowSize
parameter_list|)
block|{
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Estimated average row size: "
operator|+
name|avgRowSize
argument_list|)
expr_stmt|;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|rowCounts
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|long
name|rc
init|=
name|rowCounts
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
name|long
name|s
init|=
name|dataSizes
operator|.
name|get
argument_list|(
name|i
argument_list|)
decl_stmt|;
if|if
condition|(
name|rc
operator|<=
literal|0
operator|&&
name|s
operator|>
literal|0
condition|)
block|{
name|rc
operator|=
name|s
operator|/
name|avgRowSize
expr_stmt|;
name|rowCounts
operator|.
name|set
argument_list|(
name|i
argument_list|,
name|rc
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|s
operator|<=
literal|0
operator|&&
name|rc
operator|>
literal|0
condition|)
block|{
name|s
operator|=
name|safeMult
argument_list|(
name|rc
argument_list|,
name|avgRowSize
argument_list|)
expr_stmt|;
name|dataSizes
operator|.
name|set
argument_list|(
name|i
argument_list|,
name|s
argument_list|)
expr_stmt|;
block|}
block|}
block|}
specifier|public
specifier|static
name|int
name|estimateRowSizeFromSchema
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|ColumnInfo
name|ci
range|:
name|schema
control|)
block|{
name|neededColumns
operator|.
name|add
argument_list|(
name|ci
operator|.
name|getInternalName
argument_list|()
argument_list|)
expr_stmt|;
block|}
return|return
name|estimateRowSizeFromSchema
argument_list|(
name|conf
argument_list|,
name|schema
argument_list|,
name|neededColumns
argument_list|)
return|;
block|}
specifier|public
specifier|static
name|int
name|estimateRowSizeFromSchema
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|)
block|{
name|int
name|avgRowSize
init|=
literal|0
decl_stmt|;
for|for
control|(
name|String
name|neededCol
range|:
name|neededColumns
control|)
block|{
name|ColumnInfo
name|ci
init|=
name|getColumnInfoForColumn
argument_list|(
name|neededCol
argument_list|,
name|schema
argument_list|)
decl_stmt|;
if|if
condition|(
name|ci
operator|==
literal|null
condition|)
block|{
comment|// No need to collect statistics of index columns
continue|continue;
block|}
name|ObjectInspector
name|oi
init|=
name|ci
operator|.
name|getObjectInspector
argument_list|()
decl_stmt|;
name|String
name|colTypeLowerCase
init|=
name|ci
operator|.
name|getTypeName
argument_list|()
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|LIST_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|MAP_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|STRUCT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|UNION_TYPE_NAME
argument_list|)
condition|)
block|{
name|avgRowSize
operator|+=
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|oi
argument_list|,
name|colTypeLowerCase
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|avgRowSize
operator|+=
name|getAvgColLenOfFixedLengthTypes
argument_list|(
name|colTypeLowerCase
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|avgRowSize
return|;
block|}
specifier|private
specifier|static
name|ColumnInfo
name|getColumnInfoForColumn
parameter_list|(
name|String
name|neededCol
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|)
block|{
for|for
control|(
name|ColumnInfo
name|ci
range|:
name|schema
control|)
block|{
if|if
condition|(
name|ci
operator|.
name|getInternalName
argument_list|()
operator|.
name|equalsIgnoreCase
argument_list|(
name|neededCol
argument_list|)
condition|)
block|{
return|return
name|ci
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
comment|/**    * Find the bytes on disk occupied by a table    * @param conf    *          - hive conf    * @param table    *          - table    * @return size on disk    */
specifier|public
specifier|static
name|long
name|getFileSizeForTable
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|Table
name|table
parameter_list|)
block|{
name|Path
name|path
init|=
name|table
operator|.
name|getPath
argument_list|()
decl_stmt|;
name|long
name|size
init|=
literal|0
decl_stmt|;
try|try
block|{
name|FileSystem
name|fs
init|=
name|path
operator|.
name|getFileSystem
argument_list|(
name|conf
argument_list|)
decl_stmt|;
name|size
operator|=
name|fs
operator|.
name|getContentSummary
argument_list|(
name|path
argument_list|)
operator|.
name|getLength
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|size
operator|=
literal|0
expr_stmt|;
block|}
return|return
name|size
return|;
block|}
comment|/**    * Find the bytes on disks occupied by list of partitions    * @param conf    *          - hive conf    * @param parts    *          - partition list    * @return sizes of partitions    */
specifier|public
specifier|static
name|List
argument_list|<
name|Long
argument_list|>
name|getFileSizeForPartitions
parameter_list|(
specifier|final
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|Partition
argument_list|>
name|parts
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Number of partitions : "
operator|+
name|parts
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
name|ArrayList
argument_list|<
name|Future
argument_list|<
name|Long
argument_list|>
argument_list|>
name|futures
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
name|int
name|threads
init|=
name|Math
operator|.
name|max
argument_list|(
literal|1
argument_list|,
name|conf
operator|.
name|getIntVar
argument_list|(
name|ConfVars
operator|.
name|METASTORE_FS_HANDLER_THREADS_COUNT
argument_list|)
argument_list|)
decl_stmt|;
specifier|final
name|ExecutorService
name|pool
init|=
name|Executors
operator|.
name|newFixedThreadPool
argument_list|(
name|threads
argument_list|,
operator|new
name|ThreadFactoryBuilder
argument_list|()
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
operator|.
name|setNameFormat
argument_list|(
literal|"Get-Partitions-Size-%d"
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
decl_stmt|;
specifier|final
name|ArrayList
argument_list|<
name|Long
argument_list|>
name|sizes
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|parts
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
specifier|final
name|Partition
name|part
range|:
name|parts
control|)
block|{
specifier|final
name|Path
name|path
init|=
name|part
operator|.
name|getDataLocation
argument_list|()
decl_stmt|;
name|futures
operator|.
name|add
argument_list|(
name|pool
operator|.
name|submit
argument_list|(
operator|new
name|Callable
argument_list|<
name|Long
argument_list|>
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|Long
name|call
parameter_list|()
throws|throws
name|Exception
block|{
try|try
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Partition path : "
operator|+
name|path
argument_list|)
expr_stmt|;
name|FileSystem
name|fs
init|=
name|path
operator|.
name|getFileSystem
argument_list|(
name|conf
argument_list|)
decl_stmt|;
return|return
name|fs
operator|.
name|getContentSummary
argument_list|(
name|path
argument_list|)
operator|.
name|getLength
argument_list|()
return|;
block|}
catch|catch
parameter_list|(
name|IOException
name|e
parameter_list|)
block|{
return|return
literal|0L
return|;
block|}
block|}
block|}
argument_list|)
argument_list|)
expr_stmt|;
block|}
try|try
block|{
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|futures
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|sizes
operator|.
name|add
argument_list|(
name|i
argument_list|,
name|futures
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|get
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
catch|catch
parameter_list|(
name|InterruptedException
decl||
name|ExecutionException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
literal|"Exception in processing files "
argument_list|,
name|e
argument_list|)
expr_stmt|;
block|}
finally|finally
block|{
name|pool
operator|.
name|shutdownNow
argument_list|()
expr_stmt|;
block|}
return|return
name|sizes
return|;
block|}
specifier|private
specifier|static
name|boolean
name|containsNonPositives
parameter_list|(
name|List
argument_list|<
name|Long
argument_list|>
name|vals
parameter_list|)
block|{
for|for
control|(
name|Long
name|val
range|:
name|vals
control|)
block|{
if|if
condition|(
name|val
operator|<=
literal|0L
condition|)
block|{
return|return
literal|true
return|;
block|}
block|}
return|return
literal|false
return|;
block|}
comment|/**    * Get sum of all values in the list that are>0    * @param vals    *          - list of values    * @return sum    */
specifier|public
specifier|static
name|long
name|getSumIgnoreNegatives
parameter_list|(
name|List
argument_list|<
name|Long
argument_list|>
name|vals
parameter_list|)
block|{
name|long
name|result
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Long
name|l
range|:
name|vals
control|)
block|{
if|if
condition|(
name|l
operator|>
literal|0
condition|)
block|{
name|result
operator|=
name|safeAdd
argument_list|(
name|result
argument_list|,
name|l
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
specifier|private
specifier|static
name|Statistics
operator|.
name|State
name|deriveStatType
parameter_list|(
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|colStats
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|)
block|{
name|boolean
name|hasStats
init|=
literal|false
decl_stmt|,
name|hasNull
init|=
operator|(
name|colStats
operator|==
literal|null
operator|)
operator|||
operator|(
name|colStats
operator|.
name|size
argument_list|()
operator|<
name|neededColumns
operator|.
name|size
argument_list|()
operator|)
decl_stmt|;
if|if
condition|(
name|colStats
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ColStatistics
name|cs
range|:
name|colStats
control|)
block|{
comment|// either colstats is null or is estimated
name|boolean
name|isNull
init|=
operator|(
name|cs
operator|==
literal|null
operator|)
condition|?
literal|true
else|:
operator|(
name|cs
operator|.
name|isEstimated
argument_list|()
operator|)
decl_stmt|;
name|hasStats
operator||=
operator|!
name|isNull
expr_stmt|;
name|hasNull
operator||=
name|isNull
expr_stmt|;
if|if
condition|(
name|hasNull
operator|&&
name|hasStats
condition|)
block|{
break|break;
block|}
block|}
block|}
name|State
name|result
init|=
operator|(
name|hasStats
condition|?
operator|(
name|hasNull
condition|?
name|Statistics
operator|.
name|State
operator|.
name|PARTIAL
else|:
name|Statistics
operator|.
name|State
operator|.
name|COMPLETE
operator|)
else|:
operator|(
name|neededColumns
operator|.
name|isEmpty
argument_list|()
condition|?
name|Statistics
operator|.
name|State
operator|.
name|COMPLETE
else|:
name|Statistics
operator|.
name|State
operator|.
name|NONE
operator|)
operator|)
decl_stmt|;
return|return
name|result
return|;
block|}
comment|/**    * Convert ColumnStatisticsObj to ColStatistics    * @param cso    *          - ColumnStatisticsObj    * @param tabName    *          - table name    * @param colName    *          - column name    * @return ColStatistics    */
specifier|public
specifier|static
name|ColStatistics
name|getColStatistics
parameter_list|(
name|ColumnStatisticsObj
name|cso
parameter_list|,
name|String
name|tabName
parameter_list|,
name|String
name|colName
parameter_list|)
block|{
name|String
name|colTypeLowerCase
init|=
name|cso
operator|.
name|getColType
argument_list|()
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
name|ColStatistics
name|cs
init|=
operator|new
name|ColStatistics
argument_list|(
name|colName
argument_list|,
name|colTypeLowerCase
argument_list|)
decl_stmt|;
name|ColumnStatisticsData
name|csd
init|=
name|cso
operator|.
name|getStatsData
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TINYINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|SMALLINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getNumDVs
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
argument_list|,
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BIGINT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getNumDVs
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
argument_list|,
name|csd
operator|.
name|getLongStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|FLOAT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getNumDVs
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
argument_list|,
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DOUBLE_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getNumDVs
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
argument_list|,
name|csd
operator|.
name|getDoubleStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
name|csd
operator|.
name|getStringStats
argument_list|()
operator|.
name|getNumDVs
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getStringStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|csd
operator|.
name|getStringStats
argument_list|()
operator|.
name|getAvgColLen
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BOOLEAN_TYPE_NAME
argument_list|)
condition|)
block|{
if|if
condition|(
name|csd
operator|.
name|getBooleanStats
argument_list|()
operator|.
name|getNumFalses
argument_list|()
operator|>
literal|0
operator|&&
name|csd
operator|.
name|getBooleanStats
argument_list|()
operator|.
name|getNumTrues
argument_list|()
operator|>
literal|0
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
literal|2
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
literal|1
argument_list|)
expr_stmt|;
block|}
name|cs
operator|.
name|setNumTrues
argument_list|(
name|csd
operator|.
name|getBooleanStats
argument_list|()
operator|.
name|getNumTrues
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumFalses
argument_list|(
name|csd
operator|.
name|getBooleanStats
argument_list|()
operator|.
name|getNumFalses
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getBooleanStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|csd
operator|.
name|getBinaryStats
argument_list|()
operator|.
name|getAvgColLen
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getBinaryStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMP_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMPLOCALTZ_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfTimestamp
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|DECIMAL_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDecimal
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setCountDistint
argument_list|(
name|csd
operator|.
name|getDecimalStats
argument_list|()
operator|.
name|getNumDVs
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getDecimalStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|Decimal
name|highValue
init|=
name|csd
operator|.
name|getDecimalStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
decl_stmt|;
name|Decimal
name|lowValue
init|=
name|csd
operator|.
name|getDecimalStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|highValue
operator|!=
literal|null
operator|&&
name|highValue
operator|.
name|getUnscaled
argument_list|()
operator|!=
literal|null
operator|&&
name|lowValue
operator|!=
literal|null
operator|&&
name|lowValue
operator|.
name|getUnscaled
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|HiveDecimal
name|maxHiveDec
init|=
name|HiveDecimal
operator|.
name|create
argument_list|(
operator|new
name|BigInteger
argument_list|(
name|highValue
operator|.
name|getUnscaled
argument_list|()
argument_list|)
argument_list|,
name|highValue
operator|.
name|getScale
argument_list|()
argument_list|)
decl_stmt|;
name|BigDecimal
name|maxVal
init|=
name|maxHiveDec
operator|==
literal|null
condition|?
literal|null
else|:
name|maxHiveDec
operator|.
name|bigDecimalValue
argument_list|()
decl_stmt|;
name|HiveDecimal
name|minHiveDec
init|=
name|HiveDecimal
operator|.
name|create
argument_list|(
operator|new
name|BigInteger
argument_list|(
name|lowValue
operator|.
name|getUnscaled
argument_list|()
argument_list|)
argument_list|,
name|lowValue
operator|.
name|getScale
argument_list|()
argument_list|)
decl_stmt|;
name|BigDecimal
name|minVal
init|=
name|minHiveDec
operator|==
literal|null
condition|?
literal|null
else|:
name|minHiveDec
operator|.
name|bigDecimalValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|minVal
operator|!=
literal|null
operator|&&
name|maxVal
operator|!=
literal|null
condition|)
block|{
name|cs
operator|.
name|setRange
argument_list|(
name|minVal
argument_list|,
name|maxVal
argument_list|)
expr_stmt|;
block|}
block|}
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DATE_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDate
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|csd
operator|.
name|getDateStats
argument_list|()
operator|.
name|getNumNulls
argument_list|()
argument_list|)
expr_stmt|;
name|Long
name|lowVal
init|=
operator|(
name|csd
operator|.
name|getDateStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
operator|!=
literal|null
operator|)
condition|?
name|csd
operator|.
name|getDateStats
argument_list|()
operator|.
name|getLowValue
argument_list|()
operator|.
name|getDaysSinceEpoch
argument_list|()
else|:
literal|null
decl_stmt|;
name|Long
name|highVal
init|=
operator|(
name|csd
operator|.
name|getDateStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
operator|!=
literal|null
operator|)
condition|?
name|csd
operator|.
name|getDateStats
argument_list|()
operator|.
name|getHighValue
argument_list|()
operator|.
name|getDaysSinceEpoch
argument_list|()
else|:
literal|null
decl_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|lowVal
argument_list|,
name|highVal
argument_list|)
expr_stmt|;
block|}
else|else
block|{
comment|// Columns statistics for complex datatypes are not supported yet
return|return
literal|null
return|;
block|}
return|return
name|cs
return|;
block|}
specifier|private
specifier|static
name|ColStatistics
name|estimateColStats
parameter_list|(
name|long
name|numRows
parameter_list|,
name|String
name|colName
parameter_list|,
name|HiveConf
name|conf
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|)
block|{
name|ColumnInfo
name|cinfo
init|=
name|getColumnInfoForColumn
argument_list|(
name|colName
argument_list|,
name|schema
argument_list|)
decl_stmt|;
name|ColStatistics
name|cs
init|=
operator|new
name|ColStatistics
argument_list|(
name|colName
argument_list|,
name|cinfo
operator|.
name|getTypeName
argument_list|()
argument_list|)
decl_stmt|;
name|cs
operator|.
name|setIsEstimated
argument_list|(
literal|true
argument_list|)
expr_stmt|;
name|String
name|colTypeLowerCase
init|=
name|cinfo
operator|.
name|getTypeName
argument_list|()
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
name|float
name|ndvPercent
init|=
name|Math
operator|.
name|min
argument_list|(
literal|100L
argument_list|,
name|HiveConf
operator|.
name|getFloatVar
argument_list|(
name|conf
argument_list|,
name|ConfVars
operator|.
name|HIVE_STATS_NDV_ESTIMATE_PERC
argument_list|)
argument_list|)
decl_stmt|;
name|float
name|nullPercent
init|=
name|Math
operator|.
name|min
argument_list|(
literal|100L
argument_list|,
name|HiveConf
operator|.
name|getFloatVar
argument_list|(
name|conf
argument_list|,
name|ConfVars
operator|.
name|HIVE_STATS_NUM_NULLS_ESTIMATE_PERC
argument_list|)
argument_list|)
decl_stmt|;
name|cs
operator|.
name|setCountDistint
argument_list|(
name|Math
operator|.
name|max
argument_list|(
literal|1
argument_list|,
call|(
name|long
call|)
argument_list|(
name|numRows
operator|*
name|ndvPercent
operator|/
literal|100.00
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumNulls
argument_list|(
name|Math
operator|.
name|min
argument_list|(
name|numRows
argument_list|,
call|(
name|long
call|)
argument_list|(
name|numRows
operator|*
name|nullPercent
operator|/
literal|100.00
argument_list|)
argument_list|)
argument_list|)
expr_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TINYINT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
operator|-
literal|128
argument_list|,
literal|127
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|SMALLINT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
operator|-
literal|32768
argument_list|,
literal|32767
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|Long
operator|.
name|MIN_VALUE
argument_list|,
name|Long
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BIGINT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|Integer
operator|.
name|MIN_VALUE
argument_list|,
name|Integer
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|FLOAT_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|Float
operator|.
name|MIN_VALUE
argument_list|,
name|Float
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DOUBLE_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|Double
operator|.
name|MIN_VALUE
argument_list|,
name|Double
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|cinfo
operator|.
name|getObjectInspector
argument_list|()
argument_list|,
name|cinfo
operator|.
name|getTypeName
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BOOLEAN_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setCountDistint
argument_list|(
literal|2
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumTrues
argument_list|(
name|Math
operator|.
name|max
argument_list|(
literal|1
argument_list|,
operator|(
name|long
operator|)
name|numRows
operator|/
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setNumFalses
argument_list|(
name|Math
operator|.
name|max
argument_list|(
literal|1
argument_list|,
operator|(
name|long
operator|)
name|numRows
operator|/
literal|2
argument_list|)
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMP_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMPLOCALTZ_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfTimestamp
argument_list|()
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|DECIMAL_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDecimal
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|setRange
argument_list|(
name|Float
operator|.
name|MIN_VALUE
argument_list|,
name|Float
operator|.
name|MAX_VALUE
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DATE_TYPE_NAME
argument_list|)
condition|)
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDate
argument_list|()
argument_list|)
expr_stmt|;
comment|// epoch, days since epoch
name|cs
operator|.
name|setRange
argument_list|(
literal|0
argument_list|,
literal|25201
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|cs
operator|.
name|setAvgColLen
argument_list|(
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|cinfo
operator|.
name|getObjectInspector
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|cs
return|;
block|}
specifier|private
specifier|static
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|estimateStats
parameter_list|(
name|Table
name|table
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|HiveConf
name|conf
parameter_list|,
name|long
name|nr
parameter_list|)
block|{
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|stats
init|=
operator|new
name|ArrayList
argument_list|<
name|ColStatistics
argument_list|>
argument_list|(
name|neededColumns
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|neededColumns
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|ColStatistics
name|cs
init|=
name|estimateColStats
argument_list|(
name|nr
argument_list|,
name|neededColumns
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|,
name|conf
argument_list|,
name|schema
argument_list|)
decl_stmt|;
name|stats
operator|.
name|add
argument_list|(
name|cs
argument_list|)
expr_stmt|;
block|}
return|return
name|stats
return|;
block|}
comment|/**    * Get table level column statistics from metastore for needed columns    * @param table    *          - table    * @param schema    *          - output schema    * @param neededColumns    *          - list of needed columns    * @return column statistics    */
specifier|public
specifier|static
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|getTableColumnStats
parameter_list|(
name|Table
name|table
parameter_list|,
name|List
argument_list|<
name|ColumnInfo
argument_list|>
name|schema
parameter_list|,
name|List
argument_list|<
name|String
argument_list|>
name|neededColumns
parameter_list|,
name|ColumnStatsList
name|colStatsCache
parameter_list|)
block|{
if|if
condition|(
name|table
operator|.
name|isMaterializedTable
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Materialized table does not contain table statistics"
argument_list|)
expr_stmt|;
return|return
literal|null
return|;
block|}
comment|// We will retrieve stats from the metastore only for columns that are not cached
name|List
argument_list|<
name|String
argument_list|>
name|colStatsToRetrieve
decl_stmt|;
if|if
condition|(
name|colStatsCache
operator|!=
literal|null
condition|)
block|{
name|colStatsToRetrieve
operator|=
operator|new
name|ArrayList
argument_list|<>
argument_list|(
name|neededColumns
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|String
name|colName
range|:
name|neededColumns
control|)
block|{
if|if
condition|(
operator|!
name|colStatsCache
operator|.
name|getColStats
argument_list|()
operator|.
name|containsKey
argument_list|(
name|colName
argument_list|)
condition|)
block|{
name|colStatsToRetrieve
operator|.
name|add
argument_list|(
name|colName
argument_list|)
expr_stmt|;
block|}
block|}
block|}
else|else
block|{
name|colStatsToRetrieve
operator|=
name|neededColumns
expr_stmt|;
block|}
comment|// Retrieve stats from metastore
name|String
name|dbName
init|=
name|table
operator|.
name|getDbName
argument_list|()
decl_stmt|;
name|String
name|tabName
init|=
name|table
operator|.
name|getTableName
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|stats
init|=
literal|null
decl_stmt|;
try|try
block|{
name|List
argument_list|<
name|ColumnStatisticsObj
argument_list|>
name|colStat
init|=
name|Hive
operator|.
name|get
argument_list|()
operator|.
name|getTableColumnStatistics
argument_list|(
name|dbName
argument_list|,
name|tabName
argument_list|,
name|colStatsToRetrieve
argument_list|)
decl_stmt|;
name|stats
operator|=
name|convertColStats
argument_list|(
name|colStat
argument_list|,
name|tabName
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|HiveException
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|error
argument_list|(
literal|"Failed to retrieve table statistics: "
argument_list|,
name|e
argument_list|)
expr_stmt|;
name|stats
operator|=
operator|new
name|ArrayList
argument_list|<
name|ColStatistics
argument_list|>
argument_list|()
expr_stmt|;
block|}
comment|// Merge stats from cache with metastore cache
if|if
condition|(
name|colStatsCache
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|String
name|col
range|:
name|neededColumns
control|)
block|{
name|ColStatistics
name|cs
init|=
name|colStatsCache
operator|.
name|getColStats
argument_list|()
operator|.
name|get
argument_list|(
name|col
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|stats
operator|.
name|add
argument_list|(
name|cs
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Stats for column "
operator|+
name|cs
operator|.
name|getColumnName
argument_list|()
operator|+
literal|" in table "
operator|+
name|table
operator|.
name|getCompleteName
argument_list|()
operator|+
literal|" retrieved from cache"
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
return|return
name|stats
return|;
block|}
specifier|private
specifier|static
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|convertColStats
parameter_list|(
name|List
argument_list|<
name|ColumnStatisticsObj
argument_list|>
name|colStats
parameter_list|,
name|String
name|tabName
parameter_list|)
block|{
if|if
condition|(
name|colStats
operator|==
literal|null
condition|)
block|{
return|return
operator|new
name|ArrayList
argument_list|<
name|ColStatistics
argument_list|>
argument_list|()
return|;
block|}
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|stats
init|=
operator|new
name|ArrayList
argument_list|<
name|ColStatistics
argument_list|>
argument_list|(
name|colStats
operator|.
name|size
argument_list|()
argument_list|)
decl_stmt|;
for|for
control|(
name|ColumnStatisticsObj
name|statObj
range|:
name|colStats
control|)
block|{
name|ColStatistics
name|cs
init|=
name|getColStatistics
argument_list|(
name|statObj
argument_list|,
name|tabName
argument_list|,
name|statObj
operator|.
name|getColName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|stats
operator|.
name|add
argument_list|(
name|cs
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|stats
return|;
block|}
comment|/**    * Get the raw data size of variable length data types    * @param conf    *          - hive conf    * @param oi    *          - object inspector    * @param colType    *          - column type    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getAvgColLenOf
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|ObjectInspector
name|oi
parameter_list|,
name|String
name|colType
parameter_list|)
block|{
name|long
name|configVarLen
init|=
name|HiveConf
operator|.
name|getIntVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_MAX_VARIABLE_LENGTH
argument_list|)
decl_stmt|;
name|String
name|colTypeLowCase
init|=
name|colType
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
condition|)
block|{
comment|// constant string projection Ex: select "hello" from table
if|if
condition|(
name|oi
operator|instanceof
name|ConstantObjectInspector
condition|)
block|{
name|ConstantObjectInspector
name|coi
init|=
operator|(
name|ConstantObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// if writable constant is null then return size 0
name|Object
name|constantValue
init|=
name|coi
operator|.
name|getWritableConstantValue
argument_list|()
decl_stmt|;
return|return
name|constantValue
operator|==
literal|null
condition|?
literal|0
else|:
name|constantValue
operator|.
name|toString
argument_list|()
operator|.
name|length
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|StringObjectInspector
condition|)
block|{
comment|// some UDFs may emit strings of variable length. like pattern matching
comment|// UDFs. it's hard to find the length of such UDFs.
comment|// return the variable length from config
return|return
name|configVarLen
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|colTypeLowCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
condition|)
block|{
comment|// constant varchar projection
if|if
condition|(
name|oi
operator|instanceof
name|ConstantObjectInspector
condition|)
block|{
name|ConstantObjectInspector
name|coi
init|=
operator|(
name|ConstantObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// if writable constant is null then return size 0
name|Object
name|constantValue
init|=
name|coi
operator|.
name|getWritableConstantValue
argument_list|()
decl_stmt|;
return|return
name|constantValue
operator|==
literal|null
condition|?
literal|0
else|:
name|constantValue
operator|.
name|toString
argument_list|()
operator|.
name|length
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|HiveVarcharObjectInspector
condition|)
block|{
name|VarcharTypeInfo
name|type
init|=
call|(
name|VarcharTypeInfo
call|)
argument_list|(
operator|(
name|HiveVarcharObjectInspector
operator|)
name|oi
argument_list|)
operator|.
name|getTypeInfo
argument_list|()
decl_stmt|;
return|return
name|type
operator|.
name|getLength
argument_list|()
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|colTypeLowCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
condition|)
block|{
comment|// constant char projection
if|if
condition|(
name|oi
operator|instanceof
name|ConstantObjectInspector
condition|)
block|{
name|ConstantObjectInspector
name|coi
init|=
operator|(
name|ConstantObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// if writable constant is null then return size 0
name|Object
name|constantValue
init|=
name|coi
operator|.
name|getWritableConstantValue
argument_list|()
decl_stmt|;
return|return
name|constantValue
operator|==
literal|null
condition|?
literal|0
else|:
name|constantValue
operator|.
name|toString
argument_list|()
operator|.
name|length
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|HiveCharObjectInspector
condition|)
block|{
name|CharTypeInfo
name|type
init|=
call|(
name|CharTypeInfo
call|)
argument_list|(
operator|(
name|HiveCharObjectInspector
operator|)
name|oi
argument_list|)
operator|.
name|getTypeInfo
argument_list|()
decl_stmt|;
return|return
name|type
operator|.
name|getLength
argument_list|()
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|colTypeLowCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
condition|)
block|{
comment|// constant byte arrays
if|if
condition|(
name|oi
operator|instanceof
name|ConstantObjectInspector
condition|)
block|{
name|ConstantObjectInspector
name|coi
init|=
operator|(
name|ConstantObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// if writable constant is null then return size 0
name|BytesWritable
name|constantValue
init|=
operator|(
name|BytesWritable
operator|)
name|coi
operator|.
name|getWritableConstantValue
argument_list|()
decl_stmt|;
return|return
name|constantValue
operator|==
literal|null
condition|?
literal|0
else|:
name|constantValue
operator|.
name|getLength
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|BinaryObjectInspector
condition|)
block|{
comment|// return the variable length from config
return|return
name|configVarLen
return|;
block|}
block|}
else|else
block|{
comment|// complex types (map, list, struct, union)
return|return
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|oi
argument_list|)
return|;
block|}
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"Size requested for unknown type: "
operator|+
name|colType
operator|+
literal|" OI: "
operator|+
name|oi
operator|.
name|getTypeName
argument_list|()
argument_list|)
throw|;
block|}
comment|/**    * Get the size of complex data types    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getSizeOfComplexTypes
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|ObjectInspector
name|oi
parameter_list|)
block|{
name|long
name|result
init|=
literal|0
decl_stmt|;
name|int
name|length
init|=
literal|0
decl_stmt|;
name|int
name|listEntries
init|=
name|HiveConf
operator|.
name|getIntVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_LIST_NUM_ENTRIES
argument_list|)
decl_stmt|;
name|int
name|mapEntries
init|=
name|HiveConf
operator|.
name|getIntVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_MAP_NUM_ENTRIES
argument_list|)
decl_stmt|;
switch|switch
condition|(
name|oi
operator|.
name|getCategory
argument_list|()
condition|)
block|{
case|case
name|PRIMITIVE
case|:
name|String
name|colTypeLowerCase
init|=
name|oi
operator|.
name|getTypeName
argument_list|()
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
condition|)
block|{
name|int
name|avgColLen
init|=
operator|(
name|int
operator|)
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|oi
argument_list|,
name|colTypeLowerCase
argument_list|)
decl_stmt|;
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForStringOfLength
argument_list|(
name|avgColLen
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
condition|)
block|{
name|int
name|avgColLen
init|=
operator|(
name|int
operator|)
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|oi
argument_list|,
name|colTypeLowerCase
argument_list|)
decl_stmt|;
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForByteArrayOfSize
argument_list|(
name|avgColLen
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|+=
name|getAvgColLenOfFixedLengthTypes
argument_list|(
name|colTypeLowerCase
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|LIST
case|:
if|if
condition|(
name|oi
operator|instanceof
name|StandardConstantListObjectInspector
condition|)
block|{
comment|// constant list projection of known length
name|StandardConstantListObjectInspector
name|scloi
init|=
operator|(
name|StandardConstantListObjectInspector
operator|)
name|oi
decl_stmt|;
name|length
operator|=
name|scloi
operator|.
name|getWritableConstantValue
argument_list|()
operator|.
name|size
argument_list|()
expr_stmt|;
comment|// check if list elements are primitive or Objects
name|ObjectInspector
name|leoi
init|=
name|scloi
operator|.
name|getListElementObjectInspector
argument_list|()
decl_stmt|;
if|if
condition|(
name|leoi
operator|.
name|getCategory
argument_list|()
operator|.
name|equals
argument_list|(
name|ObjectInspector
operator|.
name|Category
operator|.
name|PRIMITIVE
argument_list|)
condition|)
block|{
name|result
operator|+=
name|getSizeOfPrimitiveTypeArraysFromType
argument_list|(
name|leoi
operator|.
name|getTypeName
argument_list|()
argument_list|,
name|length
argument_list|,
name|conf
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForObjectArrayOfSize
argument_list|(
name|length
argument_list|)
expr_stmt|;
block|}
block|}
else|else
block|{
name|StandardListObjectInspector
name|sloi
init|=
operator|(
name|StandardListObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// list overhead + (configured number of element in list * size of element)
name|long
name|elemSize
init|=
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|sloi
operator|.
name|getListElementObjectInspector
argument_list|()
argument_list|)
decl_stmt|;
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|arrayList
argument_list|()
operator|+
operator|(
name|listEntries
operator|*
name|elemSize
operator|)
expr_stmt|;
block|}
break|break;
case|case
name|MAP
case|:
if|if
condition|(
name|oi
operator|instanceof
name|StandardConstantMapObjectInspector
condition|)
block|{
comment|// constant map projection of known length
name|StandardConstantMapObjectInspector
name|scmoi
init|=
operator|(
name|StandardConstantMapObjectInspector
operator|)
name|oi
decl_stmt|;
name|result
operator|+=
name|getSizeOfMap
argument_list|(
name|scmoi
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StandardMapObjectInspector
name|smoi
init|=
operator|(
name|StandardMapObjectInspector
operator|)
name|oi
decl_stmt|;
name|result
operator|+=
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|smoi
operator|.
name|getMapKeyObjectInspector
argument_list|()
argument_list|)
expr_stmt|;
name|result
operator|+=
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|smoi
operator|.
name|getMapValueObjectInspector
argument_list|()
argument_list|)
expr_stmt|;
comment|// hash map overhead
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|hashMap
argument_list|(
name|mapEntries
argument_list|)
expr_stmt|;
block|}
break|break;
case|case
name|STRUCT
case|:
if|if
condition|(
name|oi
operator|instanceof
name|StandardConstantStructObjectInspector
condition|)
block|{
comment|// constant map projection of known length
name|StandardConstantStructObjectInspector
name|scsoi
init|=
operator|(
name|StandardConstantStructObjectInspector
operator|)
name|oi
decl_stmt|;
name|result
operator|+=
name|getSizeOfStruct
argument_list|(
name|scsoi
argument_list|)
expr_stmt|;
block|}
else|else
block|{
name|StructObjectInspector
name|soi
init|=
operator|(
name|StructObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// add constant object overhead for struct
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|object
argument_list|()
expr_stmt|;
comment|// add constant struct field names references overhead
name|result
operator|+=
name|soi
operator|.
name|getAllStructFieldRefs
argument_list|()
operator|.
name|size
argument_list|()
operator|*
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|ref
argument_list|()
expr_stmt|;
for|for
control|(
name|StructField
name|field
range|:
name|soi
operator|.
name|getAllStructFieldRefs
argument_list|()
control|)
block|{
name|result
operator|+=
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|field
operator|.
name|getFieldObjectInspector
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
break|break;
case|case
name|UNION
case|:
name|UnionObjectInspector
name|uoi
init|=
operator|(
name|UnionObjectInspector
operator|)
name|oi
decl_stmt|;
comment|// add constant object overhead for union
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|object
argument_list|()
expr_stmt|;
comment|// add constant size for unions tags
name|result
operator|+=
name|uoi
operator|.
name|getObjectInspectors
argument_list|()
operator|.
name|size
argument_list|()
operator|*
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
expr_stmt|;
for|for
control|(
name|ObjectInspector
name|foi
range|:
name|uoi
operator|.
name|getObjectInspectors
argument_list|()
control|)
block|{
name|result
operator|+=
name|getSizeOfComplexTypes
argument_list|(
name|conf
argument_list|,
name|foi
argument_list|)
expr_stmt|;
block|}
break|break;
default|default:
break|break;
block|}
return|return
name|result
return|;
block|}
comment|/**    * Get size of fixed length primitives    * @param colType    *          - column type    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getAvgColLenOfFixedLengthTypes
parameter_list|(
name|String
name|colType
parameter_list|)
block|{
name|String
name|colTypeLowerCase
init|=
name|colType
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TINYINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|SMALLINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|VOID_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BOOLEAN_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|FLOAT_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DOUBLE_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BIGINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INTERVAL_YEAR_MONTH_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
literal|"long"
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMP_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMPLOCALTZ_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfTimestamp
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DATE_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDate
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|DECIMAL_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDecimal
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INTERVAL_DAY_TIME_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|JAVA32_META
return|;
block|}
else|else
block|{
comment|//TODO: support complex types
comment|// for complex type we simply return 0
return|return
literal|0
return|;
block|}
block|}
comment|/**    * Get the size of arrays of primitive types    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getSizeOfPrimitiveTypeArraysFromType
parameter_list|(
name|String
name|colType
parameter_list|,
name|int
name|length
parameter_list|,
name|HiveConf
name|conf
parameter_list|)
block|{
name|String
name|colTypeLowerCase
init|=
name|colType
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TINYINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|SMALLINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|FLOAT_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForIntArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DOUBLE_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForDoubleArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BIGINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
literal|"long"
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForLongArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForByteArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BOOLEAN_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForBooleanArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMP_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DATETIME_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INTERVAL_YEAR_MONTH_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INTERVAL_DAY_TIME_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMPLOCALTZ_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForTimestampArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DATE_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForDateArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|DECIMAL_TYPE_NAME
argument_list|)
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForDecimalArrayOfSize
argument_list|(
name|length
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
condition|)
block|{
name|int
name|configVarLen
init|=
name|HiveConf
operator|.
name|getIntVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVE_STATS_MAX_VARIABLE_LENGTH
argument_list|)
decl_stmt|;
name|int
name|siz
init|=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForStringOfLength
argument_list|(
name|configVarLen
argument_list|)
decl_stmt|;
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForPrimitiveArrayOfSize
argument_list|(
name|siz
argument_list|,
name|length
argument_list|)
return|;
block|}
else|else
block|{
return|return
literal|0
return|;
block|}
block|}
comment|/**    * Estimate the size of map object    * @param scmoi    *          - object inspector    * @return size of map    */
specifier|public
specifier|static
name|long
name|getSizeOfMap
parameter_list|(
name|StandardConstantMapObjectInspector
name|scmoi
parameter_list|)
block|{
name|Map
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
name|map
init|=
name|scmoi
operator|.
name|getWritableConstantValue
argument_list|()
decl_stmt|;
name|ObjectInspector
name|koi
init|=
name|scmoi
operator|.
name|getMapKeyObjectInspector
argument_list|()
decl_stmt|;
name|ObjectInspector
name|voi
init|=
name|scmoi
operator|.
name|getMapValueObjectInspector
argument_list|()
decl_stmt|;
name|long
name|result
init|=
literal|0
decl_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|?
argument_list|,
name|?
argument_list|>
name|entry
range|:
name|map
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|result
operator|+=
name|getWritableSize
argument_list|(
name|koi
argument_list|,
name|entry
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
name|result
operator|+=
name|getWritableSize
argument_list|(
name|voi
argument_list|,
name|entry
operator|.
name|getValue
argument_list|()
argument_list|)
expr_stmt|;
block|}
comment|// add additional overhead of each map entries
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|hashMap
argument_list|(
name|map
operator|.
name|entrySet
argument_list|()
operator|.
name|size
argument_list|()
argument_list|)
expr_stmt|;
return|return
name|result
return|;
block|}
specifier|public
specifier|static
name|long
name|getSizeOfStruct
parameter_list|(
name|StandardConstantStructObjectInspector
name|soi
parameter_list|)
block|{
name|long
name|result
init|=
literal|0
decl_stmt|;
comment|// add constant object overhead for struct
name|result
operator|+=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|object
argument_list|()
expr_stmt|;
comment|// add constant struct field names references overhead
name|result
operator|+=
name|soi
operator|.
name|getAllStructFieldRefs
argument_list|()
operator|.
name|size
argument_list|()
operator|*
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|ref
argument_list|()
expr_stmt|;
name|List
argument_list|<
name|?
argument_list|>
name|value
init|=
name|soi
operator|.
name|getWritableConstantValue
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|?
extends|extends
name|StructField
argument_list|>
name|fields
init|=
name|soi
operator|.
name|getAllStructFieldRefs
argument_list|()
decl_stmt|;
if|if
condition|(
name|value
operator|==
literal|null
operator|||
name|value
operator|.
name|size
argument_list|()
operator|!=
name|fields
operator|.
name|size
argument_list|()
condition|)
block|{
return|return
name|result
return|;
block|}
for|for
control|(
name|int
name|i
init|=
literal|0
init|;
name|i
operator|<
name|fields
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|result
operator|+=
name|getWritableSize
argument_list|(
name|fields
operator|.
name|get
argument_list|(
name|i
argument_list|)
operator|.
name|getFieldObjectInspector
argument_list|()
argument_list|,
name|value
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|result
return|;
block|}
comment|/**    * Get size of primitive data types based on their respective writable object inspector    * @param oi    *          - object inspector    * @param value    *          - value    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getWritableSize
parameter_list|(
name|ObjectInspector
name|oi
parameter_list|,
name|Object
name|value
parameter_list|)
block|{
if|if
condition|(
name|oi
operator|instanceof
name|WritableStringObjectInspector
condition|)
block|{
name|WritableStringObjectInspector
name|woi
init|=
operator|(
name|WritableStringObjectInspector
operator|)
name|oi
decl_stmt|;
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForStringOfLength
argument_list|(
name|woi
operator|.
name|getPrimitiveWritableObject
argument_list|(
name|value
argument_list|)
operator|.
name|getLength
argument_list|()
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableBinaryObjectInspector
condition|)
block|{
name|WritableBinaryObjectInspector
name|woi
init|=
operator|(
name|WritableBinaryObjectInspector
operator|)
name|oi
decl_stmt|;
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForByteArrayOfSize
argument_list|(
name|woi
operator|.
name|getPrimitiveWritableObject
argument_list|(
name|value
argument_list|)
operator|.
name|getLength
argument_list|()
argument_list|)
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableBooleanObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableByteObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableDateObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDate
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableDoubleObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableFloatObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableHiveDecimalObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDecimal
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableIntObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableLongObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive2
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableShortObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|primitive1
argument_list|()
return|;
block|}
elseif|else
if|if
condition|(
name|oi
operator|instanceof
name|WritableTimestampObjectInspector
operator|||
name|oi
operator|instanceof
name|WritableTimestampLocalTZObjectInspector
condition|)
block|{
return|return
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfTimestamp
argument_list|()
return|;
block|}
return|return
literal|0
return|;
block|}
comment|/**    * Get column statistics from parent statistics.    * @param conf    *          - hive conf    * @param parentStats    *          - parent statistics    * @param colExprMap    *          - column expression map    * @param rowSchema    *          - row schema    * @return column statistics    */
specifier|public
specifier|static
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|getColStatisticsFromExprMap
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|Statistics
name|parentStats
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|ExprNodeDesc
argument_list|>
name|colExprMap
parameter_list|,
name|RowSchema
name|rowSchema
parameter_list|)
block|{
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|cs
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
if|if
condition|(
name|colExprMap
operator|!=
literal|null
operator|&&
name|rowSchema
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|ColumnInfo
name|ci
range|:
name|rowSchema
operator|.
name|getSignature
argument_list|()
control|)
block|{
name|String
name|outColName
init|=
name|ci
operator|.
name|getInternalName
argument_list|()
decl_stmt|;
name|ExprNodeDesc
name|end
init|=
name|colExprMap
operator|.
name|get
argument_list|(
name|outColName
argument_list|)
decl_stmt|;
name|ColStatistics
name|colStat
init|=
name|getColStatisticsFromExpression
argument_list|(
name|conf
argument_list|,
name|parentStats
argument_list|,
name|end
argument_list|)
decl_stmt|;
if|if
condition|(
name|colStat
operator|!=
literal|null
condition|)
block|{
name|colStat
operator|.
name|setColumnName
argument_list|(
name|outColName
argument_list|)
expr_stmt|;
name|cs
operator|.
name|add
argument_list|(
name|colStat
argument_list|)
expr_stmt|;
block|}
block|}
comment|// sometimes RowSchema is empty, so fetch stats of columns in exprMap
for|for
control|(
name|Entry
argument_list|<
name|String
argument_list|,
name|ExprNodeDesc
argument_list|>
name|pair
range|:
name|colExprMap
operator|.
name|entrySet
argument_list|()
control|)
block|{
if|if
condition|(
name|rowSchema
operator|.
name|getColumnInfo
argument_list|(
name|pair
operator|.
name|getKey
argument_list|()
argument_list|)
operator|==
literal|null
condition|)
block|{
name|ColStatistics
name|colStat
init|=
name|getColStatisticsFromExpression
argument_list|(
name|conf
argument_list|,
name|parentStats
argument_list|,
name|pair
operator|.
name|getValue
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|colStat
operator|!=
literal|null
condition|)
block|{
name|colStat
operator|.
name|setColumnName
argument_list|(
name|pair
operator|.
name|getKey
argument_list|()
argument_list|)
expr_stmt|;
name|cs
operator|.
name|add
argument_list|(
name|colStat
argument_list|)
expr_stmt|;
block|}
block|}
block|}
return|return
name|cs
return|;
block|}
comment|// In cases where column expression map or row schema is missing, just pass on the parent column
comment|// stats. This could happen in cases like TS -> FIL where FIL does not map input column names to
comment|// internal names.
if|if
condition|(
name|colExprMap
operator|==
literal|null
operator|||
name|rowSchema
operator|==
literal|null
condition|)
block|{
if|if
condition|(
name|parentStats
operator|.
name|getColumnStats
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|cs
operator|.
name|addAll
argument_list|(
name|parentStats
operator|.
name|getColumnStats
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|cs
return|;
block|}
comment|/**    * Get column statistics from parent statistics given the    * row schema of its child.    * @param parentStats    *          - parent statistics    * @param rowSchema    *          - row schema    * @return column statistics    */
specifier|public
specifier|static
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|getColStatisticsUpdatingTableAlias
parameter_list|(
name|Statistics
name|parentStats
parameter_list|,
name|RowSchema
name|rowSchema
parameter_list|)
block|{
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|cs
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
for|for
control|(
name|ColStatistics
name|parentColStat
range|:
name|parentStats
operator|.
name|getColumnStats
argument_list|()
control|)
block|{
name|ColStatistics
name|colStat
decl_stmt|;
name|colStat
operator|=
name|parentColStat
operator|.
name|clone
argument_list|()
expr_stmt|;
if|if
condition|(
name|colStat
operator|!=
literal|null
condition|)
block|{
name|cs
operator|.
name|add
argument_list|(
name|colStat
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|cs
return|;
block|}
comment|/**    * Get column statistics expression nodes    * @param conf    *          - hive conf    * @param parentStats    *          - parent statistics    * @param end    *          - expression nodes    * @return column statistics    */
specifier|public
specifier|static
name|ColStatistics
name|getColStatisticsFromExpression
parameter_list|(
name|HiveConf
name|conf
parameter_list|,
name|Statistics
name|parentStats
parameter_list|,
name|ExprNodeDesc
name|end
parameter_list|)
block|{
if|if
condition|(
name|end
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
name|String
name|colName
init|=
literal|null
decl_stmt|;
name|String
name|colType
init|=
literal|null
decl_stmt|;
name|double
name|avgColSize
init|=
literal|0
decl_stmt|;
name|long
name|countDistincts
init|=
literal|0
decl_stmt|;
name|long
name|numNulls
init|=
literal|0
decl_stmt|;
name|ObjectInspector
name|oi
init|=
name|end
operator|.
name|getWritableObjectInspector
argument_list|()
decl_stmt|;
name|long
name|numRows
init|=
name|parentStats
operator|.
name|getNumRows
argument_list|()
decl_stmt|;
if|if
condition|(
name|end
operator|instanceof
name|ExprNodeColumnDesc
condition|)
block|{
comment|// column projection
name|ExprNodeColumnDesc
name|encd
init|=
operator|(
name|ExprNodeColumnDesc
operator|)
name|end
decl_stmt|;
name|colName
operator|=
name|encd
operator|.
name|getColumn
argument_list|()
expr_stmt|;
if|if
condition|(
name|encd
operator|.
name|getIsPartitionColOrVirtualCol
argument_list|()
condition|)
block|{
name|ColStatistics
name|colStats
init|=
name|parentStats
operator|.
name|getColumnStatisticsFromColName
argument_list|(
name|colName
argument_list|)
decl_stmt|;
if|if
condition|(
name|colStats
operator|!=
literal|null
condition|)
block|{
comment|/* If statistics for the column already exist use it. */
return|return
name|colStats
operator|.
name|clone
argument_list|()
return|;
block|}
comment|// virtual columns
name|colType
operator|=
name|encd
operator|.
name|getTypeInfo
argument_list|()
operator|.
name|getTypeName
argument_list|()
expr_stmt|;
name|countDistincts
operator|=
name|numRows
expr_stmt|;
block|}
else|else
block|{
comment|// clone the column stats and return
name|ColStatistics
name|result
init|=
name|parentStats
operator|.
name|getColumnStatisticsFromColName
argument_list|(
name|colName
argument_list|)
decl_stmt|;
if|if
condition|(
name|result
operator|!=
literal|null
condition|)
block|{
return|return
name|result
operator|.
name|clone
argument_list|()
return|;
block|}
return|return
literal|null
return|;
block|}
block|}
elseif|else
if|if
condition|(
name|end
operator|instanceof
name|ExprNodeConstantDesc
condition|)
block|{
comment|// constant projection
name|ExprNodeConstantDesc
name|encd
init|=
operator|(
name|ExprNodeConstantDesc
operator|)
name|end
decl_stmt|;
name|colName
operator|=
name|encd
operator|.
name|getName
argument_list|()
expr_stmt|;
name|colType
operator|=
name|encd
operator|.
name|getTypeString
argument_list|()
expr_stmt|;
if|if
condition|(
name|encd
operator|.
name|getValue
argument_list|()
operator|==
literal|null
condition|)
block|{
comment|// null projection
name|numNulls
operator|=
name|numRows
expr_stmt|;
block|}
else|else
block|{
name|countDistincts
operator|=
literal|1
expr_stmt|;
block|}
block|}
elseif|else
if|if
condition|(
name|end
operator|instanceof
name|ExprNodeGenericFuncDesc
condition|)
block|{
name|ExprNodeGenericFuncDesc
name|engfd
init|=
operator|(
name|ExprNodeGenericFuncDesc
operator|)
name|end
decl_stmt|;
name|colName
operator|=
name|engfd
operator|.
name|getName
argument_list|()
expr_stmt|;
name|colType
operator|=
name|engfd
operator|.
name|getTypeString
argument_list|()
expr_stmt|;
comment|// If it is a widening cast, we do not change NDV, min, max
if|if
condition|(
name|isWideningCast
argument_list|(
name|engfd
argument_list|)
operator|&&
name|engfd
operator|.
name|getChildren
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|instanceof
name|ExprNodeColumnDesc
condition|)
block|{
comment|// cast on single column
name|ColStatistics
name|stats
init|=
name|parentStats
operator|.
name|getColumnStatisticsFromColName
argument_list|(
name|engfd
operator|.
name|getCols
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
argument_list|)
decl_stmt|;
if|if
condition|(
name|stats
operator|!=
literal|null
condition|)
block|{
name|ColStatistics
name|newStats
decl_stmt|;
name|newStats
operator|=
name|stats
operator|.
name|clone
argument_list|()
expr_stmt|;
name|newStats
operator|.
name|setColumnName
argument_list|(
name|colName
argument_list|)
expr_stmt|;
name|colType
operator|=
name|colType
operator|.
name|toLowerCase
argument_list|()
expr_stmt|;
name|newStats
operator|.
name|setColumnType
argument_list|(
name|colType
argument_list|)
expr_stmt|;
name|newStats
operator|.
name|setAvgColLen
argument_list|(
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|oi
argument_list|,
name|colType
argument_list|)
argument_list|)
expr_stmt|;
return|return
name|newStats
return|;
block|}
block|}
comment|// fallback to default
name|countDistincts
operator|=
name|getNDVFor
argument_list|(
name|engfd
argument_list|,
name|numRows
argument_list|,
name|parentStats
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|end
operator|instanceof
name|ExprNodeColumnListDesc
condition|)
block|{
comment|// column list
name|ExprNodeColumnListDesc
name|encd
init|=
operator|(
name|ExprNodeColumnListDesc
operator|)
name|end
decl_stmt|;
name|colName
operator|=
name|Joiner
operator|.
name|on
argument_list|(
literal|","
argument_list|)
operator|.
name|join
argument_list|(
name|encd
operator|.
name|getCols
argument_list|()
argument_list|)
expr_stmt|;
name|colType
operator|=
name|serdeConstants
operator|.
name|LIST_TYPE_NAME
expr_stmt|;
name|countDistincts
operator|=
name|numRows
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|end
operator|instanceof
name|ExprNodeFieldDesc
condition|)
block|{
comment|// field within complex type
name|ExprNodeFieldDesc
name|enfd
init|=
operator|(
name|ExprNodeFieldDesc
operator|)
name|end
decl_stmt|;
name|colName
operator|=
name|enfd
operator|.
name|getFieldName
argument_list|()
expr_stmt|;
name|colType
operator|=
name|enfd
operator|.
name|getTypeString
argument_list|()
expr_stmt|;
name|countDistincts
operator|=
name|numRows
expr_stmt|;
block|}
else|else
block|{
throw|throw
operator|new
name|IllegalArgumentException
argument_list|(
literal|"not supported expr type "
operator|+
name|end
operator|.
name|getClass
argument_list|()
argument_list|)
throw|;
block|}
name|colType
operator|=
name|colType
operator|.
name|toLowerCase
argument_list|()
expr_stmt|;
name|avgColSize
operator|=
name|getAvgColLenOf
argument_list|(
name|conf
argument_list|,
name|oi
argument_list|,
name|colType
argument_list|)
expr_stmt|;
name|ColStatistics
name|colStats
init|=
operator|new
name|ColStatistics
argument_list|(
name|colName
argument_list|,
name|colType
argument_list|)
decl_stmt|;
name|colStats
operator|.
name|setAvgColLen
argument_list|(
name|avgColSize
argument_list|)
expr_stmt|;
name|colStats
operator|.
name|setCountDistint
argument_list|(
name|countDistincts
argument_list|)
expr_stmt|;
name|colStats
operator|.
name|setNumNulls
argument_list|(
name|numNulls
argument_list|)
expr_stmt|;
return|return
name|colStats
return|;
block|}
specifier|private
specifier|static
name|boolean
name|isWideningCast
parameter_list|(
name|ExprNodeGenericFuncDesc
name|engfd
parameter_list|)
block|{
name|GenericUDF
name|udf
init|=
name|engfd
operator|.
name|getGenericUDF
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|FunctionRegistry
operator|.
name|isOpCast
argument_list|(
name|udf
argument_list|)
condition|)
block|{
comment|// It is not a cast
return|return
literal|false
return|;
block|}
return|return
name|TypeInfoUtils
operator|.
name|implicitConvertible
argument_list|(
name|engfd
operator|.
name|getChildren
argument_list|()
operator|.
name|get
argument_list|(
literal|0
argument_list|)
operator|.
name|getTypeInfo
argument_list|()
argument_list|,
name|engfd
operator|.
name|getTypeInfo
argument_list|()
argument_list|)
return|;
block|}
specifier|public
specifier|static
name|Long
name|addWithExpDecay
parameter_list|(
name|List
argument_list|<
name|Long
argument_list|>
name|distinctVals
parameter_list|)
block|{
comment|// Exponential back-off for NDVs.
comment|// 1) Descending order sort of NDVs
comment|// 2) denominator = NDV1 * (NDV2 ^ (1/2)) * (NDV3 ^ (1/4))) * ....
name|Collections
operator|.
name|sort
argument_list|(
name|distinctVals
argument_list|,
name|Collections
operator|.
name|reverseOrder
argument_list|()
argument_list|)
expr_stmt|;
name|long
name|denom
init|=
name|distinctVals
operator|.
name|get
argument_list|(
literal|0
argument_list|)
decl_stmt|;
for|for
control|(
name|int
name|i
init|=
literal|1
init|;
name|i
operator|<
name|distinctVals
operator|.
name|size
argument_list|()
condition|;
name|i
operator|++
control|)
block|{
name|denom
operator|=
call|(
name|long
call|)
argument_list|(
name|denom
operator|*
name|Math
operator|.
name|pow
argument_list|(
name|distinctVals
operator|.
name|get
argument_list|(
name|i
argument_list|)
argument_list|,
literal|1.0
operator|/
operator|(
literal|1
operator|<<
name|i
operator|)
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|denom
return|;
block|}
specifier|private
specifier|static
name|long
name|getNDVFor
parameter_list|(
name|ExprNodeGenericFuncDesc
name|engfd
parameter_list|,
name|long
name|numRows
parameter_list|,
name|Statistics
name|parentStats
parameter_list|)
block|{
name|GenericUDF
name|udf
init|=
name|engfd
operator|.
name|getGenericUDF
argument_list|()
decl_stmt|;
if|if
condition|(
operator|!
name|FunctionRegistry
operator|.
name|isDeterministic
argument_list|(
name|udf
argument_list|)
condition|)
block|{
return|return
name|numRows
return|;
block|}
name|List
argument_list|<
name|Long
argument_list|>
name|ndvs
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
name|Class
argument_list|<
name|?
argument_list|>
name|udfClass
init|=
name|udf
operator|instanceof
name|GenericUDFBridge
condition|?
operator|(
operator|(
name|GenericUDFBridge
operator|)
name|udf
operator|)
operator|.
name|getUdfClass
argument_list|()
else|:
name|udf
operator|.
name|getClass
argument_list|()
decl_stmt|;
name|NDV
name|ndv
init|=
name|AnnotationUtils
operator|.
name|getAnnotation
argument_list|(
name|udfClass
argument_list|,
name|NDV
operator|.
name|class
argument_list|)
decl_stmt|;
name|long
name|udfNDV
init|=
name|Long
operator|.
name|MAX_VALUE
decl_stmt|;
if|if
condition|(
name|ndv
operator|!=
literal|null
condition|)
block|{
name|udfNDV
operator|=
name|ndv
operator|.
name|maxNdv
argument_list|()
expr_stmt|;
block|}
else|else
block|{
for|for
control|(
name|String
name|col
range|:
name|engfd
operator|.
name|getCols
argument_list|()
control|)
block|{
name|ColStatistics
name|stats
init|=
name|parentStats
operator|.
name|getColumnStatisticsFromColName
argument_list|(
name|col
argument_list|)
decl_stmt|;
if|if
condition|(
name|stats
operator|!=
literal|null
condition|)
block|{
name|ndvs
operator|.
name|add
argument_list|(
name|stats
operator|.
name|getCountDistint
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
name|long
name|countDistincts
init|=
name|ndvs
operator|.
name|isEmpty
argument_list|()
condition|?
name|numRows
else|:
name|addWithExpDecay
argument_list|(
name|ndvs
argument_list|)
decl_stmt|;
return|return
name|Collections
operator|.
name|min
argument_list|(
name|Lists
operator|.
name|newArrayList
argument_list|(
name|countDistincts
argument_list|,
name|udfNDV
argument_list|,
name|numRows
argument_list|)
argument_list|)
return|;
block|}
comment|/**    * Get number of rows of a give table    * @return number of rows    */
specifier|public
specifier|static
name|long
name|getNumRows
parameter_list|(
name|Table
name|table
parameter_list|)
block|{
return|return
name|getBasicStatForTable
argument_list|(
name|table
argument_list|,
name|StatsSetupConst
operator|.
name|ROW_COUNT
argument_list|)
return|;
block|}
comment|/**    * Get raw data size of a give table    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getRawDataSize
parameter_list|(
name|Table
name|table
parameter_list|)
block|{
return|return
name|getBasicStatForTable
argument_list|(
name|table
argument_list|,
name|StatsSetupConst
operator|.
name|RAW_DATA_SIZE
argument_list|)
return|;
block|}
comment|/**    * Get total size of a give table    * @return total size    */
specifier|public
specifier|static
name|long
name|getTotalSize
parameter_list|(
name|Table
name|table
parameter_list|)
block|{
return|return
name|getBasicStatForTable
argument_list|(
name|table
argument_list|,
name|StatsSetupConst
operator|.
name|TOTAL_SIZE
argument_list|)
return|;
block|}
comment|/**    * Get basic stats of table    * @param table    *          - table    * @param statType    *          - type of stats    * @return value of stats    */
specifier|public
specifier|static
name|long
name|getBasicStatForTable
parameter_list|(
name|Table
name|table
parameter_list|,
name|String
name|statType
parameter_list|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|params
init|=
name|table
operator|.
name|getParameters
argument_list|()
decl_stmt|;
name|long
name|result
init|=
operator|-
literal|1
decl_stmt|;
if|if
condition|(
name|params
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|result
operator|=
name|Long
operator|.
name|parseLong
argument_list|(
name|params
operator|.
name|get
argument_list|(
name|statType
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|result
operator|=
operator|-
literal|1
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
comment|/**    * Get basic stats of partitions    * @param table    *          - table    * @param parts    *          - partitions    * @param statType    *          - type of stats    * @return value of stats    */
specifier|public
specifier|static
name|List
argument_list|<
name|Long
argument_list|>
name|getBasicStatForPartitions
parameter_list|(
name|Table
name|table
parameter_list|,
name|List
argument_list|<
name|Partition
argument_list|>
name|parts
parameter_list|,
name|String
name|statType
parameter_list|)
block|{
name|List
argument_list|<
name|Long
argument_list|>
name|stats
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
for|for
control|(
name|Partition
name|part
range|:
name|parts
control|)
block|{
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|params
init|=
name|part
operator|.
name|getParameters
argument_list|()
decl_stmt|;
name|long
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|params
operator|!=
literal|null
condition|)
block|{
try|try
block|{
name|result
operator|=
name|Long
operator|.
name|parseLong
argument_list|(
name|params
operator|.
name|get
argument_list|(
name|statType
argument_list|)
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|NumberFormatException
name|e
parameter_list|)
block|{
name|result
operator|=
literal|0
expr_stmt|;
block|}
name|stats
operator|.
name|add
argument_list|(
name|result
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|stats
return|;
block|}
comment|/**    * Compute raw data size from column statistics    * @param numRows    *          - number of rows    * @param colStats    *          - column statistics    * @return raw data size    */
specifier|public
specifier|static
name|long
name|getDataSizeFromColumnStats
parameter_list|(
name|long
name|numRows
parameter_list|,
name|List
argument_list|<
name|ColStatistics
argument_list|>
name|colStats
parameter_list|)
block|{
name|long
name|result
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|numRows
operator|<=
literal|0
operator|||
name|colStats
operator|==
literal|null
condition|)
block|{
return|return
name|result
return|;
block|}
if|if
condition|(
name|colStats
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
comment|// this may happen if we are not projecting any column from current operator
comment|// think count(*) where we are projecting rows without any columns
comment|// in such a case we estimate empty row to be of size of empty java object.
return|return
name|numRows
operator|*
name|JavaDataModel
operator|.
name|JAVA64_REF
return|;
block|}
for|for
control|(
name|ColStatistics
name|cs
range|:
name|colStats
control|)
block|{
if|if
condition|(
name|cs
operator|!=
literal|null
condition|)
block|{
name|String
name|colTypeLowerCase
init|=
name|cs
operator|.
name|getColumnType
argument_list|()
operator|.
name|toLowerCase
argument_list|()
decl_stmt|;
name|long
name|nonNullCount
init|=
name|cs
operator|.
name|getNumNulls
argument_list|()
operator|>
literal|0
condition|?
name|numRows
operator|-
name|cs
operator|.
name|getNumNulls
argument_list|()
operator|+
literal|1
else|:
name|numRows
decl_stmt|;
name|double
name|sizeOf
init|=
literal|0
decl_stmt|;
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TINYINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|SMALLINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|INT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BIGINT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BOOLEAN_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|FLOAT_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DOUBLE_TYPE_NAME
argument_list|)
condition|)
block|{
name|sizeOf
operator|=
name|cs
operator|.
name|getAvgColLen
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|STRING_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|VARCHAR_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|CHAR_TYPE_NAME
argument_list|)
condition|)
block|{
name|int
name|acl
init|=
operator|(
name|int
operator|)
name|Math
operator|.
name|round
argument_list|(
name|cs
operator|.
name|getAvgColLen
argument_list|()
argument_list|)
decl_stmt|;
name|sizeOf
operator|=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForStringOfLength
argument_list|(
name|acl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|BINARY_TYPE_NAME
argument_list|)
condition|)
block|{
name|int
name|acl
init|=
operator|(
name|int
operator|)
name|Math
operator|.
name|round
argument_list|(
name|cs
operator|.
name|getAvgColLen
argument_list|()
argument_list|)
decl_stmt|;
name|sizeOf
operator|=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthForByteArrayOfSize
argument_list|(
name|acl
argument_list|)
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMP_TYPE_NAME
argument_list|)
operator|||
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|TIMESTAMPLOCALTZ_TYPE_NAME
argument_list|)
condition|)
block|{
name|sizeOf
operator|=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfTimestamp
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|startsWith
argument_list|(
name|serdeConstants
operator|.
name|DECIMAL_TYPE_NAME
argument_list|)
condition|)
block|{
name|sizeOf
operator|=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDecimal
argument_list|()
expr_stmt|;
block|}
elseif|else
if|if
condition|(
name|colTypeLowerCase
operator|.
name|equals
argument_list|(
name|serdeConstants
operator|.
name|DATE_TYPE_NAME
argument_list|)
condition|)
block|{
name|sizeOf
operator|=
name|JavaDataModel
operator|.
name|get
argument_list|()
operator|.
name|lengthOfDate
argument_list|()
expr_stmt|;
block|}
else|else
block|{
name|sizeOf
operator|=
name|cs
operator|.
name|getAvgColLen
argument_list|()
expr_stmt|;
block|}
name|result
operator|=
name|safeAdd
argument_list|(
name|result
argument_list|,
name|safeMult
argument_list|(
name|nonNullCount
argument_list|,
name|sizeOf
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
specifier|public
specifier|static
name|String
name|getFullyQualifiedTableName
parameter_list|(
name|String
name|dbName
parameter_list|,
name|String
name|tabName
parameter_list|)
block|{
return|return
name|getFullyQualifiedName
argument_list|(
name|dbName
argument_list|,
name|tabName
argument_list|)
return|;
block|}
specifier|private
specifier|static
name|String
name|getFullyQualifiedName
parameter_list|(
name|String
modifier|...
name|names
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|nonNullAndEmptyNames
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
for|for
control|(
name|String
name|name
range|:
name|names
control|)
block|{
if|if
condition|(
name|name
operator|!=
literal|null
operator|&&
operator|!
name|name
operator|.
name|isEmpty
argument_list|()
condition|)
block|{
name|nonNullAndEmptyNames
operator|.
name|add
argument_list|(
name|name
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|Joiner
operator|.
name|on
argument_list|(
literal|"."
argument_list|)
operator|.
name|join
argument_list|(
name|nonNullAndEmptyNames
argument_list|)
return|;
block|}
comment|/**    * Get qualified column name from output key column names    * @param keyExprs    *          - output key names    * @return list of qualified names    */
specifier|public
specifier|static
name|List
argument_list|<
name|String
argument_list|>
name|getQualifedReducerKeyNames
parameter_list|(
name|List
argument_list|<
name|String
argument_list|>
name|keyExprs
parameter_list|)
block|{
name|List
argument_list|<
name|String
argument_list|>
name|result
init|=
name|Lists
operator|.
name|newArrayList
argument_list|()
decl_stmt|;
if|if
condition|(
name|keyExprs
operator|!=
literal|null
condition|)
block|{
for|for
control|(
name|String
name|key
range|:
name|keyExprs
control|)
block|{
name|result
operator|.
name|add
argument_list|(
name|Utilities
operator|.
name|ReduceField
operator|.
name|KEY
operator|.
name|toString
argument_list|()
operator|+
literal|"."
operator|+
name|key
argument_list|)
expr_stmt|;
block|}
block|}
return|return
name|result
return|;
block|}
specifier|public
specifier|static
name|long
name|getAvailableMemory
parameter_list|(
name|Configuration
name|conf
parameter_list|)
block|{
name|int
name|memory
init|=
name|HiveConf
operator|.
name|getIntVar
argument_list|(
name|conf
argument_list|,
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVETEZCONTAINERSIZE
argument_list|)
decl_stmt|;
if|if
condition|(
name|memory
operator|<=
literal|0
condition|)
block|{
name|memory
operator|=
name|conf
operator|.
name|getInt
argument_list|(
name|MRJobConfig
operator|.
name|MAP_MEMORY_MB
argument_list|,
name|MRJobConfig
operator|.
name|DEFAULT_MAP_MEMORY_MB
argument_list|)
expr_stmt|;
if|if
condition|(
name|memory
operator|<=
literal|0
condition|)
block|{
name|memory
operator|=
literal|1024
expr_stmt|;
block|}
block|}
return|return
name|memory
return|;
block|}
comment|/**    * negative number of rows or data sizes are invalid. It could be because of    * long overflow in which case return Long.MAX_VALUE    * @param val - input value    * @return Long.MAX_VALUE if val is negative else val    */
specifier|public
specifier|static
name|long
name|getMaxIfOverflow
parameter_list|(
name|long
name|val
parameter_list|)
block|{
return|return
name|val
operator|<
literal|0
condition|?
name|Long
operator|.
name|MAX_VALUE
else|:
name|val
return|;
block|}
comment|/** Bounded multiplication - overflows become MAX_VALUE */
specifier|public
specifier|static
name|long
name|safeMult
parameter_list|(
name|long
name|a
parameter_list|,
name|double
name|b
parameter_list|)
block|{
name|double
name|result
init|=
name|a
operator|*
name|b
decl_stmt|;
return|return
operator|(
name|result
operator|>
name|Long
operator|.
name|MAX_VALUE
operator|)
condition|?
name|Long
operator|.
name|MAX_VALUE
else|:
operator|(
name|long
operator|)
name|result
return|;
block|}
comment|/** Bounded addition - overflows become MAX_VALUE */
specifier|public
specifier|static
name|long
name|safeAdd
parameter_list|(
name|long
name|a
parameter_list|,
name|long
name|b
parameter_list|)
block|{
try|try
block|{
return|return
name|LongMath
operator|.
name|checkedAdd
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|ArithmeticException
name|ex
parameter_list|)
block|{
return|return
name|Long
operator|.
name|MAX_VALUE
return|;
block|}
block|}
comment|/** Bounded multiplication - overflows become MAX_VALUE */
specifier|public
specifier|static
name|long
name|safeMult
parameter_list|(
name|long
name|a
parameter_list|,
name|long
name|b
parameter_list|)
block|{
try|try
block|{
return|return
name|LongMath
operator|.
name|checkedMultiply
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
return|;
block|}
catch|catch
parameter_list|(
name|ArithmeticException
name|ex
parameter_list|)
block|{
return|return
name|Long
operator|.
name|MAX_VALUE
return|;
block|}
block|}
specifier|public
specifier|static
name|List
argument_list|<
name|Long
argument_list|>
name|safeMult
parameter_list|(
name|List
argument_list|<
name|Long
argument_list|>
name|l
parameter_list|,
name|float
name|b
parameter_list|)
block|{
name|List
argument_list|<
name|Long
argument_list|>
name|ret
init|=
operator|new
name|ArrayList
argument_list|<>
argument_list|()
decl_stmt|;
for|for
control|(
name|Long
name|a
range|:
name|l
control|)
block|{
name|ret
operator|.
name|add
argument_list|(
name|safeMult
argument_list|(
name|a
argument_list|,
name|b
argument_list|)
argument_list|)
expr_stmt|;
block|}
return|return
name|ret
return|;
block|}
specifier|public
specifier|static
name|boolean
name|hasDiscreteRange
parameter_list|(
name|ColStatistics
name|colStat
parameter_list|)
block|{
if|if
condition|(
name|colStat
operator|.
name|getRange
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|TypeInfo
name|colType
init|=
name|TypeInfoUtils
operator|.
name|getTypeInfoFromTypeString
argument_list|(
name|colStat
operator|.
name|getColumnType
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|colType
operator|.
name|getCategory
argument_list|()
operator|==
name|Category
operator|.
name|PRIMITIVE
condition|)
block|{
name|PrimitiveTypeInfo
name|pti
init|=
operator|(
name|PrimitiveTypeInfo
operator|)
name|colType
decl_stmt|;
switch|switch
condition|(
name|pti
operator|.
name|getPrimitiveCategory
argument_list|()
condition|)
block|{
case|case
name|BOOLEAN
case|:
case|case
name|BYTE
case|:
case|case
name|SHORT
case|:
case|case
name|INT
case|:
case|case
name|LONG
case|:
return|return
literal|true
return|;
default|default:
break|break;
block|}
block|}
block|}
return|return
literal|false
return|;
block|}
specifier|public
specifier|static
name|Range
name|combineRange
parameter_list|(
name|Range
name|range1
parameter_list|,
name|Range
name|range2
parameter_list|)
block|{
if|if
condition|(
name|range1
operator|.
name|minValue
operator|!=
literal|null
operator|&&
name|range1
operator|.
name|maxValue
operator|!=
literal|null
operator|&&
name|range2
operator|.
name|minValue
operator|!=
literal|null
operator|&&
name|range2
operator|.
name|maxValue
operator|!=
literal|null
condition|)
block|{
name|long
name|min1
init|=
name|range1
operator|.
name|minValue
operator|.
name|longValue
argument_list|()
decl_stmt|;
name|long
name|max1
init|=
name|range1
operator|.
name|maxValue
operator|.
name|longValue
argument_list|()
decl_stmt|;
name|long
name|min2
init|=
name|range2
operator|.
name|minValue
operator|.
name|longValue
argument_list|()
decl_stmt|;
name|long
name|max2
init|=
name|range2
operator|.
name|maxValue
operator|.
name|longValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|max1
operator|<
name|min2
operator|||
name|max2
operator|<
name|min1
condition|)
block|{
comment|// No overlap between the two ranges
return|return
literal|null
return|;
block|}
else|else
block|{
comment|// There is an overlap of ranges - create combined range.
return|return
operator|new
name|ColStatistics
operator|.
name|Range
argument_list|(
name|Math
operator|.
name|min
argument_list|(
name|min1
argument_list|,
name|min2
argument_list|)
argument_list|,
name|Math
operator|.
name|max
argument_list|(
name|max1
argument_list|,
name|max2
argument_list|)
argument_list|)
return|;
block|}
block|}
return|return
literal|null
return|;
block|}
block|}
end_class

end_unit

