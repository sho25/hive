begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|history
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|BufferedReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileInputStream
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|FileNotFoundException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|IOException
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|InputStreamReader
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|PrintWriter
import|;
end_import

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|Serializable
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|HashMap
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Map
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|Random
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Matcher
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|regex
operator|.
name|Pattern
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|conf
operator|.
name|HiveConf
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|QueryPlan
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|Task
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|session
operator|.
name|SessionState
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|session
operator|.
name|SessionState
operator|.
name|LogHelper
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapred
operator|.
name|Counters
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapred
operator|.
name|Counters
operator|.
name|Counter
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|mapred
operator|.
name|Counters
operator|.
name|Group
import|;
end_import

begin_comment
comment|/**  * HiveHistory.  *  */
end_comment

begin_class
specifier|public
class|class
name|HiveHistory
block|{
name|PrintWriter
name|histStream
decl_stmt|;
comment|// History File stream
name|String
name|histFileName
decl_stmt|;
comment|// History file name
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
literal|"hive.ql.exec.HiveHistory"
argument_list|)
decl_stmt|;
specifier|private
name|LogHelper
name|console
decl_stmt|;
specifier|private
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|idToTableMap
init|=
literal|null
decl_stmt|;
comment|// Job Hash Map
specifier|private
specifier|final
name|HashMap
argument_list|<
name|String
argument_list|,
name|QueryInfo
argument_list|>
name|queryInfoMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|QueryInfo
argument_list|>
argument_list|()
decl_stmt|;
comment|// Task Hash Map
specifier|private
specifier|final
name|HashMap
argument_list|<
name|String
argument_list|,
name|TaskInfo
argument_list|>
name|taskInfoMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|TaskInfo
argument_list|>
argument_list|()
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|DELIMITER
init|=
literal|" "
decl_stmt|;
comment|/**    * RecordTypes.    *    */
specifier|public
specifier|static
enum|enum
name|RecordTypes
block|{
name|QueryStart
block|,
name|QueryEnd
block|,
name|TaskStart
block|,
name|TaskEnd
block|,
name|TaskProgress
block|,
name|SessionStart
block|,
name|SessionEnd
block|,
name|Counters
block|}
empty_stmt|;
comment|/**    * Keys.    *    */
specifier|public
specifier|static
enum|enum
name|Keys
block|{
name|SESSION_ID
block|,
name|QUERY_ID
block|,
name|TASK_ID
block|,
name|QUERY_RET_CODE
block|,
name|QUERY_NUM_TASKS
block|,
name|QUERY_STRING
block|,
name|TIME
block|,
name|TASK_RET_CODE
block|,
name|TASK_NAME
block|,
name|TASK_HADOOP_ID
block|,
name|TASK_HADOOP_PROGRESS
block|,
name|TASK_COUNTERS
block|,
name|TASK_NUM_MAPPERS
block|,
name|TASK_NUM_REDUCERS
block|,
name|ROWS_INSERTED
block|}
empty_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|KEY
init|=
literal|"(\\w+)"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|String
name|VALUE
init|=
literal|"[[^\"]?]+"
decl_stmt|;
comment|// anything but a " in ""
specifier|private
specifier|static
specifier|final
name|String
name|ROW_COUNT_PATTERN
init|=
literal|"TABLE_ID_(\\d+)_ROWCOUNT"
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Pattern
name|pattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
name|KEY
operator|+
literal|"="
operator|+
literal|"\""
operator|+
name|VALUE
operator|+
literal|"\""
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Pattern
name|rowCountPattern
init|=
name|Pattern
operator|.
name|compile
argument_list|(
name|ROW_COUNT_PATTERN
argument_list|)
decl_stmt|;
comment|// temp buffer for parsed dataa
specifier|private
specifier|static
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|parseBuffer
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
comment|/**    * Listner interface Parser will call handle function for each record type.    */
specifier|public
specifier|static
interface|interface
name|Listener
block|{
name|void
name|handle
parameter_list|(
name|RecordTypes
name|recType
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|values
parameter_list|)
throws|throws
name|IOException
function_decl|;
block|}
comment|/**    * Parses history file and calls call back functions.    *    * @param path    * @param l    * @throws IOException    */
specifier|public
specifier|static
name|void
name|parseHiveHistory
parameter_list|(
name|String
name|path
parameter_list|,
name|Listener
name|l
parameter_list|)
throws|throws
name|IOException
block|{
name|FileInputStream
name|fi
init|=
operator|new
name|FileInputStream
argument_list|(
name|path
argument_list|)
decl_stmt|;
name|BufferedReader
name|reader
init|=
operator|new
name|BufferedReader
argument_list|(
operator|new
name|InputStreamReader
argument_list|(
name|fi
argument_list|)
argument_list|)
decl_stmt|;
try|try
block|{
name|String
name|line
init|=
literal|null
decl_stmt|;
name|StringBuilder
name|buf
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
while|while
condition|(
operator|(
name|line
operator|=
name|reader
operator|.
name|readLine
argument_list|()
operator|)
operator|!=
literal|null
condition|)
block|{
name|buf
operator|.
name|append
argument_list|(
name|line
argument_list|)
expr_stmt|;
comment|// if it does not end with " then it is line continuation
if|if
condition|(
operator|!
name|line
operator|.
name|trim
argument_list|()
operator|.
name|endsWith
argument_list|(
literal|"\""
argument_list|)
condition|)
block|{
continue|continue;
block|}
name|parseLine
argument_list|(
name|buf
operator|.
name|toString
argument_list|()
argument_list|,
name|l
argument_list|)
expr_stmt|;
name|buf
operator|=
operator|new
name|StringBuilder
argument_list|()
expr_stmt|;
block|}
block|}
finally|finally
block|{
try|try
block|{
name|reader
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|IOException
name|ex
parameter_list|)
block|{       }
block|}
block|}
comment|/**    * Parse a single line of history.    *    * @param line    * @param l    * @throws IOException    */
specifier|private
specifier|static
name|void
name|parseLine
parameter_list|(
name|String
name|line
parameter_list|,
name|Listener
name|l
parameter_list|)
throws|throws
name|IOException
block|{
comment|// extract the record type
name|int
name|idx
init|=
name|line
operator|.
name|indexOf
argument_list|(
literal|' '
argument_list|)
decl_stmt|;
name|String
name|recType
init|=
name|line
operator|.
name|substring
argument_list|(
literal|0
argument_list|,
name|idx
argument_list|)
decl_stmt|;
name|String
name|data
init|=
name|line
operator|.
name|substring
argument_list|(
name|idx
operator|+
literal|1
argument_list|,
name|line
operator|.
name|length
argument_list|()
argument_list|)
decl_stmt|;
name|Matcher
name|matcher
init|=
name|pattern
operator|.
name|matcher
argument_list|(
name|data
argument_list|)
decl_stmt|;
while|while
condition|(
name|matcher
operator|.
name|find
argument_list|()
condition|)
block|{
name|String
name|tuple
init|=
name|matcher
operator|.
name|group
argument_list|(
literal|0
argument_list|)
decl_stmt|;
name|String
index|[]
name|parts
init|=
name|tuple
operator|.
name|split
argument_list|(
literal|"="
argument_list|)
decl_stmt|;
name|parseBuffer
operator|.
name|put
argument_list|(
name|parts
index|[
literal|0
index|]
argument_list|,
name|parts
index|[
literal|1
index|]
operator|.
name|substring
argument_list|(
literal|1
argument_list|,
name|parts
index|[
literal|1
index|]
operator|.
name|length
argument_list|()
operator|-
literal|1
argument_list|)
argument_list|)
expr_stmt|;
block|}
name|l
operator|.
name|handle
argument_list|(
name|RecordTypes
operator|.
name|valueOf
argument_list|(
name|recType
argument_list|)
argument_list|,
name|parseBuffer
argument_list|)
expr_stmt|;
name|parseBuffer
operator|.
name|clear
argument_list|()
expr_stmt|;
block|}
comment|/**    * Info.    *    */
specifier|public
specifier|static
class|class
name|Info
block|{    }
comment|/**    * SessionInfo.    *    */
specifier|public
specifier|static
class|class
name|SessionInfo
extends|extends
name|Info
block|{
specifier|public
name|String
name|sessionId
decl_stmt|;
block|}
empty_stmt|;
comment|/**    * QueryInfo.    *    */
specifier|public
specifier|static
class|class
name|QueryInfo
extends|extends
name|Info
block|{
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|hm
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
name|rowCountMap
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|Long
argument_list|>
argument_list|()
decl_stmt|;
block|}
empty_stmt|;
comment|/**    * TaskInfo.    *    */
specifier|public
specifier|static
class|class
name|TaskInfo
extends|extends
name|Info
block|{
specifier|public
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|hm
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
block|}
empty_stmt|;
comment|/**    * Construct HiveHistory object an open history log file.    *    * @param ss    */
specifier|public
name|HiveHistory
parameter_list|(
name|SessionState
name|ss
parameter_list|)
block|{
try|try
block|{
name|console
operator|=
operator|new
name|LogHelper
argument_list|(
name|LOG
argument_list|)
expr_stmt|;
name|String
name|conf_file_loc
init|=
name|ss
operator|.
name|getConf
argument_list|()
operator|.
name|getVar
argument_list|(
name|HiveConf
operator|.
name|ConfVars
operator|.
name|HIVEHISTORYFILELOC
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|conf_file_loc
operator|==
literal|null
operator|)
operator|||
name|conf_file_loc
operator|.
name|length
argument_list|()
operator|==
literal|0
condition|)
block|{
name|console
operator|.
name|printError
argument_list|(
literal|"No history file location given"
argument_list|)
expr_stmt|;
return|return;
block|}
comment|// Create directory
name|File
name|f
init|=
operator|new
name|File
argument_list|(
name|conf_file_loc
argument_list|)
decl_stmt|;
if|if
condition|(
operator|!
name|f
operator|.
name|exists
argument_list|()
condition|)
block|{
if|if
condition|(
operator|!
name|f
operator|.
name|mkdir
argument_list|()
condition|)
block|{
name|console
operator|.
name|printError
argument_list|(
literal|"Unable to create log directory "
operator|+
name|conf_file_loc
argument_list|)
expr_stmt|;
return|return;
block|}
block|}
name|Random
name|randGen
init|=
operator|new
name|Random
argument_list|()
decl_stmt|;
do|do
block|{
name|histFileName
operator|=
name|conf_file_loc
operator|+
literal|"/hive_job_log_"
operator|+
name|ss
operator|.
name|getSessionId
argument_list|()
operator|+
literal|"_"
operator|+
name|Math
operator|.
name|abs
argument_list|(
name|randGen
operator|.
name|nextInt
argument_list|()
argument_list|)
operator|+
literal|".txt"
expr_stmt|;
block|}
do|while
condition|(
operator|new
name|File
argument_list|(
name|histFileName
argument_list|)
operator|.
name|exists
argument_list|()
condition|)
do|;
name|console
operator|.
name|printInfo
argument_list|(
literal|"Hive history file="
operator|+
name|histFileName
argument_list|)
expr_stmt|;
name|histStream
operator|=
operator|new
name|PrintWriter
argument_list|(
name|histFileName
argument_list|)
expr_stmt|;
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|hm
init|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
decl_stmt|;
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|SESSION_ID
operator|.
name|name
argument_list|()
argument_list|,
name|ss
operator|.
name|getSessionId
argument_list|()
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|RecordTypes
operator|.
name|SessionStart
argument_list|,
name|hm
argument_list|)
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|FileNotFoundException
name|e
parameter_list|)
block|{
name|console
operator|.
name|printError
argument_list|(
literal|"FAILED: Failed to open Query Log : "
operator|+
name|histFileName
operator|+
literal|" "
operator|+
name|e
operator|.
name|getMessage
argument_list|()
argument_list|,
literal|"\n"
operator|+
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * @return historyFileName    */
specifier|public
name|String
name|getHistFileName
parameter_list|()
block|{
return|return
name|histFileName
return|;
block|}
comment|/**    * Write the a history record to history file.    *    * @param rt    * @param keyValMap    */
name|void
name|log
parameter_list|(
name|RecordTypes
name|rt
parameter_list|,
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|keyValMap
parameter_list|)
block|{
if|if
condition|(
name|histStream
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|()
decl_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|rt
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
for|for
control|(
name|Map
operator|.
name|Entry
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|ent
range|:
name|keyValMap
operator|.
name|entrySet
argument_list|()
control|)
block|{
name|sb
operator|.
name|append
argument_list|(
name|DELIMITER
argument_list|)
expr_stmt|;
name|String
name|key
init|=
name|ent
operator|.
name|getKey
argument_list|()
decl_stmt|;
name|String
name|val
init|=
name|ent
operator|.
name|getValue
argument_list|()
decl_stmt|;
if|if
condition|(
name|val
operator|!=
literal|null
condition|)
block|{
name|val
operator|=
name|val
operator|.
name|replace
argument_list|(
literal|'\n'
argument_list|,
literal|' '
argument_list|)
expr_stmt|;
block|}
name|sb
operator|.
name|append
argument_list|(
name|key
operator|+
literal|"=\""
operator|+
name|val
operator|+
literal|"\""
argument_list|)
expr_stmt|;
block|}
name|sb
operator|.
name|append
argument_list|(
name|DELIMITER
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|Keys
operator|.
name|TIME
operator|.
name|name
argument_list|()
operator|+
literal|"=\""
operator|+
name|System
operator|.
name|currentTimeMillis
argument_list|()
operator|+
literal|"\""
argument_list|)
expr_stmt|;
name|histStream
operator|.
name|println
argument_list|(
name|sb
argument_list|)
expr_stmt|;
name|histStream
operator|.
name|flush
argument_list|()
expr_stmt|;
block|}
comment|/**    * Called at the start of job Driver.run().    */
specifier|public
name|void
name|startQuery
parameter_list|(
name|String
name|cmd
parameter_list|,
name|String
name|id
parameter_list|)
block|{
name|SessionState
name|ss
init|=
name|SessionState
operator|.
name|get
argument_list|()
decl_stmt|;
if|if
condition|(
name|ss
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|QueryInfo
name|ji
init|=
operator|new
name|QueryInfo
argument_list|()
decl_stmt|;
name|ji
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|QUERY_ID
operator|.
name|name
argument_list|()
argument_list|,
name|id
argument_list|)
expr_stmt|;
name|ji
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|QUERY_STRING
operator|.
name|name
argument_list|()
argument_list|,
name|cmd
argument_list|)
expr_stmt|;
name|queryInfoMap
operator|.
name|put
argument_list|(
name|id
argument_list|,
name|ji
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|RecordTypes
operator|.
name|QueryStart
argument_list|,
name|ji
operator|.
name|hm
argument_list|)
expr_stmt|;
block|}
comment|/**    * Used to set job status and other attributes of a job.    *    * @param queryId    * @param propName    * @param propValue    */
specifier|public
name|void
name|setQueryProperty
parameter_list|(
name|String
name|queryId
parameter_list|,
name|Keys
name|propName
parameter_list|,
name|String
name|propValue
parameter_list|)
block|{
name|QueryInfo
name|ji
init|=
name|queryInfoMap
operator|.
name|get
argument_list|(
name|queryId
argument_list|)
decl_stmt|;
if|if
condition|(
name|ji
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|ji
operator|.
name|hm
operator|.
name|put
argument_list|(
name|propName
operator|.
name|name
argument_list|()
argument_list|,
name|propValue
argument_list|)
expr_stmt|;
block|}
comment|/**    * Used to set task properties.    *    * @param taskId    * @param propName    * @param propValue    */
specifier|public
name|void
name|setTaskProperty
parameter_list|(
name|String
name|queryId
parameter_list|,
name|String
name|taskId
parameter_list|,
name|Keys
name|propName
parameter_list|,
name|String
name|propValue
parameter_list|)
block|{
name|String
name|id
init|=
name|queryId
operator|+
literal|":"
operator|+
name|taskId
decl_stmt|;
name|TaskInfo
name|ti
init|=
name|taskInfoMap
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|ti
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|ti
operator|.
name|hm
operator|.
name|put
argument_list|(
name|propName
operator|.
name|name
argument_list|()
argument_list|,
name|propValue
argument_list|)
expr_stmt|;
block|}
comment|/**    * Serialize the task counters and set as a task property.    *    * @param taskId    * @param rj    */
specifier|public
name|void
name|setTaskCounters
parameter_list|(
name|String
name|queryId
parameter_list|,
name|String
name|taskId
parameter_list|,
name|Counters
name|ctrs
parameter_list|)
block|{
name|String
name|id
init|=
name|queryId
operator|+
literal|":"
operator|+
name|taskId
decl_stmt|;
name|QueryInfo
name|ji
init|=
name|queryInfoMap
operator|.
name|get
argument_list|(
name|queryId
argument_list|)
decl_stmt|;
name|StringBuilder
name|sb1
init|=
operator|new
name|StringBuilder
argument_list|(
literal|""
argument_list|)
decl_stmt|;
name|TaskInfo
name|ti
init|=
name|taskInfoMap
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
operator|(
name|ti
operator|==
literal|null
operator|)
operator|||
operator|(
name|ctrs
operator|==
literal|null
operator|)
condition|)
block|{
return|return;
block|}
name|StringBuilder
name|sb
init|=
operator|new
name|StringBuilder
argument_list|(
literal|""
argument_list|)
decl_stmt|;
try|try
block|{
name|boolean
name|first
init|=
literal|true
decl_stmt|;
for|for
control|(
name|Group
name|group
range|:
name|ctrs
control|)
block|{
for|for
control|(
name|Counter
name|counter
range|:
name|group
control|)
block|{
if|if
condition|(
name|first
condition|)
block|{
name|first
operator|=
literal|false
expr_stmt|;
block|}
else|else
block|{
name|sb
operator|.
name|append
argument_list|(
literal|','
argument_list|)
expr_stmt|;
block|}
name|sb
operator|.
name|append
argument_list|(
name|group
operator|.
name|getDisplayName
argument_list|()
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|'.'
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|counter
operator|.
name|getDisplayName
argument_list|()
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
literal|':'
argument_list|)
expr_stmt|;
name|sb
operator|.
name|append
argument_list|(
name|counter
operator|.
name|getCounter
argument_list|()
argument_list|)
expr_stmt|;
name|String
name|tab
init|=
name|getRowCountTableName
argument_list|(
name|counter
operator|.
name|getDisplayName
argument_list|()
argument_list|)
decl_stmt|;
if|if
condition|(
name|tab
operator|!=
literal|null
condition|)
block|{
if|if
condition|(
name|sb1
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|sb1
operator|.
name|append
argument_list|(
literal|","
argument_list|)
expr_stmt|;
block|}
name|sb1
operator|.
name|append
argument_list|(
name|tab
argument_list|)
expr_stmt|;
name|sb1
operator|.
name|append
argument_list|(
literal|'~'
argument_list|)
expr_stmt|;
name|sb1
operator|.
name|append
argument_list|(
name|counter
operator|.
name|getCounter
argument_list|()
argument_list|)
expr_stmt|;
name|ji
operator|.
name|rowCountMap
operator|.
name|put
argument_list|(
name|tab
argument_list|,
name|counter
operator|.
name|getCounter
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|warn
argument_list|(
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sb1
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|taskInfoMap
operator|.
name|get
argument_list|(
name|id
argument_list|)
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|ROWS_INSERTED
operator|.
name|name
argument_list|()
argument_list|,
name|sb1
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|queryInfoMap
operator|.
name|get
argument_list|(
name|queryId
argument_list|)
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|ROWS_INSERTED
operator|.
name|name
argument_list|()
argument_list|,
name|sb1
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|sb
operator|.
name|length
argument_list|()
operator|>
literal|0
condition|)
block|{
name|taskInfoMap
operator|.
name|get
argument_list|(
name|id
argument_list|)
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|TASK_COUNTERS
operator|.
name|name
argument_list|()
argument_list|,
name|sb
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|printRowCount
parameter_list|(
name|String
name|queryId
parameter_list|)
block|{
name|QueryInfo
name|ji
init|=
name|queryInfoMap
operator|.
name|get
argument_list|(
name|queryId
argument_list|)
decl_stmt|;
for|for
control|(
name|String
name|tab
range|:
name|ji
operator|.
name|rowCountMap
operator|.
name|keySet
argument_list|()
control|)
block|{
name|console
operator|.
name|printInfo
argument_list|(
name|ji
operator|.
name|rowCountMap
operator|.
name|get
argument_list|(
name|tab
argument_list|)
operator|+
literal|" Rows loaded to "
operator|+
name|tab
argument_list|)
expr_stmt|;
block|}
block|}
comment|/**    * Called at the end of Job. A Job is sql query.    *    * @param queryId    */
specifier|public
name|void
name|endQuery
parameter_list|(
name|String
name|queryId
parameter_list|)
block|{
name|QueryInfo
name|ji
init|=
name|queryInfoMap
operator|.
name|get
argument_list|(
name|queryId
argument_list|)
decl_stmt|;
if|if
condition|(
name|ji
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|log
argument_list|(
name|RecordTypes
operator|.
name|QueryEnd
argument_list|,
name|ji
operator|.
name|hm
argument_list|)
expr_stmt|;
block|}
comment|/**    * Called at the start of a task. Called by Driver.run() A Job can have    * multiple tasks. Tasks will have multiple operator.    *    * @param task    */
specifier|public
name|void
name|startTask
parameter_list|(
name|String
name|queryId
parameter_list|,
name|Task
argument_list|<
name|?
extends|extends
name|Serializable
argument_list|>
name|task
parameter_list|,
name|String
name|taskName
parameter_list|)
block|{
name|SessionState
name|ss
init|=
name|SessionState
operator|.
name|get
argument_list|()
decl_stmt|;
if|if
condition|(
name|ss
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|TaskInfo
name|ti
init|=
operator|new
name|TaskInfo
argument_list|()
decl_stmt|;
name|ti
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|QUERY_ID
operator|.
name|name
argument_list|()
argument_list|,
name|ss
operator|.
name|getQueryId
argument_list|()
argument_list|)
expr_stmt|;
name|ti
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|TASK_ID
operator|.
name|name
argument_list|()
argument_list|,
name|task
operator|.
name|getId
argument_list|()
argument_list|)
expr_stmt|;
name|ti
operator|.
name|hm
operator|.
name|put
argument_list|(
name|Keys
operator|.
name|TASK_NAME
operator|.
name|name
argument_list|()
argument_list|,
name|taskName
argument_list|)
expr_stmt|;
name|String
name|id
init|=
name|queryId
operator|+
literal|":"
operator|+
name|task
operator|.
name|getId
argument_list|()
decl_stmt|;
name|taskInfoMap
operator|.
name|put
argument_list|(
name|id
argument_list|,
name|ti
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|RecordTypes
operator|.
name|TaskStart
argument_list|,
name|ti
operator|.
name|hm
argument_list|)
expr_stmt|;
block|}
comment|/**    * Called at the end of a task.    *    * @param task    */
specifier|public
name|void
name|endTask
parameter_list|(
name|String
name|queryId
parameter_list|,
name|Task
argument_list|<
name|?
extends|extends
name|Serializable
argument_list|>
name|task
parameter_list|)
block|{
name|String
name|id
init|=
name|queryId
operator|+
literal|":"
operator|+
name|task
operator|.
name|getId
argument_list|()
decl_stmt|;
name|TaskInfo
name|ti
init|=
name|taskInfoMap
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|ti
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|log
argument_list|(
name|RecordTypes
operator|.
name|TaskEnd
argument_list|,
name|ti
operator|.
name|hm
argument_list|)
expr_stmt|;
block|}
comment|/**    * Called at the end of a task.    *    * @param task    */
specifier|public
name|void
name|progressTask
parameter_list|(
name|String
name|queryId
parameter_list|,
name|Task
argument_list|<
name|?
extends|extends
name|Serializable
argument_list|>
name|task
parameter_list|)
block|{
name|String
name|id
init|=
name|queryId
operator|+
literal|":"
operator|+
name|task
operator|.
name|getId
argument_list|()
decl_stmt|;
name|TaskInfo
name|ti
init|=
name|taskInfoMap
operator|.
name|get
argument_list|(
name|id
argument_list|)
decl_stmt|;
if|if
condition|(
name|ti
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|log
argument_list|(
name|RecordTypes
operator|.
name|TaskProgress
argument_list|,
name|ti
operator|.
name|hm
argument_list|)
expr_stmt|;
block|}
comment|/**    * write out counters.    */
specifier|static
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|ctrmap
init|=
literal|null
decl_stmt|;
specifier|public
name|void
name|logPlanProgress
parameter_list|(
name|QueryPlan
name|plan
parameter_list|)
throws|throws
name|IOException
block|{
if|if
condition|(
name|ctrmap
operator|==
literal|null
condition|)
block|{
name|ctrmap
operator|=
operator|new
name|HashMap
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
argument_list|()
expr_stmt|;
block|}
name|ctrmap
operator|.
name|put
argument_list|(
literal|"plan"
argument_list|,
name|plan
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|log
argument_list|(
name|RecordTypes
operator|.
name|Counters
argument_list|,
name|ctrmap
argument_list|)
expr_stmt|;
block|}
comment|/**    * Set the table to id map.    *    * @param map    */
specifier|public
name|void
name|setIdToTableMap
parameter_list|(
name|Map
argument_list|<
name|String
argument_list|,
name|String
argument_list|>
name|map
parameter_list|)
block|{
name|idToTableMap
operator|=
name|map
expr_stmt|;
block|}
comment|/**    * Returns table name for the counter name.    *    * @param name    * @return tableName    */
name|String
name|getRowCountTableName
parameter_list|(
name|String
name|name
parameter_list|)
block|{
if|if
condition|(
name|idToTableMap
operator|==
literal|null
condition|)
block|{
return|return
literal|null
return|;
block|}
name|Matcher
name|m
init|=
name|rowCountPattern
operator|.
name|matcher
argument_list|(
name|name
argument_list|)
decl_stmt|;
if|if
condition|(
name|m
operator|.
name|find
argument_list|()
condition|)
block|{
name|String
name|tuple
init|=
name|m
operator|.
name|group
argument_list|(
literal|1
argument_list|)
decl_stmt|;
return|return
name|idToTableMap
operator|.
name|get
argument_list|(
name|tuple
argument_list|)
return|;
block|}
return|return
literal|null
return|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|finalize
parameter_list|()
throws|throws
name|Throwable
block|{
if|if
condition|(
name|histStream
operator|!=
literal|null
condition|)
block|{
name|histStream
operator|.
name|close
argument_list|()
expr_stmt|;
block|}
name|super
operator|.
name|finalize
argument_list|()
expr_stmt|;
block|}
block|}
end_class

end_unit

