begin_unit|revision:0.9.5;language:Java;cregit-version:0.0.1
begin_comment
comment|/**  * Licensed to the Apache Software Foundation (ASF) under one  * or more contributor license agreements.  See the NOTICE file  * distributed with this work for additional information  * regarding copyright ownership.  The ASF licenses this file  * to you under the Apache License, Version 2.0 (the  * "License"); you may not use this file except in compliance  * with the License.  You may obtain a copy of the License at  *  *     http://www.apache.org/licenses/LICENSE-2.0  *  * Unless required by applicable law or agreed to in writing, software  * distributed under the License is distributed on an "AS IS" BASIS,  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  * See the License for the specific language governing permissions and  * limitations under the License.  */
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|hooks
package|;
end_package

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|List
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ExecutorService
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|Executors
import|;
end_import

begin_import
import|import
name|java
operator|.
name|util
operator|.
name|concurrent
operator|.
name|TimeUnit
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|Log
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|commons
operator|.
name|logging
operator|.
name|LogFactory
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|conf
operator|.
name|Configuration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|conf
operator|.
name|HiveConf
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|QueryPlan
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|ExplainTask
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|Task
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|hive
operator|.
name|ql
operator|.
name|exec
operator|.
name|Utilities
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|util
operator|.
name|StringUtils
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineEntity
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|api
operator|.
name|records
operator|.
name|timeline
operator|.
name|TimelineEvent
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|client
operator|.
name|api
operator|.
name|TimelineClient
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|hadoop
operator|.
name|yarn
operator|.
name|conf
operator|.
name|YarnConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|json
operator|.
name|JSONObject
import|;
end_import

begin_import
import|import
name|com
operator|.
name|google
operator|.
name|common
operator|.
name|util
operator|.
name|concurrent
operator|.
name|ThreadFactoryBuilder
import|;
end_import

begin_comment
comment|/**  * ATSHook sends query + plan info to Yarn App Timeline Server. To enable (hadoop 2.4 and up) set  * hive.exec.pre.hooks/hive.exec.post.hooks/hive.exec.failure.hooks to include this class.  */
end_comment

begin_class
specifier|public
class|class
name|ATSHook
implements|implements
name|ExecuteWithHookContext
block|{
specifier|private
specifier|static
specifier|final
name|Log
name|LOG
init|=
name|LogFactory
operator|.
name|getLog
argument_list|(
name|ATSHook
operator|.
name|class
operator|.
name|getName
argument_list|()
argument_list|)
decl_stmt|;
specifier|private
specifier|static
specifier|final
name|Object
name|LOCK
init|=
operator|new
name|Object
argument_list|()
decl_stmt|;
specifier|private
specifier|static
name|ExecutorService
name|executor
decl_stmt|;
specifier|private
specifier|static
name|TimelineClient
name|timelineClient
decl_stmt|;
specifier|private
enum|enum
name|EntityTypes
block|{
name|HIVE_QUERY_ID
block|}
empty_stmt|;
specifier|private
enum|enum
name|EventTypes
block|{
name|QUERY_SUBMITTED
block|,
name|QUERY_COMPLETED
block|}
empty_stmt|;
specifier|private
enum|enum
name|OtherInfoTypes
block|{
name|QUERY
block|,
name|STATUS
block|,
name|TEZ
block|,
name|MAPRED
block|}
empty_stmt|;
specifier|private
enum|enum
name|PrimaryFilterTypes
block|{
name|user
block|,
name|operationid
block|}
empty_stmt|;
specifier|private
specifier|static
specifier|final
name|int
name|WAIT_TIME
init|=
literal|3
decl_stmt|;
specifier|public
name|ATSHook
parameter_list|()
block|{
synchronized|synchronized
init|(
name|LOCK
init|)
block|{
if|if
condition|(
name|executor
operator|==
literal|null
condition|)
block|{
name|executor
operator|=
name|Executors
operator|.
name|newSingleThreadExecutor
argument_list|(
operator|new
name|ThreadFactoryBuilder
argument_list|()
operator|.
name|setDaemon
argument_list|(
literal|true
argument_list|)
operator|.
name|setNameFormat
argument_list|(
literal|"ATS Logger %d"
argument_list|)
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
name|YarnConfiguration
name|yarnConf
init|=
operator|new
name|YarnConfiguration
argument_list|()
decl_stmt|;
name|timelineClient
operator|=
name|TimelineClient
operator|.
name|createTimelineClient
argument_list|()
expr_stmt|;
name|timelineClient
operator|.
name|init
argument_list|(
name|yarnConf
argument_list|)
expr_stmt|;
name|timelineClient
operator|.
name|start
argument_list|()
expr_stmt|;
name|Runtime
operator|.
name|getRuntime
argument_list|()
operator|.
name|addShutdownHook
argument_list|(
operator|new
name|Thread
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|executor
operator|.
name|shutdown
argument_list|()
expr_stmt|;
name|executor
operator|.
name|awaitTermination
argument_list|(
name|WAIT_TIME
argument_list|,
name|TimeUnit
operator|.
name|SECONDS
argument_list|)
expr_stmt|;
name|executor
operator|=
literal|null
expr_stmt|;
block|}
catch|catch
parameter_list|(
name|InterruptedException
name|ie
parameter_list|)
block|{
comment|/* ignore */
block|}
name|timelineClient
operator|.
name|stop
argument_list|()
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
block|}
name|LOG
operator|.
name|info
argument_list|(
literal|"Created ATS Hook"
argument_list|)
expr_stmt|;
block|}
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|(
specifier|final
name|HookContext
name|hookContext
parameter_list|)
throws|throws
name|Exception
block|{
specifier|final
name|long
name|currentTime
init|=
name|System
operator|.
name|currentTimeMillis
argument_list|()
decl_stmt|;
specifier|final
name|HiveConf
name|conf
init|=
operator|new
name|HiveConf
argument_list|(
name|hookContext
operator|.
name|getConf
argument_list|()
argument_list|)
decl_stmt|;
name|executor
operator|.
name|submit
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|void
name|run
parameter_list|()
block|{
try|try
block|{
name|QueryPlan
name|plan
init|=
name|hookContext
operator|.
name|getQueryPlan
argument_list|()
decl_stmt|;
if|if
condition|(
name|plan
operator|==
literal|null
condition|)
block|{
return|return;
block|}
name|String
name|queryId
init|=
name|plan
operator|.
name|getQueryId
argument_list|()
decl_stmt|;
name|String
name|opId
init|=
name|hookContext
operator|.
name|getOperationId
argument_list|()
decl_stmt|;
name|long
name|queryStartTime
init|=
name|plan
operator|.
name|getQueryStartTime
argument_list|()
decl_stmt|;
name|String
name|user
init|=
name|hookContext
operator|.
name|getUgi
argument_list|()
operator|.
name|getUserName
argument_list|()
decl_stmt|;
name|int
name|numMrJobs
init|=
name|Utilities
operator|.
name|getMRTasks
argument_list|(
name|plan
operator|.
name|getRootTasks
argument_list|()
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
name|int
name|numTezJobs
init|=
name|Utilities
operator|.
name|getTezTasks
argument_list|(
name|plan
operator|.
name|getRootTasks
argument_list|()
argument_list|)
operator|.
name|size
argument_list|()
decl_stmt|;
if|if
condition|(
name|numMrJobs
operator|+
name|numTezJobs
operator|<=
literal|0
condition|)
block|{
return|return;
comment|// ignore client only queries
block|}
switch|switch
condition|(
name|hookContext
operator|.
name|getHookType
argument_list|()
condition|)
block|{
case|case
name|PRE_EXEC_HOOK
case|:
name|ExplainTask
name|explain
init|=
operator|new
name|ExplainTask
argument_list|()
decl_stmt|;
name|explain
operator|.
name|initialize
argument_list|(
name|conf
argument_list|,
name|plan
argument_list|,
literal|null
argument_list|)
expr_stmt|;
name|String
name|query
init|=
name|plan
operator|.
name|getQueryStr
argument_list|()
decl_stmt|;
name|List
argument_list|<
name|Task
argument_list|<
name|?
argument_list|>
argument_list|>
name|rootTasks
init|=
name|plan
operator|.
name|getRootTasks
argument_list|()
decl_stmt|;
name|JSONObject
name|explainPlan
init|=
name|explain
operator|.
name|getJSONPlan
argument_list|(
literal|null
argument_list|,
literal|null
argument_list|,
name|rootTasks
argument_list|,
name|plan
operator|.
name|getFetchTask
argument_list|()
argument_list|,
literal|true
argument_list|,
literal|false
argument_list|,
literal|false
argument_list|)
decl_stmt|;
name|fireAndForget
argument_list|(
name|conf
argument_list|,
name|createPreHookEvent
argument_list|(
name|queryId
argument_list|,
name|query
argument_list|,
name|explainPlan
argument_list|,
name|queryStartTime
argument_list|,
name|user
argument_list|,
name|numMrJobs
argument_list|,
name|numTezJobs
argument_list|,
name|opId
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|POST_EXEC_HOOK
case|:
name|fireAndForget
argument_list|(
name|conf
argument_list|,
name|createPostHookEvent
argument_list|(
name|queryId
argument_list|,
name|currentTime
argument_list|,
name|user
argument_list|,
literal|true
argument_list|,
name|opId
argument_list|)
argument_list|)
expr_stmt|;
break|break;
case|case
name|ON_FAILURE_HOOK
case|:
name|fireAndForget
argument_list|(
name|conf
argument_list|,
name|createPostHookEvent
argument_list|(
name|queryId
argument_list|,
name|currentTime
argument_list|,
name|user
argument_list|,
literal|false
argument_list|,
name|opId
argument_list|)
argument_list|)
expr_stmt|;
break|break;
default|default:
comment|//ignore
break|break;
block|}
block|}
catch|catch
parameter_list|(
name|Exception
name|e
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Failed to submit plan to ATS: "
operator|+
name|StringUtils
operator|.
name|stringifyException
argument_list|(
name|e
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
block|}
argument_list|)
expr_stmt|;
block|}
name|TimelineEntity
name|createPreHookEvent
parameter_list|(
name|String
name|queryId
parameter_list|,
name|String
name|query
parameter_list|,
name|JSONObject
name|explainPlan
parameter_list|,
name|long
name|startTime
parameter_list|,
name|String
name|user
parameter_list|,
name|int
name|numMrJobs
parameter_list|,
name|int
name|numTezJobs
parameter_list|,
name|String
name|opId
parameter_list|)
throws|throws
name|Exception
block|{
name|JSONObject
name|queryObj
init|=
operator|new
name|JSONObject
argument_list|()
decl_stmt|;
name|queryObj
operator|.
name|put
argument_list|(
literal|"queryText"
argument_list|,
name|query
argument_list|)
expr_stmt|;
name|queryObj
operator|.
name|put
argument_list|(
literal|"queryPlan"
argument_list|,
name|explainPlan
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|info
argument_list|(
literal|"Received pre-hook notification for :"
operator|+
name|queryId
argument_list|)
expr_stmt|;
if|if
condition|(
name|LOG
operator|.
name|isDebugEnabled
argument_list|()
condition|)
block|{
name|LOG
operator|.
name|debug
argument_list|(
literal|"Otherinfo: "
operator|+
name|queryObj
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|LOG
operator|.
name|debug
argument_list|(
literal|"Operation id:<"
operator|+
name|opId
operator|+
literal|">"
argument_list|)
expr_stmt|;
block|}
name|TimelineEntity
name|atsEntity
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|atsEntity
operator|.
name|setEntityId
argument_list|(
name|queryId
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|setEntityType
argument_list|(
name|EntityTypes
operator|.
name|HIVE_QUERY_ID
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addPrimaryFilter
argument_list|(
name|PrimaryFilterTypes
operator|.
name|user
operator|.
name|name
argument_list|()
argument_list|,
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|opId
operator|!=
literal|null
condition|)
block|{
name|atsEntity
operator|.
name|addPrimaryFilter
argument_list|(
name|PrimaryFilterTypes
operator|.
name|operationid
operator|.
name|name
argument_list|()
argument_list|,
name|opId
argument_list|)
expr_stmt|;
block|}
name|TimelineEvent
name|startEvt
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|startEvt
operator|.
name|setEventType
argument_list|(
name|EventTypes
operator|.
name|QUERY_SUBMITTED
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|startEvt
operator|.
name|setTimestamp
argument_list|(
name|startTime
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addEvent
argument_list|(
name|startEvt
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addOtherInfo
argument_list|(
name|OtherInfoTypes
operator|.
name|QUERY
operator|.
name|name
argument_list|()
argument_list|,
name|queryObj
operator|.
name|toString
argument_list|()
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addOtherInfo
argument_list|(
name|OtherInfoTypes
operator|.
name|TEZ
operator|.
name|name
argument_list|()
argument_list|,
name|numTezJobs
operator|>
literal|0
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addOtherInfo
argument_list|(
name|OtherInfoTypes
operator|.
name|MAPRED
operator|.
name|name
argument_list|()
argument_list|,
name|numMrJobs
operator|>
literal|0
argument_list|)
expr_stmt|;
return|return
name|atsEntity
return|;
block|}
name|TimelineEntity
name|createPostHookEvent
parameter_list|(
name|String
name|queryId
parameter_list|,
name|long
name|stopTime
parameter_list|,
name|String
name|user
parameter_list|,
name|boolean
name|success
parameter_list|,
name|String
name|opId
parameter_list|)
block|{
name|LOG
operator|.
name|info
argument_list|(
literal|"Received post-hook notification for :"
operator|+
name|queryId
argument_list|)
expr_stmt|;
name|TimelineEntity
name|atsEntity
init|=
operator|new
name|TimelineEntity
argument_list|()
decl_stmt|;
name|atsEntity
operator|.
name|setEntityId
argument_list|(
name|queryId
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|setEntityType
argument_list|(
name|EntityTypes
operator|.
name|HIVE_QUERY_ID
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addPrimaryFilter
argument_list|(
name|PrimaryFilterTypes
operator|.
name|user
operator|.
name|name
argument_list|()
argument_list|,
name|user
argument_list|)
expr_stmt|;
if|if
condition|(
name|opId
operator|!=
literal|null
condition|)
block|{
name|atsEntity
operator|.
name|addPrimaryFilter
argument_list|(
name|PrimaryFilterTypes
operator|.
name|operationid
operator|.
name|name
argument_list|()
argument_list|,
name|opId
argument_list|)
expr_stmt|;
block|}
name|TimelineEvent
name|stopEvt
init|=
operator|new
name|TimelineEvent
argument_list|()
decl_stmt|;
name|stopEvt
operator|.
name|setEventType
argument_list|(
name|EventTypes
operator|.
name|QUERY_COMPLETED
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
name|stopEvt
operator|.
name|setTimestamp
argument_list|(
name|stopTime
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addEvent
argument_list|(
name|stopEvt
argument_list|)
expr_stmt|;
name|atsEntity
operator|.
name|addOtherInfo
argument_list|(
name|OtherInfoTypes
operator|.
name|STATUS
operator|.
name|name
argument_list|()
argument_list|,
name|success
argument_list|)
expr_stmt|;
return|return
name|atsEntity
return|;
block|}
specifier|synchronized
name|void
name|fireAndForget
parameter_list|(
name|Configuration
name|conf
parameter_list|,
name|TimelineEntity
name|entity
parameter_list|)
throws|throws
name|Exception
block|{
name|timelineClient
operator|.
name|putEntities
argument_list|(
name|entity
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

